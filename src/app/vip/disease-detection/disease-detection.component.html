<app-top-navigator></app-top-navigator>

<div class="disease-detection-page">
  <div class="container">
    <div class="page-header">
      <h1>
        <i class="fas fa-microscope"></i>
        AI Phát hiện bệnh cây
      </h1>
      <p class="description">
        Công nghệ AI tiên tiến giúp phát hiện và chẩn đoán bệnh cây cảnh chính xác, đưa ra hướng dẫn điều trị phù hợp.
      </p>
    </div>

    <div class="tab-navigation">
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'upload'"
        (click)="setActiveTab('upload')">
        <i class="fas fa-cloud-upload-alt"></i>
        Tải ảnh lên
      </button>
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'symptoms'"
        (click)="setActiveTab('symptoms')">
        <i class="fas fa-clipboard-list"></i>
        Nhập triệu chứng
      </button>
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'history'"
        (click)="setActiveTab('history')">
        <i class="fas fa-history"></i>
        Lịch sử phát hiện
      </button>
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'diseases'"
        (click)="setActiveTab('diseases')">
        <i class="fas fa-book-medical"></i>
        Thư viện bệnh
      </button>
    </div>

    <!-- Upload Image Tab -->
    <div class="tab-content" *ngIf="activeTab === 'upload'">
      <div class="panel">
        <h2>Phát hiện bệnh qua hình ảnh</h2>
        <p>Tải lên hình ảnh cây của bạn để AI phân tích và phát hiện bệnh</p>

        <form [formGroup]="imageForm" (ngSubmit)="uploadImage()" class="upload-form">
          <!-- Đã bỏ trường nhập mã cây, chỉ còn upload ảnh -->

          <div class="image-upload-container">
            <div class="image-preview" *ngIf="imagePreviewUrl">
              <img [src]="imagePreviewUrl" alt="Image Preview">
            </div>
            <div class="image-upload-box" *ngIf="!imagePreviewUrl">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Kéo ảnh vào đây hoặc nhấn để chọn file</p>
              <small>JPG, PNG, WebP (tối đa 20MB)</small>
            </div>
            <input 
              type="file" 
              id="fileUpload" 
              accept="image/*"
              (change)="onFileSelected($event)"
              class="file-input"
              [attr.max-size]="20971520">
          </div>

          <div class="form-actions">
            <button 
              type="button" 
              class="btn-secondary" 
              *ngIf="imagePreviewUrl"
              (click)="clearImage()">
              <i class="fas fa-times"></i>
              Xóa ảnh
            </button>
            <button s
              type="submit" 
              class="btn-primary" 
              [disabled]="imageForm.invalid || !selectedFile || isImageUploading">
              <i class="fas fa-search" *ngIf="!isImageUploading"></i>
              <i class="fas fa-spinner fa-spin" *ngIf="isImageUploading"></i>
              Phân tích ảnh
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Symptoms Tab -->
    <div class="tab-content" *ngIf="activeTab === 'symptoms'">
      <div class="panel">
        <h2>Phát hiện bệnh qua triệu chứng</h2>
        <p>Mô tả các triệu chứng của cây để AI phân tích và chẩn đoán</p>
        <form [formGroup]="symptomForm" (ngSubmit)="submitSymptoms()" class="symptom-form">
          <div class="form-group">
            <label for="symptomDescription">Mô tả triệu chứng:</label>
            <textarea 
              id="symptomDescription" 
              formControlName="description"
              placeholder="Mô tả chi tiết về tình trạng của cây..."
              rows="5" 
              class="form-control"></textarea>
            <div class="form-error" *ngIf="symptomForm.get('description')?.invalid && symptomForm.get('description')?.touched">
              Vui lòng nhập mô tả ít nhất 10 ký tự
            </div>
          </div>
          <div class="form-actions">
            <button 
              type="submit" 
              class="btn-primary" 
              [disabled]="symptomForm.get('description')?.invalid || isSymptomAnalyzing">
              <i class="fas fa-search" *ngIf="!isSymptomAnalyzing"></i>
              <i class="fas fa-spinner fa-spin" *ngIf="isSymptomAnalyzing"></i>
              Phân tích triệu chứng
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Detection Result -->
    <div class="result-container" *ngIf="detectionResult && (activeTab === 'upload' || activeTab === 'symptoms')">
      <div class="result-panel" id="detection-result-panel">
<style>
  .highlight-result {
    box-shadow: 0 0 0 4px #4caf50;
    animation: highlightFade 2s;
  }
  @keyframes highlightFade {
    0% { box-shadow: 0 0 0 8px #4caf50; }
    100% { box-shadow: 0 0 0 0 #4caf50; }
  }
</style>
        <div class="result-header">
          <h2>Kết quả phân tích</h2>
                      <div class="result-header-actions">
              <span class="confidence-badge">
                Độ tin cậy: {{ (detectionResult.confidenceScore * 100) | number:'1.0-1' }}%
              </span>
              
              <button 
                class="btn-clear-result" 
                (click)="clearDetectionResult()"
                title="Xóa kết quả">
                <i class="fas fa-times"></i>
              </button>
            </div>
        </div>

        <div class="result-content">
          <div class="result-main">
            <h3>{{ detectionResult.detectedDisease }}</h3>
            <div class="severity-badge" [ngClass]="getSeverityClass(detectionResult.severity)">
              Mức độ nghiêm trọng: {{ formatSeverity(detectionResult.severity) }}
            </div>
            
            <p class="disease-description">
              {{ detectionResult.description }}
            </p>

                         <div class="recommendations">
               <h4>Khuyến nghị điều trị:</h4>
               <ul *ngIf="detectionResult.recommendations && detectionResult.recommendations.length > 0">
                 <li *ngFor="let rec of detectionResult.recommendations; trackBy: trackByRecommendation">
                   {{ rec }}
                 </li>
               </ul>
             </div>
          </div>


          <div class="result-actions">
            <button class="btn-action btn-secondary" (click)="getTreatmentGuide(detectionResult.detectedDisease)" [disabled]="!detectionResult.detectedDisease">
              <i class="fas fa-book-medical"></i>
              Hướng dẫn điều trị chi tiết
            </button>
          </div>

          <!-- Inline Treatment Guide Section -->
          <div class="treatment-guide-section" *ngIf="treatmentGuide">
            <div class="treatment-guide-header">
              <h3>Hướng dẫn điều trị chi tiết: {{ treatmentGuide.diseaseName }}</h3>
            </div>
            
            <div class="treatment-overview">
              <div class="overview-item">
                <strong>Mức độ nghiêm trọng:</strong>
                <span class="severity-badge" [ngClass]="getSeverityClass(treatmentGuide.severity)">
                  {{ formatSeverity(treatmentGuide.severity) }}
                </span>
              </div>
              <div class="overview-item">
                <strong>Thời gian điều trị:</strong>
                <span>{{ treatmentGuide.estimatedDuration }}</span>
              </div>
              <div class="overview-item">
                <strong>Tỷ lệ thành công:</strong>
                <span>{{ treatmentGuide.successRate }}</span>
              </div>
              <div class="overview-item">
                <strong>Lịch theo dõi:</strong>
                <span>{{ treatmentGuide.followUpSchedule }}</span>
              </div>
            </div>

            <div class="treatment-steps">
              <h4>Các bước điều trị:</h4>
              <div *ngIf="treatmentGuide.steps && treatmentGuide.steps.length > 0; else noSteps">
                <div class="step-list">
                  <div class="step-item" *ngFor="let step of treatmentGuide.steps; trackBy: trackById">
                    <div class="step-header">
                      <span class="step-number">{{ step.stepNumber }}</span>
                      <h5>{{ step.title }}</h5>
                      <span class="step-duration">{{ step.duration }}</span>
                    </div>
                    <p class="step-description">{{ step.description }}</p>
                    <div class="step-details">
                      <div class="step-frequency">
                        <strong>Tần suất:</strong> {{ step.frequency }}
                      </div>
                      <div class="step-materials" *ngIf="step.materials && step.materials.length > 0">
                        <strong>Vật liệu cần thiết:</strong>
                        <ul>
                          <li *ngFor="let material of step.materials">{{ material }}</li>
                        </ul>
                      </div>
                      <div class="step-notes" *ngIf="step.notes">
                        <strong>Ghi chú:</strong> {{ step.notes }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <ng-template #noSteps>
                <div class="no-steps-message">
                  <i class="fas fa-info-circle"></i>
                  Bệnh này chưa có các bước điều trị cụ thể. Vui lòng tham khảo chuyên gia hoặc các lưu ý bên dưới.
                </div>
              </ng-template>
            </div>

            <div class="treatment-requirements" *ngIf="treatmentGuide.requiredProducts && treatmentGuide.requiredProducts.length > 0">
              <h4>Vật liệu cần thiết:</h4>
              <div class="materials-list">
                <span class="material-tag" *ngFor="let product of treatmentGuide.requiredProducts">{{ product }}</span>
              </div>
            </div>

            <div class="treatment-precautions" *ngIf="treatmentGuide.precautions && treatmentGuide.precautions.length > 0">
              <h4>Lưu ý quan trọng:</h4>
              <ul>
                <li *ngFor="let precaution of treatmentGuide.precautions">{{ precaution }}</li>
              </ul>
            </div>

            <div class="expert-notes" *ngIf="treatmentGuide.expertNotes">
          <!-- Không hiện popup lỗi nếu có dữ liệu hướng dẫn -->
              <h4>Ghi chú từ chuyên gia:</h4>
              <p>{{ treatmentGuide.expertNotes }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div class="tab-content" *ngIf="activeTab === 'history'">
      <div class="panel">
        <h2>Lịch sử phát hiện bệnh</h2>

        <div class="loading-state" *ngIf="isHistoryLoading">
          <div class="spinner"></div>
          <p>Đang tải lịch sử...</p>
        </div>

        <div class="error-state" *ngIf="historyError && !isHistoryLoading">
          <i class="fas fa-exclamation-triangle"></i>
          <p>{{ historyError }}</p>
          <button class="btn-retry" (click)="loadDetectionHistory()">
            <i class="fas fa-redo"></i>
            Thử lại
          </button>
        </div>

        <div class="empty-state" *ngIf="!isHistoryLoading && !historyError && detectionHistory.length === 0">
          <i class="fas fa-search"></i>
          <p>Bạn chưa có lịch sử phát hiện bệnh nào.</p>
          <button class="btn-primary" (click)="setActiveTab('upload')">
            Bắt đầu phát hiện
          </button>
        </div>

        <div class="history-list" *ngIf="!isHistoryLoading && !historyError && detectionHistory.length > 0">
          <div 
            class="history-row improved"
            *ngFor="let item of detectionHistory; trackBy: trackById">
            <span class="row-icon" [ngClass]="getSeverityClass(item.severity)"><i class="fas fa-virus"></i></span>
            <div class="row-content">
              <div class="row-header" style="display: flex; align-items: center; gap: 12px; font-size: 1.08rem; font-family: 'Segoe UI', Arial, sans-serif; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <span class="row-disease" style="font-weight: 600;">{{ item.detectedDisease }}</span>
                  <span class="row-confidence" style="background: #e0f2fe; color: #2563eb; border-radius: 6px; padding: 2px 10px; font-size: 0.98rem; font-weight: 500;">{{ (item.confidenceScore * 100) | number:'1.0-1' }}%</span>
                  <span class="row-severity" [ngClass]="getSeverityClass(item.severity)" style="border-radius: 6px; padding: 2px 10px; font-size: 0.98rem; font-weight: 500; margin-left: 0;">
                    {{ item.severity === 'CRITICAL' ? 'Nguy cấp' : formatSeverity(item.severity) }}
                  </span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                </div>
              </div>
              <div class="row-body" style="margin-top: 6px; font-size: 1rem; font-family: 'Segoe UI', Arial, sans-serif;">
                <div style="margin-bottom: 4px;"><strong>Phát hiện qua:</strong> {{ item.detectionMethod === 'IMAGE' ? 'Ảnh' : 'Triệu chứng' }}</div>
                <div style="margin-bottom: 4px;"><strong>Triệu chứng:</strong> {{ item.symptoms }}</div>
                <div *ngIf="item.recommendedTreatment" style="margin-bottom: 4px;"><strong>Khuyến nghị:</strong> {{ item.recommendedTreatment }}</div>
              </div>
              <div class="row-status" style="margin-top: 4px; font-size: 0.97rem; font-family: 'Segoe UI', Arial, sans-serif;">
                <span *ngIf="item.status === 'TREATED'" [ngClass]="'status-treated'">Đã điều trị</span>
              </div>
              <div class="row-date" style="margin-top: 4px; font-size: 0.97rem; color: #2563eb; font-family: 'Segoe UI', Arial, sans-serif;"><strong>Ngày phát hiện:</strong> {{ formatDate(item.detectedAt) }}</div>
            </div>
          </div>

          <div class="pagination" *ngIf="historyTotalPages > 1">
            <button 
              class="btn-page" 
              [disabled]="historyPage === 0"
              (click)="changeHistoryPage(historyPage - 1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            
            <span class="page-info">
              {{ historyPage + 1 }} / {{ historyTotalPages }}
            </span>
            
            <button 
              class="btn-page" 
              [disabled]="historyPage === historyTotalPages - 1"
              (click)="changeHistoryPage(historyPage + 1)">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Diseases Library Tab -->
    <div class="tab-content" *ngIf="activeTab === 'diseases'">
      <div class="panel">
        <h2>Thư viện bệnh thường gặp</h2>

        <div class="disease-search-bar">
          <input type="text" [(ngModel)]="diseaseSearchText" placeholder="Nhập mô tả triệu chứng hoặc từ khoá..." class="form-control" (keyup.enter)="searchDiseasesByDescription(diseaseSearchText)">
          <button class="btn-primary" (click)="searchDiseasesByDescription(diseaseSearchText)">
            <i class="fas fa-search"></i> Tìm kiếm
          </button>
        </div>

        <div class="plant-type-filter">
          <label>Loại cây:</label>
          <div class="plant-type-options">
            <button 
              *ngFor="let type of plantTypes" 
              class="type-btn" 
              [class.active]="selectedPlantType === type.value"
              (click)="onPlantTypeChange(type.value)">
              {{ type.label }}
            </button>
          </div>
        </div>

        <div class="loading-state" *ngIf="isLibraryLoading">
          <div class="spinner"></div>
          <p>Đang tải dữ liệu...</p>
        </div>

        <div class="error-state" *ngIf="libraryError && !isLibraryLoading">
          <i class="fas fa-exclamation-triangle"></i>
          <p>{{ libraryError }}</p>
          <button class="btn-retry" (click)="onPlantTypeChange(selectedPlantType)">
            <i class="fas fa-redo"></i>
            Thử lại
          </button>
        </div>

        <div class="disease-library" *ngIf="!isLibraryLoading && !libraryError && diseaseLibrary.length > 0">
          <div 
            class="disease-card" 
            *ngFor="let disease of diseaseLibrary; trackBy: trackById">
            <div class="disease-image" *ngIf="disease.imageUrl">
              <img [src]="disease.imageUrl" [alt]="disease.name">
            </div>
            <div class="disease-image placeholder" *ngIf="!disease.imageUrl">
              <i class="fas fa-leaf"></i>
            </div>
            <div class="disease-info">
              <h3>{{ disease.name }}</h3>
              <div class="disease-meta">
                <span class="scientific-name">{{ disease.scientificName }}</span>
                <span class="severity-badge" [ngClass]="getSeverityClass(disease.severity)">{{ formatSeverity(disease.severity) }}</span>
              </div>
              <p class="disease-description">{{ disease.description }}</p>
              <div class="disease-symptoms">
                <strong>Triệu chứng:</strong>
                <ul>
                  <li *ngFor="let symptom of disease.symptoms.slice(0, 3)">{{ symptom }}</li>
                  <li *ngIf="disease.symptoms.length > 3">
                    <em>...và {{ disease.symptoms.length - 3 }} triệu chứng khác</em>
                  </li>
                </ul>
              </div>
              <button class="btn-detail" [routerLink]="['/vip/disease-library', disease.id]">
                Chi tiết
                <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>


         <!-- Loading state for upload and symptoms tabs -->
     <div class="loading-container" *ngIf="(isImageUploading || isSymptomAnalyzing) && !detectionResult">
       <div class="loading-panel">
         <div class="spinner"></div>
         <h3>Đang phân tích</h3>
         <p>Vui lòng chờ trong giây lát...</p>
       </div>
     </div>
   </div>
 </div>
