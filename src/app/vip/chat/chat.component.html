<app-top-navigator></app-top-navigator>

<div class="chat-container">
  <div class="chat-wrapper">
    <!-- Chat Header -->
    <div class="chat-header">
      <div class="header-info">
        <div class="chat-title">
          <h3 *ngIf="!showPrivateChat">Ph√≤ng Chat VIP Community</h3>
          <h3 *ngIf="showPrivateChat">Private Chat</h3>
        </div>
        <div class="header-actions">
          <button *ngIf="!showPrivateChat" class="nav-btn" (click)="switchToPrivateChat()" title="Chuy·ªÉn sang Private Chat">
            <i class="fas fa-comments"></i>
            Private Chat
          </button>
          <button *ngIf="showPrivateChat" class="nav-btn" (click)="switchToCommunityChat()" title="Quay l·∫°i Community Chat">
            <i class="fas fa-users"></i>
            Community Chat
          </button>
        </div>
        <div class="online-status">
          <span class="status-dot"></span>
          <span class="status-text">ƒêang ho·∫°t ƒë·ªông</span>
        </div>
      </div>
    </div>

    <!-- Private Chat Sidebar -->
    <div *ngIf="showPrivateChat" class="private-chat-layout">
      <!-- Conversations Sidebar -->
      <div class="conversations-sidebar">
        <div class="sidebar-header">
          <h4>Tr√≤ chuy·ªán</h4>
        </div>
        
        <!-- Experts Section -->
        <div class="experts-section" *ngIf="experts.length > 0">
          <div class="experts-header">
            <h4>Danh s√°ch chuy√™n gia</h4>
            <span class="experts-count">{{ experts.length }} chuy√™n gia</span>
          </div>
          
          <div class="experts-list">
            <div class="expert-item" 
                 *ngFor="let expert of experts"
                 (click)="startConversationWithExpert(expert)">
              <div class="expert-avatar">
                <div class="avatar-placeholder expert-avatar-placeholder">
                  {{ expert.username.charAt(0).toUpperCase() || 'E' }}
                </div>
              </div>
              
              <div class="expert-info">
                <div class="expert-name">{{ expert.username }}</div>
                <div class="expert-role">Chuy√™n gia</div>
              </div>
              
              <div class="expert-action">
                <i class="fas fa-comment"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="conversations-divider" *ngIf="experts.length > 0 && conversations.length > 0">
          <span>Cu·ªôc tr√≤ chuy·ªán g·∫ßn ƒë√¢y</span>
        </div>
        
        <div class="conversations-list">
          <div *ngIf="loading" class="loading-state">
            <div class="loading-spinner"></div>
            <p>ƒêang t·∫£i...</p>
          </div>

          <div *ngIf="!loading && conversations.length === 0" class="empty-state">
            <div class="empty-icon">üí¨</div>
            <p>Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o</p>
          </div>

          <div *ngFor="let conversation of conversations" 
               class="conversation-item"
               [class.selected]="selectedConversation?.conversationId === conversation.conversationId"
               (click)="selectConversation(conversation)">
            
            <div class="conversation-avatar">
              <div class="avatar-placeholder">
                {{ conversation.otherUsername.charAt(0).toUpperCase() || 'U' }}
              </div>
            </div>
            
            <div class="conversation-info">
              <div class="conversation-name">
                {{ conversation.otherUsername }}
                <span class="role-badge" [class]="'role-' + conversation.otherUserRole.toLowerCase()">
                  {{ conversation.otherUserRole }}
                </span>
              </div>
              
              <div class="conversation-preview">
                <span class="last-message">{{ conversation.lastMessage || 'Ch∆∞a c√≥ tin nh·∫Øn' }}</span>
                <span class="last-time" *ngIf="conversation.lastMessageTime">
                  {{ formatTime(conversation.lastMessageTime) }}
                </span>
              </div>
            </div>

            <div class="conversation-status" *ngIf="conversation.hasUnreadMessages">
              <div class="unread-badge"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Area -->
      <div class="chat-area">
        <div *ngIf="!selectedConversation" class="no-conversation-selected">
          <div class="empty-icon">üí¨</div>
          <h4>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán</h4>
          <p>Ch·ªçn m·ªôt ng∆∞·ªùi d√πng t·ª´ danh s√°ch ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán</p>
        </div>

        <div *ngIf="selectedConversation" class="chat-messages" #messagesContainer>
          <!-- Chat Messages for Private Chat -->
          <div *ngIf="loading" class="loading-state">
            <div class="loading-spinner"></div>
            <p>ƒêang t·∫£i tin nh·∫Øn...</p>
          </div>

          <div *ngIf="error && !loading" class="error-state">
            <div class="error-icon">‚ö†Ô∏è</div>
            <p>{{ error }}</p>
            <button class="retry-btn" (click)="loadPrivateMessages(selectedConversation.otherUserId)">Th·ª≠ l·∫°i</button>
          </div>

          <div *ngIf="!loading && messages.length === 0" class="empty-state">
            <div class="empty-icon">üí≠</div>
            <h4>Ch∆∞a c√≥ tin nh·∫Øn n√†o</h4>
            <p>H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán v·ªõi {{ selectedConversation.otherUsername }}!</p>
          </div>

          <div *ngIf="!loading && messages.length > 0" class="messages-list">
            <div *ngFor="let msg of messages; trackBy: trackMessage" 
                 class="message-wrapper"
                 [class.own-message]="isOwnMessage(msg)"
                 [class.other-message]="!isOwnMessage(msg)">
              
              <!-- Tin nh·∫Øn c·ªßa ng∆∞·ªùi kh√°c (b√™n tr√°i) -->
              <div class="message-row" *ngIf="!isOwnMessage(msg)">
                <!-- T√™n + Role badge -->
                <div class="sender-info">
                  <span class="sender-name">{{ getSenderName(msg) }}</span>
                  <div class="role-badge" [class]="getRoleBadgeClass(msg.senderRole)">
                    {{ getRoleDisplayName(msg.senderRole) }}
                  </div>
                </div>
                <!-- Bubble tin nh·∫Øn -->
                <div class="message-bubble">
                  <div class="message-content">{{ msg.content }}</div>
                </div>
                <!-- Th·ªùi gian -->
                <div class="message-time-inline">
                  {{ formatTime(msg.timestamp) }}
                </div>
              </div>

              <!-- Tin nh·∫Øn c·ªßa m√¨nh (b√™n ph·∫£i) -->
              <div class="message-row own-row" *ngIf="isOwnMessage(msg)">
                <!-- Th·ªùi gian + status -->
                <div class="message-time-inline own-time">
                  <div class="message-status">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                  </div>
                  {{ formatTime(msg.timestamp) }}
                </div>
                <!-- Bubble tin nh·∫Øn -->
                <div class="message-bubble own-bubble">
                  <div class="message-content">{{ msg.content }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Input for Private Chat -->
        <div *ngIf="selectedConversation" class="chat-input-container">
          <form class="chat-input-form" (ngSubmit)="sendMessage()" *ngIf="!loading">
            <div class="input-actions">
              <button type="button" class="input-action-btn" disabled title="ƒê√≠nh k√®m h√¨nh ·∫£nh">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
              </button>
              
              <button type="button" class="input-action-btn" disabled title="ƒê√≠nh k√®m file">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
                </svg>
              </button>
            </div>

            <div class="input-wrapper">
              <textarea 
                class="message-input" 
                [(ngModel)]="newMessage" 
                name="message"
                placeholder="Nh·∫≠p tin nh·∫Øn cho {{ selectedConversation.otherUsername }}..."
                rows="1"
                maxlength="1000"
                (keydown)="onEnterPress($event)"
                #messageInput></textarea>
              
              <button 
                type="submit" 
                class="send-button"
                [class.active]="newMessage.trim().length > 0"
                [disabled]="newMessage.trim().length === 0">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
              </button>
            </div>
          </form>
          
          <div class="input-footer">
            <div class="char-counter" [class.warning]="newMessage.length > 800">
              {{ newMessage.length }}/1000
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Community Chat (Original Layout) -->
    <div *ngIf="!showPrivateChat">
      <!-- Chat Messages -->
      <div class="chat-messages" #messagesContainer>
        <div *ngIf="loading" class="loading-state">
          <div class="loading-spinner"></div>
          <p>ƒêang t·∫£i tin nh·∫Øn...</p>
        </div>

        <div *ngIf="error && !loading" class="error-state">
          <div class="error-icon">‚ö†Ô∏è</div>
          <p>{{ error }}</p>
          <button class="retry-btn" (click)="fetchHistory()">Th·ª≠ l·∫°i</button>
        </div>

        <div *ngIf="!loading && messages.length === 0" class="empty-state">
          <div class="empty-icon">üí≠</div>
          <h4>Ch∆∞a c√≥ tin nh·∫Øn n√†o</h4>
          <p>H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán ƒë·∫ßu ti√™n!</p>
        </div>

        <div *ngIf="!loading && messages.length > 0" class="messages-list">
          <div *ngFor="let msg of messages; trackBy: trackMessage" 
               class="message-wrapper"
               [class.own-message]="isOwnMessage(msg)"
               [class.other-message]="!isOwnMessage(msg)">
            
            <!-- Tin nh·∫Øn c·ªßa ng∆∞·ªùi kh√°c (b√™n tr√°i) -->
            <div class="message-row" *ngIf="!isOwnMessage(msg)">
              <!-- T√™n + Role badge -->
              <div class="sender-info">
                <span class="sender-name">{{ getSenderName(msg) }}</span>
                <div class="role-badge" [class]="getRoleBadgeClass(msg.senderRole)">
                  {{ getRoleDisplayName(msg.senderRole) }}
                </div>
              </div>
              <!-- Bubble tin nh·∫Øn -->
              <div class="message-bubble">
                <div class="message-content">{{ msg.content }}</div>
              </div>
              <!-- Th·ªùi gian -->
              <div class="message-time-inline">
                {{ formatTime(msg.timestamp) }}
              </div>
            </div>

            <!-- Tin nh·∫Øn c·ªßa m√¨nh (b√™n ph·∫£i) -->
            <div class="message-row own-row" *ngIf="isOwnMessage(msg)">
              <!-- Th·ªùi gian + status -->
              <div class="message-time-inline own-time">
                <div class="message-status">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                  </svg>
                </div>
                {{ formatTime(msg.timestamp) }}
              </div>
              <!-- Bubble tin nh·∫Øn -->
              <div class="message-bubble own-bubble">
                <div class="message-content">{{ msg.content }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Input -->
      <div class="chat-input-container">
        <form class="chat-input-form" (ngSubmit)="sendMessage()" *ngIf="!loading">
          <div class="input-actions">
            <button type="button" class="input-action-btn" disabled title="ƒê√≠nh k√®m h√¨nh ·∫£nh">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
              </svg>
            </button>
            
            <button type="button" class="input-action-btn" disabled title="ƒê√≠nh k√®m file">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
              </svg>
            </button>
          </div>

          <div class="input-wrapper">
            <textarea 
              class="message-input" 
              [(ngModel)]="newMessage" 
              name="message"
              placeholder="Nh·∫≠p tin nh·∫Øn VIP c·ªßa b·∫°n..."
              rows="1"
              maxlength="1000"
              (keydown)="onEnterPress($event)"
              #messageInput></textarea>
            
            <button 
              type="submit" 
              class="send-button"
              [class.active]="newMessage.trim().length > 0"
              [disabled]="newMessage.trim().length === 0">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </form>
        
        <div class="input-footer">
          <div class="char-counter" [class.warning]="newMessage.length > 800">
            {{ newMessage.length }}/1000
          </div>
        </div>
      </div>
    </div>
  </div>
</div>