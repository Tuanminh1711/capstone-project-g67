<div class="admin-update-user-container">
  <div class="detail-header">
    <h2></h2>
  </div>

  @if (loading) {
    <div class="loading-bar">
      <i class="fas fa-spinner fa-spin"></i>
      Đang tải thông tin...
    </div>
  }

  @if (errorMsg && !loading) {
    <div class="error-bar">
      {{ errorMsg }}
      <button class="retry-btn" (click)="loadUserDetail()">
        <i class="fas fa-redo"></i>
        Thử lại
      </button>
    </div>
  }

  @if (user && !loading && !errorMsg) {
    <!-- Self-Edit Warning -->
    @if (isSelfEdit) {
      <div class="self-edit-warning">
        <div class="warning-content">
          <i class="fas fa-exclamation-triangle"></i>
          <div class="warning-text">
            <h4>Chỉnh sửa tài khoản của bạn</h4>
            <p>Bạn đang chỉnh sửa thông tin tài khoản của chính mình. Vui lòng thận trọng khi thay đổi thông tin quan trọng.</p>
          </div>
        </div>
      </div>
    }
    
    <div class="update-user-card">
      <!-- Current User Info -->
      <div class="current-user-info">
        <h3>Thông tin hiện tại</h3>
        <div class="user-header">
          <div class="user-avatar">
            @if (hasUserAvatar()) {
              <img [src]="getUserAvatarSrc()" 
                   [alt]="user.fullName" 
                   class="avatar-image"
                   (error)="onAvatarError($event)">
            }
            <div class="avatar-placeholder" [style.display]="hasUserAvatar() ? 'none' : 'flex'">
              <i class="fas fa-user"></i>
            </div>
          </div>
          <div class="user-basic-info">
            <h4 class="user-fullname">{{ user.fullName }}</h4>
            <p class="user-username">{{ '@' + user.username }}</p>
            <div class="user-status-role">
              <span class="status-badge" [ngClass]="getStatusClass(user.status)">
                {{ getStatusText(user.status) }}
              </span>
              <span class="role-badge">
                {{ getRoleText(user.role) }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Update Form -->
      <div class="update-form">
        <h3>Cập nhật thông tin</h3>
        <form (ngSubmit)="updateUser()" #updateForm="ngForm">
          <div class="form-grid two-columns">
            <div class="form-section left-column">
              <h4>Thông tin cơ bản</h4>
              <div class="form-group">
                <label for="username">Tên đăng nhập</label>
                <input 
                  type="text" 
                  id="username" 
                  name="username" 
                  [(ngModel)]="formData.username" 
                  readonly 
                  class="form-control readonly-input"
                  title="Tên đăng nhập không thể thay đổi">
                <small class="form-text">Tên đăng nhập không thể thay đổi</small>
              </div>
              @if (showOnlyUsernameAndRole) {
                <div class="form-group">
                  <label for="roleId">Vai trò</label>
                  <select 
                    id="roleId" 
                    name="roleId" 
                    [(ngModel)]="formData.roleId" 
                    class="form-control"
                    [disabled]="!canEditRole">
                    <option value="1">Quản trị viên</option>
                    <option value="2">Nhân viên</option>
                    <option value="3">Người dùng</option>
                    <option value="5">Chuyên gia</option>
                  </select>
                </div>
              } @else {
                <div class="form-group">
                  <label for="fullName">Họ và tên *</label>
                  <input 
                    type="text" 
                    id="fullName" 
                    name="fullName" 
                    [(ngModel)]="formData.fullName" 
                    required 
                    class="form-control"
                    [disabled]="!canEditInfo">
                </div>
                <div class="form-group">
                  <label for="email">Email *</label>
                  <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    [(ngModel)]="formData.email" 
                    required 
                    class="form-control"
                    [disabled]="!canEditInfo">
                </div>
                <div class="form-group">
                  <label for="phoneNumber">Số điện thoại</label>
                  <input 
                    type="tel" 
                    id="phoneNumber" 
                    name="phoneNumber" 
                    [(ngModel)]="formData.phoneNumber" 
                    class="form-control"
                    [disabled]="!canEditInfo">
                </div>
              }
            </div>
            <div class="form-section right-column">
              <h4>Thông tin bổ sung</h4>
              @if (!showOnlyUsernameAndRole) {
                <div class="form-group">
                  <label for="gender">Giới tính</label>
                  <select 
                    id="gender" 
                    name="gender" 
                    [(ngModel)]="formData.gender" 
                    class="form-control"
                    [disabled]="!canEditInfo">
                    <option value="male">Nam</option>
                    <option value="female">Nữ</option>
                    <option value="other">Khác</option>
                  </select>
                </div>
                <div class="form-group" *ngIf="!isSelfEdit">
                  <label for="roleId">Vai trò</label>
                  <select 
                    id="roleId" 
                    name="roleId" 
                    [(ngModel)]="formData.roleId" 
                    class="form-control"
                    [disabled]="!canEditRole || canEditRoleOfAdmin">
                    <option value="2">Nhân viên</option>
                    <option value="3">Người dùng</option>
                    <option value="5">Chuyên gia</option>
                  </select>
                </div>
                <div class="form-group" *ngIf="!isSelfEdit">
                  <label for="status">Trạng thái</label>
                  <select 
                    id="status" 
                    name="status" 
                    [(ngModel)]="formData.status" 
                    class="form-control"
                    [disabled]="!canEditInfo">
                    <option value="ACTIVE">Hoạt động</option>
                    <option value="INACTIVE">Đã khóa</option>
                    <option value="BANNED">Cấm</option>
                  </select>
                </div>
                
                <!-- Self-edit note -->
                @if (isSelfEdit) {
                  <div class="self-edit-info">
                    <div class="info-content">
                      <i class="fas fa-info-circle"></i>
                      <div class="info-text">
                        <h4>Chỉnh sửa tài khoản cá nhân</h4>
                        <p>Bạn đang chỉnh sửa tài khoản của chính mình. Vai trò và trạng thái tài khoản không thể thay đổi và sẽ được giữ nguyên.</p>
                        <div class="current-info">
                          <span><strong>Vai trò hiện tại:</strong> {{ getRoleText(user.role) }}</span>
                          <span><strong>Trạng thái:</strong> {{ getStatusText(user.status) }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                }
                @if (showPasswordField) {
                  <div class="form-group">
                    <label for="password">Mật khẩu mới</label>
                    <input 
                      type="password" 
                      id="password" 
                      name="password" 
                      [(ngModel)]="formData.password" 
                      class="form-control"
                      placeholder="Để trống nếu không muốn thay đổi"
                      [disabled]="!canEditInfo">
                    <small class="form-text">Để trống nếu không muốn thay đổi mật khẩu</small>
                  </div>
                }
              }
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button 
              type="button" 
              class="btn btn-secondary" 
              (click)="goBack()">
              <i class="fas fa-arrow-left"></i>
              Quay lại
            </button>

            @if (showPasswordField) {
              <button 
                type="button" 
                class="btn btn-warning" 
                (click)="formData.password = ''">
                <i class="fas fa-key"></i>
                Đặt lại mật khẩu
              </button>
            }

            <button 
              type="submit" 
              class="btn btn-primary" 
              [disabled]="updating || updateForm.invalid">
              @if (updating) {
                <i class="fas fa-spinner fa-spin"></i>
                Đang cập nhật...
              } @else {
                <i class="fas fa-save"></i>
                Cập nhật
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
