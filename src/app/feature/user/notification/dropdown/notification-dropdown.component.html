<div class="notification-dropdown-container">
  <!-- Notification Badge Trigger -->
  <div class="notification-trigger" (click)="toggleDropdown()">
    <app-notification-badge></app-notification-badge>
  </div>

  <!-- Dropdown Menu -->
  <mat-card class="notification-dropdown custom-notification-dropdown" [class.open]="isOpen">
    <!-- Header -->
    <div class="dropdown-header custom-header">
      <h4>
        <mat-icon class="white-icon">notifications</mat-icon>
        <span>Thông báo</span>
        @if (unreadCount > 0) {
          <span class="unread-count">({{ unreadCount }})</span>
        }
      </h4>
    </div>

    <mat-divider></mat-divider>

    <!-- Loading state -->
    @if (isLoading) {
      <div class="dropdown-loading">
        <mat-spinner diameter="24"></mat-spinner>
        <span>Đang tải...</span>
      </div>
    }

    <!-- No notifications -->
    @if (!isLoading && notifications.length === 0) {
      <div class="dropdown-empty">
        <mat-icon class="empty-icon">notifications_off</mat-icon>
        <p>Không có thông báo</p>
      </div>
    }

    <!-- Notification List -->
    @if (!isLoading && notifications.length > 0) {
      <mat-list class="dropdown-list custom-scroll">
        @for (notification of notifications; track trackByNotificationId(i, notification); let i = $index) {
          <mat-list-item 
            class="dropdown-item custom-item"
            [ngClass]="getNotificationClass(toNotificationType(notification.type))"
            (click)="onNotificationClick(notification)"
            style="background: transparent; color: #fff; cursor: pointer;">
            <div matListItemIcon class="item-icon">
              <mat-icon class="white-icon">
                {{ getNotificationIcon(toNotificationType(notification.type)) }}
              </mat-icon>
            </div>
            <div matListItemTitle class="item-title">
              <ng-container *ngIf="notification.title && notification.title.includes('Tin nhắn mới trong Community')">
                Tin nhắn mới trong Community
              </ng-container>
              <ng-container *ngIf="notification.title && notification.title.includes('Tin nhắn mới từ expert')">
                Tin nhắn mới từ chuyên gia
              </ng-container>
              <ng-container *ngIf="notification.title && notification.title.includes('Tin nhắn mới từ phucexpert2')">
                Tin nhắn mới từ phucexpert2
              </ng-container>
              <ng-container *ngIf="notification.title && !(notification.title.includes('Tin nhắn mới trong Community') || notification.title.includes('Tin nhắn mới từ expert') || notification.title.includes('Tin nhắn mới từ phucexpert2'))">
                {{ truncateText(notification.title, 40) }}
              </ng-container>
            </div>
            <div matListItemLine class="item-message">
              {{ truncateText(notification.message, 50) }}
            </div>
            <div matListItemLine class="item-time">
              {{ formatTime(notification.createdAt) }}
            </div>
            @if (notification.status !== 'READ') {
              <div class="item-indicator">
                <mat-icon class="unread-dot">fiber_manual_record</mat-icon>
              </div>
            }
          </mat-list-item>
          @if (i < notifications.length - 1) {
            <mat-divider></mat-divider>
          }
        }
      </mat-list>
    }

    <!-- Footer -->
    <div class="dropdown-footer custom-footer">
      <a 
        mat-raised-button 
        class="btn-view-all custom-btn-view-all"
        routerLink="/user/notification" 
        (click)="isOpen = false">
        <mat-icon class="white-icon">visibility</mat-icon>
        Xem tất cả thông báo
      </a>
    </div>
  </mat-card>

  <!-- Overlay -->
  @if (isOpen) {
    <div class="dropdown-overlay" (click)="isOpen = false"></div>
  }
</div>
