<app-top-navigator></app-top-navigator>

<div class="calendar-container">
  <!-- Header v·ªõi th√¥ng tin t·ªïng quan -->
  <div class="calendar-header">
    <div class="header-content">
      <h1>üìÖ L·ªãch ChƒÉm S√≥c C√¢y</h1>
      <p class="subtitle">Theo d√µi streak v√† l·ªãch s·ª≠ chƒÉm s√≥c c·ªßa b·∫°n</p>
    </div>
    
    <!-- Th·ªëng k√™ t·ªïng quan -->
    <div class="overview-stats">
      <div class="stat-card" *ngFor="let streak of careStreaks">
        <div class="stat-icon" [style.background-color]="streak.typeColor">
          <i [class]="streak.typeIcon"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ streak.currentStreak }}</div>
          <div class="stat-label">Streak hi·ªán t·∫°i</div>
          <div class="stat-subtitle">{{ streak.typeName }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs ch√≠nh -->
  <mat-tab-group class="main-tabs" animationDuration="300ms">
    
    <!-- Tab Calendar -->
    <mat-tab label="üìÖ L·ªãch">
      <div class="calendar-tab">
        <!-- Calendar Navigation -->
        <div class="calendar-nav">
          <button mat-icon-button (click)="previousMonth()" class="nav-btn">
            <mat-icon>chevron_left</mat-icon>
          </button>
          
          <div class="month-display">
            <h2>{{ currentMonth.format('MMMM YYYY') }}</h2>
          </div>
          
          <button mat-icon-button (click)="nextMonth()" class="nav-btn">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-grid">
          <!-- Weekday Headers -->
          <div class="weekday-header" *ngFor="let day of ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7']">
            {{ day }}
          </div>

          <!-- Calendar Days -->
          <div 
            class="calendar-day" 
            *ngFor="let day of calendarDays; trackBy: trackByDate"
            [class.other-month]="!isCurrentMonth(day)"
            [class.today]="isToday(day)"
            [class.selected]="selectedDate.isSame(day, 'day')"
            (click)="selectDate(day)"
          >
            <div class="day-number">{{ day.format('D') }}</div>
            
            <!-- Care Type Indicators -->
            <div class="care-indicators" *ngIf="getCareTypesForDate(day).length > 0">
              <div 
                class="care-dot"
                *ngFor="let careTypeId of getCareTypesForDate(day)"
                [style.borderColor]="getCareTypeColor(careTypeId)"
                [matTooltip]="getCareTypeName(careTypeId)"
              >
                <i class="fas fa-leaf"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Selected Date Info -->
        <div class="selected-date-info" *ngIf="selectedDate">
          <mat-card class="date-card">
            <mat-card-header>
              <mat-card-title>{{ getSelectedDateInfo() }}</mat-card-title>
              <mat-card-subtitle>{{ selectedDate.format('dddd, DD/MM/YYYY') }}</mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div class="care-types-for-date" *ngIf="getSelectedDateCareTypes().length > 0; else noCareTypes">
                <h4>Lo·∫°i chƒÉm s√≥c ƒë√£ th·ª±c hi·ªán:</h4>
                <div class="care-type-chips">
                  <mat-chip 
                    *ngFor="let careTypeId of getSelectedDateCareTypes()"
                    [style.background-color]="getCareTypeColor(careTypeId)"
                    class="care-chip"
                  >
                    <i [class]="getCareTypeIcon(careTypeId)" class="chip-icon"></i>
                    {{ getCareTypeName(careTypeId) }}
                  </mat-chip>
                </div>
              </div>
              
              <ng-template #noCareTypes>
                <div class="no-care-types">
                  <i class="fas fa-calendar-times"></i>
                  <p>Ch∆∞a c√≥ ho·∫°t ƒë·ªông chƒÉm s√≥c n√†o trong ng√†y n√†y</p>
                </div>
              </ng-template>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-tab>

    <!-- Tab Streaks -->
    <mat-tab label="üî• Streaks">
      <div class="streaks-tab">
        <div class="streaks-grid">
          <mat-card class="streak-card" *ngFor="let streak of careStreaks">
            <mat-card-header>
              <div class="streak-header">
                <div class="streak-icon" [style.background-color]="streak.typeColor">
                  <i [class]="streak.typeIcon"></i>
                </div>
                <div class="streak-title">
                  <h3>{{ streak.typeName }}</h3>
                  <p class="streak-subtitle">T·ªïng: {{ streak.totalCares }} l·∫ßn</p>
                </div>
              </div>
            </mat-card-header>
            
            <mat-card-content>
              <!-- Current Streak -->
              <div class="streak-info">
                <div class="streak-current">
                  <div class="streak-number">{{ streak.currentStreak }}</div>
                  <div class="streak-label">Streak hi·ªán t·∫°i</div>
                </div>
                
                <div class="streak-longest">
                  <div class="streak-number">{{ streak.longestStreak }}</div>
                  <div class="streak-label">Streak d√†i nh·∫•t</div>
                </div>
              </div>

              <!-- Progress Bar -->
              <div class="streak-progress">
                <mat-progress-bar 
                  mode="determinate" 
                  [value]="getStreakPercentage(streak)"
                  [style.color]="streak.typeColor"
                ></mat-progress-bar>
                <div class="progress-text">{{ getStreakPercentage(streak) | number:'1.0-0' }}% c·ªßa streak d√†i nh·∫•t</div>
              </div>

              <!-- Last Care Date -->
              <div class="last-care-date" *ngIf="streak.lastCareDate">
                <i class="fas fa-clock"></i>
                <span>L·∫ßn cu·ªëi: {{ streak.lastCareDate.fromNow() }}</span>
              </div>

              <!-- Streak Days Visualization -->
              <div class="streak-days" *ngIf="streak.streakDays.length > 0">
                <h4>30 ng√†y g·∫ßn nh·∫•t:</h4>
                <div class="streak-calendar">
                  <div 
                    class="streak-day" 
                    *ngFor="let date of streak.streakDays.slice(0, 30)"
                    [class.has-care]="true"
                    [style.background-color]="streak.typeColor"
                    [matTooltip]="date.format('DD/MM/YYYY')"
                  ></div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-tab>

    <!-- Tab History -->
    <mat-tab label="üìã L·ªãch s·ª≠">
      <div class="history-tab">
        <div class="history-header">
          <h3>L·ªãch s·ª≠ chƒÉm s√≥c g·∫ßn ƒë√¢y</h3>
          <div class="history-filters">
            <!-- <mat-chip-listbox>
              <mat-chip-option 
                *ngFor="let type of careTypes" 
                [value]="type.id"
                [style.color]="type.color"
              >
                <i [class]="type.icon"></i>
                {{ type.name }}
              </mat-chip-option>
            </mat-chip-listbox> -->
          </div>
        </div>

        <div class="history-list">
          <mat-card class="history-item" *ngFor="let item of careHistory">
            <div class="history-content">
              <div class="history-icon" [style.background-color]="getCareTypeColor(getCareTypeIdByName(item.careTypeName))">
                <i [class]="getCareTypeIcon(getCareTypeIdByName(item.careTypeName))"></i>
              </div>
              
              <div class="history-details">
                <div class="history-title">{{ item.plantName }}</div>
                <div class="history-type">{{ item.careTypeName }}</div>
                <div class="history-notes" *ngIf="item.notes">{{ item.notes }}</div>
                <div class="history-time">{{ getTimeAgo(item.careDate) }}</div>
              </div>
            </div>
          </mat-card>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" *ngIf="loading">
  <mat-spinner></mat-spinner>
  <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
</div>
