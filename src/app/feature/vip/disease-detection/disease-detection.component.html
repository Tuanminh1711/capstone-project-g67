<div class="container">
  <app-top-navigator></app-top-navigator>
  
  <!-- Header -->
  <div class="header">
    <h1>ğŸ”¬ PhÃ¡t Hiá»‡n Bá»‡nh CÃ¢y Trá»“ng</h1>
    <p class="subtitle">Sá»­ dá»¥ng AI Ä‘á»ƒ cháº©n Ä‘oÃ¡n vÃ  Ä‘iá»u trá»‹ bá»‡nh cÃ¢y trá»“ng má»™t cÃ¡ch chÃ­nh xÃ¡c</p>
  </div>

  <!-- Alert Messages -->
  <div *ngIf="errorMessage" class="alert error">
    <span class="alert-icon">âš ï¸</span>
    {{ errorMessage }}
  </div>
  
  <div *ngIf="successMessage" class="alert success">
    <span class="alert-icon">âœ…</span>
    {{ successMessage }}
  </div>

  <!-- Navigation Tabs -->
  <div class="nav-tabs">
    <button 
      [class.active]="activeTab === 'image'"
      (click)="setActiveTab('image')"
      class="tab-btn">
      ğŸ“· PhÃ¡t hiá»‡n qua áº£nh
    </button>
    <button 
      [class.active]="activeTab === 'symptoms'"
      (click)="setActiveTab('symptoms')"
      class="tab-btn">
      ğŸ” PhÃ¡t hiá»‡n qua triá»‡u chá»©ng
    </button>
    <button 
      [class.active]="activeTab === 'history'"
      (click)="setActiveTab('history')"
      class="tab-btn">
      ğŸ“‹ Lá»‹ch sá»­ phÃ¡t hiá»‡n
    </button>
    <button 
      [class.active]="activeTab === 'library'"
      (click)="setActiveTab('library')"
      class="tab-btn">
      ğŸ“š ThÆ° viá»‡n bá»‡nh
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    
    <!-- ==================== IMAGE DETECTION TAB ==================== -->
    <div *ngIf="activeTab === 'image'" class="tab-panel">
      <div class="detection-card">
        <h2>ğŸ“· PhÃ¡t hiá»‡n bá»‡nh qua hÃ¬nh áº£nh</h2>
        <p class="card-description">
          Táº£i lÃªn áº£nh cÃ¢y bá»‹ bá»‡nh Ä‘á»ƒ AI phÃ¢n tÃ­ch vÃ  cháº©n Ä‘oÃ¡n
        </p>

        <!-- Image Upload Area -->
        <div class="image-upload-area">
          <input 
            #imageInput
            type="file" 
            accept="image/*" 
            (change)="onImageSelected($event)"
            hidden>
          
          <div class="upload-placeholder" (click)="imageInput.click()">
            <div *ngIf="!selectedImage && !imagePreviewUrl" class="upload-icon">
              ğŸ“·
            </div>
            <img 
              *ngIf="imagePreviewUrl" 
              [src]="imagePreviewUrl" 
              alt="Preview" 
              class="image-preview">
            
            <p *ngIf="!selectedImage && !imagePreviewUrl" class="upload-text">
              Click Ä‘á»ƒ chá»n áº£nh hoáº·c kÃ©o tháº£ áº£nh vÃ o Ä‘Ã¢y
            </p>
            <p *ngIf="imagePreviewUrl" class="upload-text">
              Click Ä‘á»ƒ thay Ä‘á»•i áº£nh
            </p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button 
            (click)="detectDiseaseFromImage()"
            [disabled]="!selectedImage || isDetectingFromImage"
            class="btn primary large">
            <span *ngIf="!isDetectingFromImage">ğŸ” PhÃ¡t hiá»‡n bá»‡nh</span>
            <span *ngIf="isDetectingFromImage">â³ Äang phÃ¢n tÃ­ch...</span>
          </button>
          
          <button 
            *ngIf="selectedImage || imageDetectionResult"
            (click)="clearImageDetection()"
            class="btn secondary">
            ğŸ—‘ï¸ XÃ³a
          </button>
        </div>

        <!-- Detection Result -->
        <div *ngIf="imageDetectionResult" class="detection-result">
          <h3>ğŸ¯ Káº¿t quáº£ phÃ¡t hiá»‡n</h3>
          <div class="result-content">
            <div class="result-header">
              <h4>{{ imageDetectionResult.detectedDisease }}</h4>
              <span class="confidence-badge">
                Äá»™ tin cáº­y: {{ (imageDetectionResult.confidenceScore * 100).toFixed(0) }}%
              </span>
            </div>
            
            <div class="result-details">
              <div class="detail-item">
                <strong>Má»©c Ä‘á»™ nghiÃªm trá»ng:</strong>
                <span class="severity-badge" [style.background-color]="getSeverityColor(imageDetectionResult.severity)">
                  {{ imageDetectionResult.severity }}
                </span>
              </div>
              
              <div class="detail-item">
                <strong>Triá»‡u chá»©ng:</strong>
                <p>{{ imageDetectionResult.symptoms }}</p>
              </div>
              
              <div class="detail-item">
                <strong>Äiá»u trá»‹ Ä‘Æ°á»£c khuyáº¿n nghá»‹:</strong>
                <p>{{ imageDetectionResult.recommendedTreatment }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== SYMPTOMS DETECTION TAB ==================== -->
    <div *ngIf="activeTab === 'symptoms'" class="tab-panel">
      <div class="detection-card">
        <h2>ğŸ” PhÃ¡t hiá»‡n bá»‡nh qua triá»‡u chá»©ng</h2>
        <p class="card-description">
          MÃ´ táº£ triá»‡u chá»©ng cÃ¢y bá»‹ bá»‡nh Ä‘á»ƒ AI phÃ¢n tÃ­ch vÃ  cháº©n Ä‘oÃ¡n
        </p>

        <!-- Symptoms Form -->
        <form [formGroup]="symptomsForm" class="symptoms-form">
          <div class="form-group">
            <label for="symptoms">MÃ´ táº£ triá»‡u chá»©ng bá»‡nh *</label>
            <textarea 
              id="symptoms" 
              formControlName="symptoms" 
              placeholder="MÃ´ táº£ chi tiáº¿t cÃ¡c triá»‡u chá»©ng báº¡n quan sÃ¡t tháº¥y trÃªn cÃ¢y..."
              rows="6"
              class="form-control">
            </textarea>
            <div *ngIf="isFieldInvalid('symptoms')" class="error-message">
              {{ getFieldError('symptoms') }}
            </div>
            <small class="form-help">
              VÃ­ dá»¥: "CÃ¢y hoa há»“ng cá»§a tÃ´i thÃ¢n má»m, Ä‘en, cÃ¢y gÃ£y" hoáº·c "LÃ¡ cÃ¢y xuáº¥t hiá»‡n Ä‘á»‘m vÃ ng, khÃ´ hÃ©o"
            </small>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button 
              (click)="detectDiseaseFromSymptoms()"
              [disabled]="symptomsForm.invalid || isDetectingFromSymptoms"
              class="btn primary large">
              <span *ngIf="!isDetectingFromSymptoms">ğŸ” PhÃ¢n tÃ­ch triá»‡u chá»©ng</span>
              <span *ngIf="isDetectingFromSymptoms">â³ Äang phÃ¢n tÃ­ch...</span>
            </button>
          </div>
        </form>

        <!-- Detection Result -->
        <div *ngIf="symptomsDetectionResult" class="detection-result">
          <h3>ğŸ¯ Káº¿t quáº£ phÃ¢n tÃ­ch triá»‡u chá»©ng</h3>
          <div class="result-content">
            <div class="result-header">
              <h4>{{ symptomsDetectionResult.detectedDisease }}</h4>
              <span class="confidence-badge">
                Äá»™ tin cáº­y: {{ (symptomsDetectionResult.confidenceScore * 100).toFixed(0) }}%
              </span>
            </div>
            
            <div class="result-details">
              <div class="detail-item">
                <strong>Má»©c Ä‘á»™ nghiÃªm trá»ng:</strong>
                <span class="severity-badge" [style.background-color]="getSeverityColor(symptomsDetectionResult.severity)">
                  {{ symptomsDetectionResult.severity }}
                </span>
              </div>
              
              <div class="detail-item">
                <strong>Triá»‡u chá»©ng:</strong>
                <p>{{ symptomsDetectionResult.symptoms }}</p>
              </div>
              
              <div class="detail-item">
                <strong>Äiá»u trá»‹ Ä‘Æ°á»£c khuyáº¿n nghá»‹:</strong>
                <p>{{ symptomsDetectionResult.recommendedTreatment }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== HISTORY TAB ==================== -->
    <div *ngIf="activeTab === 'history'" class="tab-panel">
      <div class="history-header">
        <h3>ğŸ“‹ Lá»‹ch sá»­ phÃ¡t hiá»‡n bá»‡nh</h3>
        <p>Tá»•ng cá»™ng {{ totalHistoryItems }} láº§n phÃ¡t hiá»‡n</p>
        <button (click)="refreshCurrentTab()" class="btn primary small">
          ğŸ”„ LÃ m má»›i lá»‹ch sá»­
        </button>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoadingHistory" class="loading-state">
        <div class="spinner"></div>
        <p>Äang táº£i lá»‹ch sá»­...</p>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isLoadingHistory && detectionHistory.length === 0" class="empty-state">
        <div class="empty-icon">ğŸ“‹</div>
        <p>ChÆ°a cÃ³ lá»‹ch sá»­ phÃ¡t hiá»‡n bá»‡nh nÃ o</p>
        <p class="empty-subtitle">HÃ£y thá»­ phÃ¡t hiá»‡n bá»‡nh qua áº£nh hoáº·c triá»‡u chá»©ng Ä‘á»ƒ báº¯t Ä‘áº§u</p>
      </div>

      <!-- History List -->
      <div *ngIf="!isLoadingHistory && detectionHistory.length > 0" class="history-list modern">
        <div *ngFor="let record of detectionHistory" class="history-card">
          <div class="history-card-header">
            <div>
              <span class="history-disease-name">{{ record.detectedDisease }}</span>
              <span class="history-severity-badge" [ngClass]="'sev-' + record.severity.toLowerCase()">{{ record.severity }}</span>
            </div>
            <div class="history-method">
              {{ record.detectionMethod === 'IMAGE' ? 'Qua áº£nh' : 'Qua triá»‡u chá»©ng' }}
            </div>
          </div>
          <div class="history-card-body">
            <div class="history-row">
              <span class="history-label">Triá»‡u chá»©ng:</span>
              <span class="history-value">{{ record.symptoms }}</span>
            </div>
            <div class="history-row">
              <span class="history-label">Äiá»u trá»‹:</span>
              <span class="history-value">{{ record.recommendedTreatment }}</span>
            </div>
            <div class="history-row">
              <span class="history-label">Äá»™ tin cáº­y:</span>
              <span class="history-value">{{ (record.confidenceScore * 100).toFixed(0) }}%</span>
            </div>
            <div class="history-row">
              <span class="history-label">Tráº¡ng thÃ¡i:</span>
              <span class="history-value">{{ record.status === 'DETECTED' ? 'ÄÃ£ phÃ¡t hiá»‡n' : record.status }}</span>
              <span *ngIf="record.isConfirmed" class="history-confirmed">ÄÃ£ xÃ¡c nháº­n</span>
            </div>
            <div class="history-row">
              <span class="history-label">Thá»i gian:</span>
              <span class="history-value">{{ record.detectedAt | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="history-row">
              <span class="history-label">PhiÃªn báº£n AI:</span>
              <span class="history-value">{{ record.aiModelVersion }}</span>
            </div>
            <div *ngIf="record.expertNotes" class="history-row">
              <span class="history-label">Ghi chÃº chuyÃªn gia:</span>
              <span class="history-value">{{ record.expertNotes }}</span>
            </div>
            <div *ngIf="record.treatmentResult" class="history-row">
              <span class="history-label">KQ Ä‘iá»u trá»‹:</span>
              <span class="history-value">{{ record.treatmentResult }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== LIBRARY TAB ==================== -->
    <div *ngIf="activeTab === 'library'" class="tab-panel">
      <div class="library-header">
        <h3>ğŸ“š ThÆ° viá»‡n bá»‡nh thÆ°á»ng gáº·p</h3>
        <p class="card-description">
          KhÃ¡m phÃ¡ cÆ¡ sá»Ÿ dá»¯ liá»‡u toÃ n diá»‡n vá» cÃ¡c bá»‡nh cÃ¢y trá»“ng phá»• biáº¿n, 
          bao gá»“m triá»‡u chá»©ng, phÆ°Æ¡ng phÃ¡p Ä‘iá»u trá»‹ vÃ  biá»‡n phÃ¡p phÃ²ng ngá»«a
        </p>
      </div>


      <!-- Loading State -->
      <div *ngIf="isLoadingLibrary" class="loading-state">
        <div class="spinner"></div>
        <p>Äang táº£i thÆ° viá»‡n bá»‡nh...</p>
      </div>


      <!-- Only show category dropdown for filtering -->
      <div *ngIf="!isLoadingLibrary" class="filter-controls" [formGroup]="filterForm">
        <div class="filter-group">
          <label>Loáº¡i bá»‡nh:</label>
          <select formControlName="selectedCategory" class="form-control">
            <option *ngFor="let category of categories" [value]="category">{{ category }}</option>
          </select>
        </div>
      </div>


  <!-- Advanced Filters removed -->


  <!-- Filtering State removed -->


      <!-- Results Summary -->
      <div *ngIf="!isLoadingLibrary && filteredDiseases.length > 0" class="results-summary">
        <p>
          ğŸ¯ Hiá»ƒn thá»‹ {{ (currentPage * pageSize) + 1 }}-{{ (currentPage + 1) * pageSize > totalItems ? totalItems : (currentPage + 1) * pageSize }} 
          trong tá»•ng sá»‘ {{ totalItems }} bá»‡nh Ä‘Æ°á»£c tÃ¬m tháº¥y
        </p>
      </div>


      <!-- Empty State -->
      <div *ngIf="!isLoadingLibrary && filteredDiseases.length === 0" class="empty-state">
        <div class="empty-icon">ğŸ”</div>
        <p>KhÃ´ng tÃ¬m tháº¥y bá»‡nh nÃ o phÃ¹ há»£p vá»›i loáº¡i Ä‘Ã£ chá»n</p>
      </div>

  <!-- Disease Grid -->
  <div *ngIf="!isLoadingLibrary && filteredDiseases.length > 0" class="disease-grid">
        <div *ngFor="let disease of paginatedDiseases" class="disease-card" (click)="selectDisease(disease)">
          <div class="disease-card-header">
            <div class="disease-title-row">
              <span class="disease-name">{{ disease.name }}</span>
              <span class="disease-category">{{ disease.category }}</span>
            </div>
            <div class="disease-meta-row">
              <span class="severity-badge" [ngClass]="'sev-' + disease.severity.toLowerCase()">{{ disease.severity }}</span>
              <span class="common-badge" *ngIf="disease.commonality === 1">â­ Phá»• biáº¿n</span>
            </div>
          </div>
          <div class="disease-card-body">
            <div class="disease-scientific">{{ disease.scientificName }}</div>
            <div class="disease-symptoms">
              <span class="disease-label">ğŸŒ¿ Triá»‡u chá»©ng:</span>
              <ul>
                <li *ngFor="let symptom of disease.symptoms">{{ symptom }}</li>
              </ul>
            </div>
            <div class="disease-plants">
              <span class="disease-label">ğŸŒ± CÃ¢y bá»‹ áº£nh hÆ°á»Ÿng:</span>
              <div class="plant-tags">
                <span *ngFor="let plant of disease.affectedPlants" class="plant-tag">{{ plant }}</span>
              </div>
            </div>
          </div>
          <div class="disease-actions">
            <button class="btn secondary" (click)="loadTreatmentGuide(disease.name); $event.stopPropagation()">
              ğŸ’Š HÆ°á»›ng dáº«n Ä‘iá»u trá»‹
            </button>
          </div>
        </div>
      </div>

      <!-- Pagination -->
  <div *ngIf="!isLoadingLibrary && totalPages > 1" class="pagination">
        <button 
          (click)="prevPage()" 
          [disabled]="!hasPrevPage"
          class="btn pagination-btn">
          â† Trang trÆ°á»›c
        </button>
        
        <div class="page-numbers">
          <button 
            *ngFor="let page of pageNumbers" 
            (click)="goToPage(page)"
            [class.active]="page === currentPage"
            class="btn page-btn">
            {{ page + 1 }}
          </button>
        </div>
        
        <button 
          (click)="nextPage()" 
          [disabled]="!hasNextPage"
          class="btn pagination-btn">
          Trang sau â†’
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== MODALS ==================== -->
  


  <!-- Treatment Guide Modal -->
  <div *ngIf="selectedTreatmentGuide" class="modal-overlay" (click)="closeTreatmentGuide()">
    <div class="modal-content wide-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 style="font-size: 2rem; color: #388e3c; font-weight: 700;">ğŸ’Š HÆ°á»›ng dáº«n Ä‘iá»u trá»‹: {{ selectedTreatmentGuide.diseaseName }}</h3>
        <button (click)="closeTreatmentGuide()" class="modal-close">Ã—</button>
      </div>
      <div class="modal-body" style="padding: 2rem 2.5rem;">
        <div *ngIf="selectedTreatmentGuide.severity" class="treatment-section" style="margin-bottom: 2rem;">
          <span style="font-size: 1.1rem; font-weight: 600; color: #ff9800; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.5rem;">âš ï¸</span> Má»©c Ä‘á»™ nghiÃªm trá»ng:
            <span class="severity-badge" style="margin-left: 0.5rem; font-size: 1.1rem; padding: 0.2rem 1.2rem;">{{ selectedTreatmentGuide.severity }}</span>
          </span>
        </div>
        <div *ngIf="selectedTreatmentGuide.estimatedDuration" class="treatment-section" style="margin-bottom: 1.5rem;">
          <span style="font-size: 1.1rem; font-weight: 600; color: #6c63ff; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.3rem;">â±ï¸</span> Thá»i gian Ä‘iá»u trá»‹ dá»± kiáº¿n
          </span>
          <div style="margin-left: 2.2rem; margin-top: 0.3rem;">{{ selectedTreatmentGuide.estimatedDuration }}</div>
        </div>
        <div *ngIf="selectedTreatmentGuide.successRate" class="treatment-section" style="margin-bottom: 1.5rem;">
          <span style="font-size: 1.1rem; font-weight: 600; color: #222; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.3rem;">ğŸ“ˆ</span> Tá»· lá»‡ thÃ nh cÃ´ng
          </span>
          <div style="margin-left: 2.2rem; margin-top: 0.3rem;">{{ selectedTreatmentGuide.successRate }}</div>
        </div>
        <div *ngIf="selectedTreatmentGuide.steps && selectedTreatmentGuide.steps.length" class="treatment-section" style="margin-bottom: 1.5rem;">
          <span style="font-size: 1.1rem; font-weight: 600; color: #009688; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.3rem;">ğŸ“</span> CÃ¡c bÆ°á»›c Ä‘iá»u trá»‹
          </span>
          <ol style="margin-left: 2.2rem; margin-top: 0.3rem;">
            <li *ngFor="let step of selectedTreatmentGuide.steps">{{ step }}</li>
          </ol>
        </div>
        <div *ngIf="selectedTreatmentGuide.requiredProducts && selectedTreatmentGuide.requiredProducts.length" class="treatment-section" style="margin-bottom: 1.5rem;">
          <span style="font-size: 1.1rem; font-weight: 600; color: #d84315; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.3rem;">ğŸ’Š</span> Sáº£n pháº©m/thuá»‘c cáº§n thiáº¿t
          </span>
          <ul style="margin-left: 2.2rem; margin-top: 0.3rem;">
            <li *ngFor="let prod of selectedTreatmentGuide.requiredProducts">{{ prod }}</li>
          </ul>
        </div>
        <div *ngIf="selectedTreatmentGuide.precautions && selectedTreatmentGuide.precautions.length" class="treatment-section" style="margin-bottom: 1.5rem;">
          <span style="font-size: 1.1rem; font-weight: 600; color: #222; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.3rem;">ğŸ›¡ï¸</span> LÆ°u Ã½/PhÃ²ng ngá»«a
          </span>
          <ul style="margin-left: 2.2rem; margin-top: 0.3rem;">
            <li *ngFor="let p of selectedTreatmentGuide.precautions">{{ p }}</li>
          </ul>
        </div>
        <div *ngIf="selectedTreatmentGuide.followUpSchedule" class="treatment-section" style="margin-bottom: 1.5rem;">
          <span style="font-size: 1.1rem; font-weight: 600; color: #3f51b5; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.3rem;">ğŸ“…</span> Lá»‹ch kiá»ƒm tra láº¡i
          </span>
          <div style="margin-left: 2.2rem; margin-top: 0.3rem;">{{ selectedTreatmentGuide.followUpSchedule }}</div>
        </div>
        <div *ngIf="selectedTreatmentGuide.expertNotes" class="treatment-section" style="margin-bottom: 1.5rem;">
          <span style="font-size: 1.1rem; font-weight: 600; color: #607d8b; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.3rem;">ğŸ‘¨â€âš•ï¸</span> Ghi chÃº chuyÃªn gia
          </span>
          <div style="margin-left: 2.2rem; margin-top: 0.3rem;">{{ selectedTreatmentGuide.expertNotes }}</div>
        </div>
      </div>
      <div class="modal-footer" style="padding: 1.5rem 2.5rem;">
        <button (click)="closeTreatmentGuide()" class="btn primary" style="min-width: 120px; font-size: 1.1rem;">âœ… ÄÃ£ hiá»ƒu</button>
        <button (click)="closeTreatmentGuide()" class="btn secondary" style="min-width: 120px; font-size: 1.1rem;">âœ• ÄÃ³ng</button>
      </div>
    </div>
  </div>
<style>
.wide-modal {
  max-width: 600px !important;
  min-width: 420px;
  border-radius: 18px;
}
.modal-content {
  box-shadow: 0 8px 32px 0 rgba(60, 60, 60, 0.18);
}
.severity-badge {
  border-radius: 16px;
  border: 1.5px solid #ff9800;
  background: #fffbe6;
  color: #ff9800;
  font-weight: 600;
  padding: 0.2rem 1.2rem;
  font-size: 1.1rem;
  display: inline-block;
}
.treatment-section {
  margin-bottom: 1.5rem;
}
</style>
</div>
