<div class="container">
  <app-top-navigator></app-top-navigator>
  
  <!-- Header -->
  <div class="header">
    <h1>üî¨ Ph√°t Hi·ªán B·ªánh C√¢y Tr·ªìng</h1>
    <p class="subtitle">S·ª≠ d·ª•ng AI ƒë·ªÉ ch·∫©n ƒëo√°n v√† ƒëi·ªÅu tr·ªã b·ªánh c√¢y tr·ªìng m·ªôt c√°ch ch√≠nh x√°c</p>
  </div>
  <!-- Navigation Tabs -->
  <div class="nav-tabs">
    <button 
      [class.active]="activeTab === 'image'"
      (click)="setActiveTab('image')"
      class="tab-btn">
      üì∑ Ph√°t hi·ªán qua ·∫£nh
    </button>
    <button 
      [class.active]="activeTab === 'symptoms'"
      (click)="setActiveTab('symptoms')"
      class="tab-btn">
      üîç Ph√°t hi·ªán qua tri·ªáu ch·ª©ng
    </button>
    <button 
      [class.active]="activeTab === 'history'"
      (click)="setActiveTab('history')"
      class="tab-btn">
      üìã L·ªãch s·ª≠ ph√°t hi·ªán
    </button>
    <button 
      [class.active]="activeTab === 'library'"
      (click)="setActiveTab('library')"
      class="tab-btn">
      üìö Th∆∞ vi·ªán b·ªánh
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    
    <!-- ==================== IMAGE DETECTION TAB ==================== -->
    @if (activeTab === 'image') {
      <div class="tab-panel">
        <div class="detection-card">
          <h2>üì∑ Ph√°t hi·ªán b·ªánh qua h√¨nh ·∫£nh</h2>
          <p class="card-description">
            T·∫£i l√™n ·∫£nh c√¢y b·ªã b·ªánh ƒë·ªÉ AI ph√¢n t√≠ch v√† ch·∫©n ƒëo√°n
          </p>

          <!-- Image Upload Area -->
          <div class="image-upload-area">
            <input 
              #imageInput
              type="file" 
              accept="image/*" 
              (change)="onImageSelected($event)"
              hidden>
            
            <div class="upload-placeholder" (click)="imageInput.click()">
              @if (!selectedImage && !imagePreviewUrl) {
                <div class="upload-icon">üì∑</div>
              }
              @if (imagePreviewUrl) {
                <img [src]="imagePreviewUrl" alt="Preview" class="image-preview">
              }
              @if (!selectedImage && !imagePreviewUrl) {
                <p class="upload-text">
                  Click ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c k√©o th·∫£ ·∫£nh v√†o ƒë√¢y
                  <span style="color: #888; font-size: 13px; display: block;">Dung l∆∞·ª£ng t·ªëi ƒëa: 20MB</span>
                </p>
              }
              @if (imagePreviewUrl) {
                <p class="upload-text">Click ƒë·ªÉ thay ƒë·ªïi ·∫£nh</p>
              }
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button 
              (click)="detectDiseaseFromImage()"
              [disabled]="!selectedImage || isDetectingFromImage"
              class="btn primary large">
              @if (!isDetectingFromImage) {<span>üîç Ph√°t hi·ªán b·ªánh</span>}
              @if (isDetectingFromImage) {<span>‚è≥ ƒêang ph√¢n t√≠ch...</span>}
            </button>
            
            @if (selectedImage || imageDetectionResult) {
              <button (click)="clearImageDetection()" class="btn secondary">üóëÔ∏è X√≥a</button>
            }
          </div>

          <!-- Detection Result -->
          @if (imageDetectionResult) {
            <div class="detection-result">
              <h3>üéØ K·∫øt qu·∫£ ph√°t hi·ªán</h3>
              <div class="result-content">
                <div class="result-header">
                  <h4>{{ imageDetectionResult.detectedDisease }}</h4>
                  <span class="confidence-badge">
                    ƒê·ªô tin c·∫≠y: {{ (imageDetectionResult.confidenceScore * 100).toFixed(0) }}%
                  </span>
                </div>
                <div class="result-details">
                  <div class="detail-item">
                    <strong>M·ª©c ƒë·ªô nghi√™m tr·ªçng:</strong>
                    <span class="severity-badge" [style.background-color]="getSeverityColor(imageDetectionResult.severity)">
                      {{ imageDetectionResult.severity }}
                    </span>
                  </div>
                  <div class="detail-item">
                    <strong>Tri·ªáu ch·ª©ng:</strong>
                    <p>{{ imageDetectionResult.symptoms }}</p>
                  </div>
                  <div class="detail-item">
                    <strong>ƒêi·ªÅu tr·ªã ƒë∆∞·ª£c khuy·∫øn ngh·ªã:</strong>
                    <p>{{ imageDetectionResult.recommendedTreatment }}</p>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- ==================== SYMPTOMS DETECTION TAB ==================== -->
    @if (activeTab === 'symptoms') {
      <div class="tab-panel">
        <div class="detection-card">
          <h2>üîç Ph√°t hi·ªán b·ªánh qua tri·ªáu ch·ª©ng</h2>
          <p class="card-description">
            M√¥ t·∫£ tri·ªáu ch·ª©ng c√¢y b·ªã b·ªánh ƒë·ªÉ AI ph√¢n t√≠ch v√† ch·∫©n ƒëo√°n
          </p>

          <!-- Symptoms Form -->
          <form [formGroup]="symptomsForm" class="symptoms-form">
            <div class="form-group">
              <label for="symptoms">M√¥ t·∫£ tri·ªáu ch·ª©ng b·ªánh *</label>
              <textarea 
                id="symptoms" 
                formControlName="symptoms" 
                placeholder="M√¥ t·∫£ chi ti·∫øt c√°c tri·ªáu ch·ª©ng b·∫°n quan s√°t th·∫•y tr√™n c√¢y..."
                rows="6"
                class="form-control">
              </textarea>
              @if (isFieldInvalid('symptoms')) {
                <div class="error-message">
                  {{ getFieldError('symptoms') }}
                </div>
              }
              <small class="form-help">
                V√≠ d·ª•: "C√¢y hoa h·ªìng c·ªßa t√¥i th√¢n m·ªÅm, ƒëen, c√¢y g√£y" ho·∫∑c "L√° c√¢y xu·∫•t hi·ªán ƒë·ªëm v√†ng, kh√¥ h√©o"
              </small>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
              <button 
                (click)="detectDiseaseFromSymptoms()"
                [disabled]="symptomsForm.invalid || isDetectingFromSymptoms"
                class="btn primary large">
                @if (!isDetectingFromSymptoms) {<span>üîç Ph√¢n t√≠ch tri·ªáu ch·ª©ng</span>}
                @if (isDetectingFromSymptoms) {<span>‚è≥ ƒêang ph√¢n t√≠ch...</span>}
              </button>
            </div>
          </form>

          <!-- Detection Result -->
          @if (symptomsDetectionResult) {
            <div class="detection-result">
              <h3>üéØ K·∫øt qu·∫£ ph√¢n t√≠ch tri·ªáu ch·ª©ng</h3>
              <div class="result-content">
                <div class="result-header">
                  <h4>{{ symptomsDetectionResult.detectedDisease }}</h4>
                  <span class="confidence-badge">
                    ƒê·ªô tin c·∫≠y: {{ (symptomsDetectionResult.confidenceScore * 100) | number:'1.0-0' }}%
                  </span>
                </div>
                <div class="result-details">
                  <div class="detail-item">
                    <strong>M·ª©c ƒë·ªô nghi√™m tr·ªçng:</strong>
                    <span class="severity-badge" [style.background-color]="getSeverityColor(symptomsDetectionResult.severity)">
                      {{ getSeverityText(symptomsDetectionResult.severity) }}
                    </span>
                  </div>
                  <div class="detail-item">
                    <strong>Tri·ªáu ch·ª©ng:</strong>
                    <p>{{ symptomsDetectionResult.symptoms }}</p>
                  </div>
                  <div class="detail-item">
                    <strong>ƒêi·ªÅu tr·ªã ƒë∆∞·ª£c khuy·∫øn ngh·ªã:</strong>
                    <p>{{ symptomsDetectionResult.recommendedTreatment }}</p>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- ==================== HISTORY TAB ==================== -->
    @if (activeTab === 'history') {
      <div class="tab-panel">
        <!-- Loading State -->
        @if (isLoadingHistory) {
          <div class="loading-state">
            <div class="spinner"></div>
            <p>ƒêang t·∫£i l·ªãch s·ª≠...</p>
          </div>
        }

        <!-- Empty State -->
        @if (!isLoadingHistory && detectionHistory.length === 0) {
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <p>Ch∆∞a c√≥ l·ªãch s·ª≠ ph√°t hi·ªán b·ªánh n√†o</p>
            <p class="empty-subtitle">H√£y th·ª≠ ph√°t hi·ªán b·ªánh qua ·∫£nh ho·∫∑c tri·ªáu ch·ª©ng ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
          </div>
        }

        <!-- History List -->
        @if (!isLoadingHistory && detectionHistory.length > 0) {
          <div class="history-list modern">
            @for (record of detectionHistory; track record) {
              <div class="history-card">
                <div class="history-card-header">
                  <div>
                    <span class="history-disease-name">{{ record.detectedDisease }}</span>
                    <span class="history-severity-badge" [ngClass]="'sev-' + record.severity.toLowerCase()">
                      {{ getSeverityText(record.severity) }}
                    </span>
                  </div>
                </div>
                <div class="history-card-body">
                  <div class="history-row">
                    <span class="history-label">Tri·ªáu ch·ª©ng:</span>
                    <span class="history-value">{{ record.symptoms }}</span>
                  </div>
                  <div class="history-row">
                    <span class="history-label">ƒêi·ªÅu tr·ªã:</span>
                    <span class="history-value">{{ record.recommendedTreatment }}</span>
                  </div>
                  <div class="history-row">
                    <span class="history-label">ƒê·ªô tin c·∫≠y:</span>
                    <span class="history-value">{{ (record.confidenceScore).toFixed(0) }}%</span>
                  </div>
                  <div class="history-row">
                    <span class="history-label">Th·ªùi gian:</span>
                    <span class="history-value">{{ record.detectedAt | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  @if (record.expertNotes) {
                    <div class="history-row">
                      <span class="history-label">Ghi ch√∫ chuy√™n gia:</span>
                      <span class="history-value">{{ record.expertNotes }}</span>
                    </div>
                  }
                  @if (record.treatmentResult) {
                    <div class="history-row">
                      <span class="history-label">KQ ƒëi·ªÅu tr·ªã:</span>
                      <span class="history-value">{{ record.treatmentResult }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- ==================== LIBRARY TAB ==================== -->
    @if (activeTab === 'library') {
      <div class="tab-panel">
        <div class="library-header">
          <h3>üìö Th∆∞ vi·ªán b·ªánh th∆∞·ªùng g·∫∑p</h3>
          <p class="card-description">
            Kh√°m ph√° c∆° s·ªü d·ªØ li·ªáu to√†n di·ªán v·ªÅ c√°c b·ªánh c√¢y tr·ªìng ph·ªï bi·∫øn, 
            bao g·ªìm tri·ªáu ch·ª©ng, ph∆∞∆°ng ph√°p ƒëi·ªÅu tr·ªã v√† bi·ªán ph√°p ph√≤ng ng·ª´a
          </p>
        </div>

        <!-- Loading State -->
        @if (isLoadingLibrary) {
          <div class="loading-state">
            <div class="spinner"></div>
            <p>ƒêang t·∫£i th∆∞ vi·ªán b·ªánh...</p>
          </div>
        }

        <!-- Filter Controls -->
        @if (!isLoadingLibrary) {
          <div class="filter-controls" [formGroup]="filterForm">
            <div class="filter-group">
              <label>Lo·∫°i b·ªánh:</label>
              <select formControlName="selectedCategory" class="form-control">
                @for (category of categories; track category) {
                  <option [value]="category">{{ category }}</option>
                }
              </select>
            </div>
          </div>
        }

        <!-- Results Summary -->
        @if (!isLoadingLibrary && filteredDiseases.length > 0) {
          <div class="results-summary">
            <p>
              üéØ Hi·ªÉn th·ªã {{ (currentPage * pageSize) + 1 }}-{{ (currentPage + 1) * pageSize > totalItems ? totalItems : (currentPage + 1) * pageSize }} 
              trong t·ªïng s·ªë {{ totalItems }} b·ªánh ƒë∆∞·ª£c t√¨m th·∫•y
            </p>
          </div>
        }

        <!-- Empty State -->
        @if (!isLoadingLibrary && filteredDiseases.length === 0) {
          <div class="empty-state">
            <div class="empty-icon">üîç</div>
            <p>Kh√¥ng t√¨m th·∫•y b·ªánh n√†o ph√π h·ª£p v·ªõi lo·∫°i ƒë√£ ch·ªçn</p>
          </div>
        }

        <!-- Disease Grid -->
        @if (!isLoadingLibrary && filteredDiseases.length > 0) {
          <div class="disease-grid">
            @for (disease of paginatedDiseases; track disease) {
              <div class="disease-card" (click)="selectDisease(disease)">
                <div class="disease-card-header">
                  <div class="disease-title-row">
                    <span class="disease-name">{{ disease.name }}</span>
                    <span class="severity-badge" [ngClass]="'sev-' + disease.severity.toLowerCase()">{{ getSeverityText(disease.severity) }}</span>
                  </div>
                  <div class="disease-meta-row">
                    @if (disease.commonality === 1) {<span class="common-badge">‚≠ê Ph·ªï bi·∫øn</span>}
                  </div>
                </div>
                <div class="disease-card-body">
                  <div class="disease-scientific">{{ disease.scientificName }}</div>
                  <div class="disease-symptoms">
                    <span class="disease-label">üåø Tri·ªáu ch·ª©ng:</span>
                    <ul>
                      @for (symptom of disease.symptoms; track symptom) {
                        <li>{{ symptom }}</li>
                      }
                    </ul>
                  </div>
                  <div class="disease-plants">
                    <span class="disease-label">üå± C√¢y b·ªã ·∫£nh h∆∞·ªüng:</span>
                    <div class="plant-tags">
                      @for (plant of disease.affectedPlants; track plant) {
                        <span class="plant-tag">{{ plant }}</span>
                      }
                    </div>
                  </div>
                </div>
                <div class="disease-actions">
                  <button class="btn secondary" (click)="loadTreatmentGuide(disease.name); $event.stopPropagation()">
                    üíä H∆∞·ªõng d·∫´n ƒëi·ªÅu tr·ªã
                  </button>
                </div>
              </div>
            }
          </div>

          <!-- Pagination -->
          @if (!isLoadingLibrary && totalPages > 1) {
            <div class="pagination">
              <button 
                (click)="prevPage()" 
                [disabled]="!hasPrevPage"
                class="btn pagination-btn">
                ‚Üê Trang tr∆∞·ªõc
              </button>
              
              <div class="page-numbers">
                @for (page of pageNumbers; track page) {
                  <button (click)="goToPage(page)" [class.active]="page === currentPage" class="btn page-btn">{{ page + 1 }}</button>
                }
              </div>
              
              <button 
                (click)="nextPage()" 
                [disabled]="!hasNextPage"
                class="btn pagination-btn">
                Trang sau ‚Üí
              </button>
            </div>
          }
        }
      </div>
    }
  </div>

  <!-- ==================== MODALS ==================== -->
  
  <!-- Treatment Guide Modal - Modern Design -->
  @if (selectedTreatmentGuide) {
    <div class="treatment-modal-overlay" (click)="closeTreatmentGuide()">
      <div class="treatment-modal" (click)="$event.stopPropagation()">
        <!-- Modal Header -->
        <div class="treatment-header">
          <div class="treatment-header-content">
            <div class="treatment-icon">üíä</div>
            <div class="treatment-title">
              <h3>H∆∞·ªõng d·∫´n ƒëi·ªÅu tr·ªã</h3>
              <p>{{ selectedTreatmentGuide.diseaseName }}</p>
            </div>
          </div>
          <button (click)="closeTreatmentGuide()" class="treatment-close">√ó</button>
        </div>

        <!-- Modal Body -->
        <div class="treatment-body">
          <!-- Key Info Cards -->
          <div class="treatment-key-info">
            @if (selectedTreatmentGuide.estimatedDuration) {
              <div class="info-card duration-card">
                <div class="info-icon">‚è±Ô∏è</div>
                <div class="info-content">
                  <span class="info-label">Th·ªùi gian ƒëi·ªÅu tr·ªã</span>
                  <span class="info-value">{{ selectedTreatmentGuide.estimatedDuration }}</span>
                </div>
              </div>
            }
            
            @if (selectedTreatmentGuide.successRate) {
              <div class="info-card success-card">
                <div class="info-icon">üìà</div>
                <div class="info-content">
                  <span class="info-label">T·ª∑ l·ªá th√†nh c√¥ng</span>
                  <span class="info-value success-rate">{{ selectedTreatmentGuide.successRate }}</span>
                </div>
              </div>
            }
          </div>

          <!-- Treatment Steps -->
          @if (selectedTreatmentGuide.steps && selectedTreatmentGuide.steps.length) {
            <div class="treatment-section">
              <div class="section-header">
                <span class="section-icon">üîß</span>
                <h4>C√°c b∆∞·ªõc ƒëi·ªÅu tr·ªã</h4>
              </div>
              <div class="steps-container">
                @for (step of selectedTreatmentGuide.steps; track step; let i = $index) {
                  <div class="treatment-step">
                    <div class="step-number">{{ i + 1 }}</div>
                    <div class="step-content">{{ step }}</div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Required Products -->
          @if (selectedTreatmentGuide.requiredProducts && selectedTreatmentGuide.requiredProducts.length) {
            <div class="treatment-section">
              <div class="section-header">
                <span class="section-icon">üíä</span>
                <h4>S·∫£n ph·∫©m/thu·ªëc c·∫ßn thi·∫øt</h4>
              </div>
              <div class="products-grid">
                @for (product of selectedTreatmentGuide.requiredProducts; track product) {
                  <div class="product-item">
                    <span class="product-icon">üß™</span>
                    <span class="product-name">{{ product }}</span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Precautions -->
          @if (selectedTreatmentGuide.precautions && selectedTreatmentGuide.precautions.length) {
            <div class="treatment-section">
              <div class="section-header">
                <span class="section-icon">üõ°Ô∏è</span>
                <h4>L∆∞u √Ω/Ph√≤ng ng·ª´a</h4>
              </div>
              <div class="precautions-list">
                @for (precaution of selectedTreatmentGuide.precautions; track precaution) {
                  <div class="precaution-item">
                    <span class="precaution-icon">‚ö†Ô∏è</span>
                    <span class="precaution-text">{{ precaution }}</span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Follow-up & Expert Notes -->
          <div class="additional-info">
            @if (selectedTreatmentGuide.followUpSchedule) {
              <div class="info-section followup-section">
                <div class="info-section-header">
                  <span class="info-section-icon">üìÖ</span>
                  <h5>L·ªãch ki·ªÉm tra l·∫°i</h5>
                </div>
                <div class="followup-content">{{ selectedTreatmentGuide.followUpSchedule }}</div>
              </div>
            }
            @if (selectedTreatmentGuide.expertNotes) {
              <div class="info-section expert-section">
                <div class="info-section-header">
                  <span class="info-section-icon">üë®‚Äç‚öïÔ∏è</span>
                  <h5>Ghi ch√∫ chuy√™n gia</h5>
                </div>
                <div class="expert-content">{{ selectedTreatmentGuide.expertNotes }}</div>
              </div>
            }
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="treatment-footer">
          <button (click)="closeTreatmentGuide()" class="btn-treatment primary">
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>
  }
</div>

