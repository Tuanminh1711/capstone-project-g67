<div class="container">
  <app-top-navigator></app-top-navigator>
  
  <!-- Header -->
  <div class="header">
    <h1>üî¨ Ph√°t Hi·ªán B·ªánh C√¢y Tr·ªìng</h1>
    <p class="subtitle">S·ª≠ d·ª•ng AI ƒë·ªÉ ch·∫©n ƒëo√°n v√† ƒëi·ªÅu tr·ªã b·ªánh c√¢y tr·ªìng m·ªôt c√°ch ch√≠nh x√°c</p>
  </div>

  <!-- Alert Messages -->
  <div *ngIf="errorMessage" class="alert error">
    <span class="alert-icon">‚ö†Ô∏è</span>
    {{ errorMessage }}
  </div>
  
  <div *ngIf="successMessage" class="alert success">
    <span class="alert-icon">‚úÖ</span>
    {{ successMessage }}
  </div>

  <!-- Navigation Tabs -->
  <div class="nav-tabs">
    <button 
      [class.active]="activeTab === 'image'"
      (click)="setActiveTab('image')"
      class="tab-btn">
      üì∑ Ph√°t hi·ªán qua ·∫£nh
    </button>
    <button 
      [class.active]="activeTab === 'symptoms'"
      (click)="setActiveTab('symptoms')"
      class="tab-btn">
      üîç Ph√°t hi·ªán qua tri·ªáu ch·ª©ng
    </button>
    <button 
      [class.active]="activeTab === 'history'"
      (click)="setActiveTab('history')"
      class="tab-btn">
      üìã L·ªãch s·ª≠ ph√°t hi·ªán
    </button>
    <button 
      [class.active]="activeTab === 'library'"
      (click)="setActiveTab('library')"
      class="tab-btn">
      üìö Th∆∞ vi·ªán b·ªánh
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    
    <!-- ==================== IMAGE DETECTION TAB ==================== -->
    <div *ngIf="activeTab === 'image'" class="tab-panel">
      <div class="detection-card">
        <h2>üì∑ Ph√°t hi·ªán b·ªánh qua h√¨nh ·∫£nh</h2>
        <p class="card-description">
          T·∫£i l√™n ·∫£nh c√¢y b·ªã b·ªánh ƒë·ªÉ AI ph√¢n t√≠ch v√† ch·∫©n ƒëo√°n
        </p>

        <!-- Image Upload Area -->
        <div class="image-upload-area">
          <input 
            #imageInput
            type="file" 
            accept="image/*" 
            (change)="onImageSelected($event)"
            hidden>
          
          <div class="upload-placeholder" (click)="imageInput.click()">
            <div *ngIf="!selectedImage && !imagePreviewUrl" class="upload-icon">
              üì∑
            </div>
            <img 
              *ngIf="imagePreviewUrl" 
              [src]="imagePreviewUrl" 
              alt="Preview" 
              class="image-preview">
            
            <p *ngIf="!selectedImage && !imagePreviewUrl" class="upload-text">
              Click ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c k√©o th·∫£ ·∫£nh v√†o ƒë√¢y
              <span style="color: #888; font-size: 13px; display: block;">Dung l∆∞·ª£ng t·ªëi ƒëa: 20MB</span>
            </p>
            <p *ngIf="imagePreviewUrl" class="upload-text">
              Click ƒë·ªÉ thay ƒë·ªïi ·∫£nh
            </p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button 
            (click)="detectDiseaseFromImage()"
            [disabled]="!selectedImage || isDetectingFromImage"
            class="btn primary large">
            <span *ngIf="!isDetectingFromImage">üîç Ph√°t hi·ªán b·ªánh</span>
            <span *ngIf="isDetectingFromImage">‚è≥ ƒêang ph√¢n t√≠ch...</span>
          </button>
          
          <button 
            *ngIf="selectedImage || imageDetectionResult"
            (click)="clearImageDetection()"
            class="btn secondary">
            üóëÔ∏è X√≥a
          </button>
        </div>

        <!-- Detection Result -->
        <div *ngIf="imageDetectionResult" class="detection-result">
          <h3>üéØ K·∫øt qu·∫£ ph√°t hi·ªán</h3>
          <div class="result-content">
            <div class="result-header">
              <h4>{{ imageDetectionResult.detectedDisease }}</h4>
              <span class="confidence-badge">
                ƒê·ªô tin c·∫≠y: {{ (imageDetectionResult.confidenceScore * 100).toFixed(0) }}%
              </span>
            </div>
            
            <div class="result-details">
              <div class="detail-item">
                <strong>M·ª©c ƒë·ªô nghi√™m tr·ªçng:</strong>
                <span class="severity-badge" [style.background-color]="getSeverityColor(imageDetectionResult.severity)">
                  {{ imageDetectionResult.severity }}
                </span>
              </div>
              
              <div class="detail-item">
                <strong>Tri·ªáu ch·ª©ng:</strong>
                <p>{{ imageDetectionResult.symptoms }}</p>
              </div>
              
              <div class="detail-item">
                <strong>ƒêi·ªÅu tr·ªã ƒë∆∞·ª£c khuy·∫øn ngh·ªã:</strong>
                <p>{{ imageDetectionResult.recommendedTreatment }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== SYMPTOMS DETECTION TAB ==================== -->
    <div *ngIf="activeTab === 'symptoms'" class="tab-panel">
      <div class="detection-card">
        <h2>üîç Ph√°t hi·ªán b·ªánh qua tri·ªáu ch·ª©ng</h2>
        <p class="card-description">
          M√¥ t·∫£ tri·ªáu ch·ª©ng c√¢y b·ªã b·ªánh ƒë·ªÉ AI ph√¢n t√≠ch v√† ch·∫©n ƒëo√°n
        </p>

        <!-- Symptoms Form -->
        <form [formGroup]="symptomsForm" class="symptoms-form">
          <div class="form-group">
            <label for="symptoms">M√¥ t·∫£ tri·ªáu ch·ª©ng b·ªánh *</label>
            <textarea 
              id="symptoms" 
              formControlName="symptoms" 
              placeholder="M√¥ t·∫£ chi ti·∫øt c√°c tri·ªáu ch·ª©ng b·∫°n quan s√°t th·∫•y tr√™n c√¢y..."
              rows="6"
              class="form-control">
            </textarea>
            <div *ngIf="isFieldInvalid('symptoms')" class="error-message">
              {{ getFieldError('symptoms') }}
            </div>
            <small class="form-help">
              V√≠ d·ª•: "C√¢y hoa h·ªìng c·ªßa t√¥i th√¢n m·ªÅm, ƒëen, c√¢y g√£y" ho·∫∑c "L√° c√¢y xu·∫•t hi·ªán ƒë·ªëm v√†ng, kh√¥ h√©o"
            </small>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button 
              (click)="detectDiseaseFromSymptoms()"
              [disabled]="symptomsForm.invalid || isDetectingFromSymptoms"
              class="btn primary large">
              <span *ngIf="!isDetectingFromSymptoms">üîç Ph√¢n t√≠ch tri·ªáu ch·ª©ng</span>
              <span *ngIf="isDetectingFromSymptoms">‚è≥ ƒêang ph√¢n t√≠ch...</span>
            </button>
          </div>
        </form>

        <!-- Detection Result -->
        <div *ngIf="symptomsDetectionResult" class="detection-result">
          <h3>üéØ K·∫øt qu·∫£ ph√¢n t√≠ch tri·ªáu ch·ª©ng</h3>
          <div class="result-content">
            <div class="result-header">
              <h4>{{ symptomsDetectionResult.detectedDisease }}</h4>
              <span class="confidence-badge">
                ƒê·ªô tin c·∫≠y: {{ (symptomsDetectionResult.confidenceScore * 100) | number:'1.0-0' }}%
              </span>
            </div>
            
            <div class="result-details">
              <div class="detail-item">
                <strong>M·ª©c ƒë·ªô nghi√™m tr·ªçng:</strong>
                <span class="severity-badge" [style.background-color]="getSeverityColor(symptomsDetectionResult.severity)">
                  {{ getSeverityText(symptomsDetectionResult.severity) }}
                </span>
              </div>
              
              <div class="detail-item">
                <strong>Tri·ªáu ch·ª©ng:</strong>
                <p>{{ symptomsDetectionResult.symptoms }}</p>
              </div>
              
              <div class="detail-item">
                <strong>ƒêi·ªÅu tr·ªã ƒë∆∞·ª£c khuy·∫øn ngh·ªã:</strong>
                <p>{{ symptomsDetectionResult.recommendedTreatment }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== HISTORY TAB ==================== -->
    <div *ngIf="activeTab === 'history'" class="tab-panel">
      <!-- Hidden history header section -->
      <!-- <div class="history-header">
        <h3>üìã L·ªãch s·ª≠ ph√°t hi·ªán b·ªánh</h3>
        <p>T·ªïng c·ªông {{ totalHistoryItems }} l·∫ßn ph√°t hi·ªán</p>
        <button (click)="refreshCurrentTab()" class="btn primary small">
          üîÑ L√†m m·ªõi l·ªãch s·ª≠
        </button>
      </div> -->

      <!-- Loading State -->
      <div *ngIf="isLoadingHistory" class="loading-state">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i l·ªãch s·ª≠...</p>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isLoadingHistory && detectionHistory.length === 0" class="empty-state">
        <div class="empty-icon">üìã</div>
        <p>Ch∆∞a c√≥ l·ªãch s·ª≠ ph√°t hi·ªán b·ªánh n√†o</p>
        <p class="empty-subtitle">H√£y th·ª≠ ph√°t hi·ªán b·ªánh qua ·∫£nh ho·∫∑c tri·ªáu ch·ª©ng ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
      </div>

      <!-- History List -->
      <div *ngIf="!isLoadingHistory && detectionHistory.length > 0" class="history-list modern">
        <div *ngFor="let record of detectionHistory" class="history-card">
          <div class="history-card-header">
            <div>
              <span class="history-disease-name">{{ record.detectedDisease }}</span>
              <span class="history-severity-badge" [ngClass]="'sev-' + record.severity.toLowerCase()">
                {{ getSeverityText(record.severity) }}
              </span>
            </div>
            <!-- Hidden detection method -->
            <!-- <div class="history-method">
              {{ record.detectionMethod === 'IMAGE' ? 'Qua ·∫£nh' : 'Qua tri·ªáu ch·ª©ng' }}
            </div> -->
          </div>
          <div class="history-card-body">
            <div class="history-row">
              <span class="history-label">Tri·ªáu ch·ª©ng:</span>
              <span class="history-value">{{ record.symptoms }}</span>
            </div>
            <div class="history-row">
              <span class="history-label">ƒêi·ªÅu tr·ªã:</span>
              <span class="history-value">{{ record.recommendedTreatment }}</span>
            </div>
            <div class="history-row">
              <span class="history-label">ƒê·ªô tin c·∫≠y:</span>
              <span class="history-value">{{ (record.confidenceScore * 100).toFixed(0) }}%</span>
            </div>
            <!-- Hidden status and AI version -->
            <!-- <div class="history-row">
              <span class="history-label">Tr·∫°ng th√°i:</span>
              <span class="history-value">{{ record.status === 'DETECTED' ? 'ƒê√£ ph√°t hi·ªán' : record.status }}</span>
              <span *ngIf="record.isConfirmed" class="history-confirmed">ƒê√£ x√°c nh·∫≠n</span>
            </div> -->
            <div class="history-row">
              <span class="history-label">Th·ªùi gian:</span>
              <span class="history-value">{{ record.detectedAt | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <!-- <div class="history-row">
              <span class="history-label">Phi√™n b·∫£n AI:</span>
              <span class="history-value">{{ record.aiModelVersion }}</span>
            </div> -->
            <div *ngIf="record.expertNotes" class="history-row">
              <span class="history-label">Ghi ch√∫ chuy√™n gia:</span>
              <span class="history-value">{{ record.expertNotes }}</span>
            </div>
            <div *ngIf="record.treatmentResult" class="history-row">
              <span class="history-label">KQ ƒëi·ªÅu tr·ªã:</span>
              <span class="history-value">{{ record.treatmentResult }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== LIBRARY TAB ==================== -->
    <div *ngIf="activeTab === 'library'" class="tab-panel">
      <div class="library-header">
        <h3>üìö Th∆∞ vi·ªán b·ªánh th∆∞·ªùng g·∫∑p</h3>
        <p class="card-description">
          Kh√°m ph√° c∆° s·ªü d·ªØ li·ªáu to√†n di·ªán v·ªÅ c√°c b·ªánh c√¢y tr·ªìng ph·ªï bi·∫øn, 
          bao g·ªìm tri·ªáu ch·ª©ng, ph∆∞∆°ng ph√°p ƒëi·ªÅu tr·ªã v√† bi·ªán ph√°p ph√≤ng ng·ª´a
        </p>
      </div>


      <!-- Loading State -->
      <div *ngIf="isLoadingLibrary" class="loading-state">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i th∆∞ vi·ªán b·ªánh...</p>
      </div>


      <!-- Only show category dropdown for filtering -->
      <div *ngIf="!isLoadingLibrary" class="filter-controls" [formGroup]="filterForm">
        <div class="filter-group">
          <label>Lo·∫°i b·ªánh:</label>
          <select formControlName="selectedCategory" class="form-control">
            <option *ngFor="let category of categories" [value]="category">{{ category }}</option>
          </select>
        </div>
      </div>


  <!-- Advanced Filters removed -->


  <!-- Filtering State removed -->


      <!-- Results Summary -->
      <div *ngIf="!isLoadingLibrary && filteredDiseases.length > 0" class="results-summary">
        <p>
          üéØ Hi·ªÉn th·ªã {{ (currentPage * pageSize) + 1 }}-{{ (currentPage + 1) * pageSize > totalItems ? totalItems : (currentPage + 1) * pageSize }} 
          trong t·ªïng s·ªë {{ totalItems }} b·ªánh ƒë∆∞·ª£c t√¨m th·∫•y
        </p>
      </div>


      <!-- Empty State -->
      <div *ngIf="!isLoadingLibrary && filteredDiseases.length === 0" class="empty-state">
        <div class="empty-icon">üîç</div>
        <p>Kh√¥ng t√¨m th·∫•y b·ªánh n√†o ph√π h·ª£p v·ªõi lo·∫°i ƒë√£ ch·ªçn</p>
      </div>

  <!-- Disease Grid -->
  <div *ngIf="!isLoadingLibrary && filteredDiseases.length > 0" class="disease-grid">
        <div *ngFor="let disease of paginatedDiseases" class="disease-card" (click)="selectDisease(disease)">
          <div class="disease-card-header">
            <div class="disease-title-row">
              <span class="disease-name">{{ disease.name }}</span>
              <span class="severity-badge" [ngClass]="'sev-' + disease.severity.toLowerCase()">{{ getSeverityText(disease.severity) }}</span>
            </div>
            <div class="disease-meta-row">
              <span class="common-badge" *ngIf="disease.commonality === 1">‚≠ê Ph·ªï bi·∫øn</span>
            </div>
          </div>
          <div class="disease-card-body">
            <div class="disease-scientific">{{ disease.scientificName }}</div>
            <div class="disease-symptoms">
              <span class="disease-label">üåø Tri·ªáu ch·ª©ng:</span>
              <ul>
                <li *ngFor="let symptom of disease.symptoms">{{ symptom }}</li>
              </ul>
            </div>
            <div class="disease-plants">
              <span class="disease-label">üå± C√¢y b·ªã ·∫£nh h∆∞·ªüng:</span>
              <div class="plant-tags">
                <span *ngFor="let plant of disease.affectedPlants" class="plant-tag">{{ plant }}</span>
              </div>
            </div>
          </div>
          <div class="disease-actions">
            <button class="btn secondary" (click)="loadTreatmentGuide(disease.name); $event.stopPropagation()">
              üíä H∆∞·ªõng d·∫´n ƒëi·ªÅu tr·ªã
            </button>
          </div>
        </div>
      </div>

      <!-- Pagination -->
  <div *ngIf="!isLoadingLibrary && totalPages > 1" class="pagination">
        <button 
          (click)="prevPage()" 
          [disabled]="!hasPrevPage"
          class="btn pagination-btn">
          ‚Üê Trang tr∆∞·ªõc
        </button>
        
        <div class="page-numbers">
          <button 
            *ngFor="let page of pageNumbers" 
            (click)="goToPage(page)"
            [class.active]="page === currentPage"
            class="btn page-btn">
            {{ page + 1 }}
          </button>
        </div>
        
        <button 
          (click)="nextPage()" 
          [disabled]="!hasNextPage"
          class="btn pagination-btn">
          Trang sau ‚Üí
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== MODALS ==================== -->
  


  <!-- Treatment Guide Modal - Modern Design -->
  <div *ngIf="selectedTreatmentGuide" class="treatment-modal-overlay" (click)="closeTreatmentGuide()">
    <div class="treatment-modal" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="treatment-header">
        <div class="treatment-header-content">
          <div class="treatment-icon">üíä</div>
          <div class="treatment-title">
            <h3>H∆∞·ªõng d·∫´n ƒëi·ªÅu tr·ªã</h3>
            <p>{{ selectedTreatmentGuide.diseaseName }}</p>
          </div>
        </div>
        <button (click)="closeTreatmentGuide()" class="treatment-close">√ó</button>
      </div>

      <!-- Modal Body -->
      <div class="treatment-body">
        <!-- Key Info Cards -->
        <div class="treatment-key-info">
          <div *ngIf="selectedTreatmentGuide.estimatedDuration" class="info-card duration-card">
            <div class="info-icon">‚è±Ô∏è</div>
            <div class="info-content">
              <span class="info-label">Th·ªùi gian ƒëi·ªÅu tr·ªã</span>
              <span class="info-value">{{ selectedTreatmentGuide.estimatedDuration }}</span>
            </div>
          </div>
          
          <div *ngIf="selectedTreatmentGuide.successRate" class="info-card success-card">
            <div class="info-icon">üìà</div>
            <div class="info-content">
              <span class="info-label">T·ª∑ l·ªá th√†nh c√¥ng</span>
              <span class="info-value success-rate">{{ selectedTreatmentGuide.successRate }}</span>
            </div>
          </div>
        </div>

        <!-- Treatment Steps -->
        <div *ngIf="selectedTreatmentGuide.steps && selectedTreatmentGuide.steps.length" class="treatment-section">
          <div class="section-header">
            <span class="section-icon">üîß</span>
            <h4>C√°c b∆∞·ªõc ƒëi·ªÅu tr·ªã</h4>
          </div>
          <div class="steps-container">
            <div *ngFor="let step of selectedTreatmentGuide.steps; let i = index" class="treatment-step">
              <div class="step-number">{{ i + 1 }}</div>
              <div class="step-content">{{ step }}</div>
            </div>
          </div>
        </div>

        <!-- Required Products -->
        <div *ngIf="selectedTreatmentGuide.requiredProducts && selectedTreatmentGuide.requiredProducts.length" class="treatment-section">
          <div class="section-header">
            <span class="section-icon">üíä</span>
            <h4>S·∫£n ph·∫©m/thu·ªëc c·∫ßn thi·∫øt</h4>
          </div>
          <div class="products-grid">
            <div *ngFor="let product of selectedTreatmentGuide.requiredProducts" class="product-item">
              <span class="product-icon">üß™</span>
              <span class="product-name">{{ product }}</span>
            </div>
          </div>
        </div>

        <!-- Precautions -->
        <div *ngIf="selectedTreatmentGuide.precautions && selectedTreatmentGuide.precautions.length" class="treatment-section">
          <div class="section-header">
            <span class="section-icon">üõ°Ô∏è</span>
            <h4>L∆∞u √Ω/Ph√≤ng ng·ª´a</h4>
          </div>
          <div class="precautions-list">
            <div *ngFor="let precaution of selectedTreatmentGuide.precautions" class="precaution-item">
              <span class="precaution-icon">‚ö†Ô∏è</span>
              <span class="precaution-text">{{ precaution }}</span>
            </div>
          </div>
        </div>

        <!-- Follow-up & Expert Notes -->
        <div class="additional-info">
          <div *ngIf="selectedTreatmentGuide.followUpSchedule" class="info-section followup-section">
            <div class="info-section-header">
              <span class="info-section-icon">üìÖ</span>
              <h5>L·ªãch ki·ªÉm tra l·∫°i</h5>
            </div>
            <div class="followup-content">{{ selectedTreatmentGuide.followUpSchedule }}</div>
          </div>

          <div *ngIf="selectedTreatmentGuide.expertNotes" class="info-section expert-section">
            <div class="info-section-header">
              <span class="info-section-icon">üë®‚Äç‚öïÔ∏è</span>
              <h5>Ghi ch√∫ chuy√™n gia</h5>
            </div>
            <div class="expert-content">{{ selectedTreatmentGuide.expertNotes }}</div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="treatment-footer">
        <button (click)="closeTreatmentGuide()" class="btn-treatment primary">
          ƒê√≥ng
        </button>
      </div>
    </div>
  </div>

</div>
