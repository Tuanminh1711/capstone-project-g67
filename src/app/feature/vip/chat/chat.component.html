<app-top-navigator></app-top-navigator>

<div class="messenger-container" [class.mobile-view]="isMobile">
  <!-- Mobile Overlay -->
  <div class="mobile-overlay" *ngIf="isMobile && sidebarVisible" (click)="closeSidebarOnMobile()"></div>
  


  <!-- Messenger-style Sidebar -->
  <div class="messenger-sidebar" 
       [class.sidebar-hidden]="isMobile && !sidebarVisible"
       [class.sidebar-visible]="!isMobile || sidebarVisible">
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <h2 class="sidebar-title">
        <i class="fas fa-comments"></i>
        Chats
      </h2>
  <!-- ƒê√£ ·∫©n d·∫•u ... ·ªü header -->
    </div>



    <!-- Community Room Section -->
    <div class="chat-section">
      <div class="section-header">
        <span class="section-title">Ph√≤ng chat chung</span>
      </div>
      <div class="chat-item community-room" [class.active]="!showPrivateChat && !selectedConversation" (click)="switchToCommunityChat(); closeSidebarOnMobile()">
        <div class="chat-avatar community-avatar">
          <i class="fas fa-users"></i>
        </div>
        <div class="chat-info">
          <div class="chat-name">C·ªông ƒë·ªìng PlantCare</div>
          <div class="chat-preview">Ph√≤ng chat d√†nh cho th√†nh vi√™n VIP</div>
        </div>
      </div>
    </div>

    <!-- Experts Section - Ch·ªâ hi·ªÉn th·ªã ·ªü desktop -->
    <div class="chat-section" *ngIf="!isMobile">
      <div class="section-header">
        <span class="section-title">Chuy√™n gia</span>
      </div>
      <div class="experts-list">
        <div class="chat-item expert-item" 
             *ngFor="let expert of experts" 
             (click)="startConversationWithExpert(expert); closeSidebarOnMobile()">
          <div class="chat-avatar expert-avatar">
            <img *ngIf="expert.avatarUrl" 
                 [src]="expert.avatarUrl" 
                 [alt]="expert.fullName || expert.username"
                 class="user-avatar">
            <span *ngIf="!expert.avatarUrl">{{ (expert.fullName || expert.username).charAt(0).toUpperCase() }}</span>
          </div>
          <div class="chat-info">
            <div class="chat-name">{{ expert.fullName || expert.username }}</div>
            <div class="chat-preview expert-badge">
              Chuy√™n gia
            </div>
          </div>
        </div>
      </div>
    </div>
  </div> <!-- End of messenger-sidebar -->

  <!-- Mobile Chat List View - Ch·ªâ hi·ªÉn th·ªã khi mobile v√† kh√¥ng c√≥ chat view -->
  <div class="mobile-chat-list" *ngIf="isMobile && !showChatView">
    <div class="chat-list-header">
      <h1>Chats</h1>
    </div>

    <!-- Chat Categories -->
    <div class="chat-categories">
      <!-- Community Chat -->
      <div class="chat-category-item" (click)="openCommunityChat()">
        <div class="category-avatar community-avatar">
          <i class="fas fa-users"></i>
        </div>
        <div class="category-info">
          <div class="category-name">C·ªông ƒë·ªìng PlantCare</div>
          <div class="category-desc">Ph√≤ng chat d√†nh cho th√†nh vi√™n VIP</div>
        </div>
      </div>

      <!-- Expert Chats - Ch·ªâ hi·ªÉn th·ªã khi mobile -->
      <div class="expert-list" *ngIf="isMobile">
        <div class="mobile-expert-header">
          <span class="mobile-section-title">Chuy√™n gia ({{ experts.length }})</span>
          <button class="mobile-debug-btn" (click)="checkDuplicateExperts()" title="Check Duplicates">
            üîç
          </button>
        </div>
        <div class="chat-category-item" *ngFor="let expert of experts; trackBy: trackExpertById" 
             (click)="startConversationWithExpert(expert)"
             (touchstart)="onTouchStart($event, expert)"
             (touchend)="onTouchEnd($event, expert)">
          <div class="category-avatar expert-avatar">
            <img *ngIf="expert.avatarUrl" 
                 [src]="expert.avatarUrl" 
                 [alt]="expert.fullName || expert.username"
                 class="user-avatar">
            <span *ngIf="!expert.avatarUrl">{{ (expert.fullName || expert.username).charAt(0).toUpperCase() }}</span>
          </div>
          <div class="category-info">
            <div class="category-name">{{ expert.fullName || expert.username }}</div>
            <div class="category-desc expert-badge">Chuy√™n gia (ID: {{ expert.id }})</div>
          </div>
        </div>
      </div>

      <!-- Recent Conversations - ƒê√£ b·ªè ho√†n to√†n -->
    </div>
    
    <!-- Footer for chat list -->
    <div class="mobile-footer">
      <app-footer></app-footer>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="messenger-main" *ngIf="!isMobile || showChatView">
    <!-- Mobile Chat Header -->
    <div class="mobile-chat-header" *ngIf="isMobile && showChatView">
      <button class="back-btn" (click)="goBackToList()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="chat-info">
        <div class="chat-avatar-small" *ngIf="selectedConversation">
          <img *ngIf="getConversationAvatar(selectedConversation)" 
               [src]="getConversationAvatar(selectedConversation)" 
               [alt]="selectedConversation.otherUsername"
               class="user-avatar">
          <span *ngIf="!getConversationAvatar(selectedConversation)">{{ selectedConversation.otherUsername.charAt(0).toUpperCase() }}</span>
        </div>
        <div class="chat-avatar-small community-avatar" *ngIf="!showPrivateChat && !selectedConversation">
          <i class="fas fa-users"></i>
        </div>
        <div class="chat-details">
          <div class="chat-name">{{ selectedConversation?.otherUsername || 'VIP Community' }}</div>
          <div class="chat-status">{{ selectedConversation ? 'Chuy√™n gia' : 'ƒêang ho·∫°t ƒë·ªông' }}</div>
        </div>
      </div>
    </div>

    <!-- Desktop Chat Header -->
    <div class="chat-header" *ngIf="!isMobile && (selectedConversation || !showPrivateChat)">
      <div class="header-left">
        <div class="chat-avatar-header" *ngIf="selectedConversation">
          <img *ngIf="getConversationAvatar(selectedConversation)" 
               [src]="getConversationAvatar(selectedConversation)" 
               [alt]="selectedConversation.otherUsername"
               class="user-avatar">
          <span *ngIf="!getConversationAvatar(selectedConversation)">{{ selectedConversation.otherUsername.charAt(0).toUpperCase() }}</span>
        </div>
        <div class="chat-avatar-header community-avatar" *ngIf="!showPrivateChat && !selectedConversation">
          VIP
        </div>
        <div class="header-info">
          <div class="chat-title">
            {{ selectedConversation?.otherUsername || 'VIP Community' }}
          </div>
          <div class="chat-status">
            <span *ngIf="selectedConversation" class="status-text">
              {{ selectedConversation.otherUsername }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Messages Area -->
    <div class="messages-container">
      <!-- Mobile Default Screen -->
      <div *ngIf="isMobile && !selectedConversation && showPrivateChat" class="welcome-screen">
        <div class="welcome-content">
          <h3>Ch√†o m·ª´ng ƒë·∫øn VIP Chat</h3>
          <p>Nh·∫•n v√†o n√∫t menu ƒë·ªÉ ch·ªçn chuy√™n gia ho·∫∑c cu·ªôc tr√≤ chuy·ªán</p>
        </div>
      </div>
      
      <!-- Desktop Welcome Screen -->
      <div *ngIf="!isMobile && !selectedConversation && showPrivateChat" class="welcome-screen">
        <div class="welcome-content">
          <h3>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán</h3>
          <p>Ch·ªçn m·ªôt chuy√™n gia ho·∫∑c cu·ªôc tr√≤ chuy·ªán t·ª´ danh s√°ch ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin</p>
        </div>
      </div>

      <!-- Community Chat Messages -->
      <div *ngIf="!showPrivateChat" class="chat-messages" #messagesContainer>
        <div *ngIf="loading" class="loading-state">
          <p>ƒêang t·∫£i tin nh·∫Øn...</p>
        </div>
        <div *ngIf="error && !loading" class="error-state">
          <p>{{ error }}</p>
          <button class="retry-btn" (click)="fetchHistory()">Th·ª≠ l·∫°i</button>
        </div>
        <div *ngIf="!loading && filteredMessages.length > 0" class="messages-list">
          <div *ngFor="let msg of filteredMessages; trackBy: trackMessage" 
               class="message-wrapper"
               [class.own-message]="isOwnMessage(msg)"
               [class.other-message]="!isOwnMessage(msg)">
            <!-- Tin nh·∫Øn c·ªßa ng∆∞·ªùi kh√°c (b√™n tr√°i) -->
            <div class="message-row" *ngIf="!isOwnMessage(msg)">
              <div class="sender-info" *ngIf="getSenderName(msg)">
                <span class="sender-name">{{ getSenderName(msg) }}</span>
              </div>
              <div class="message-bubble">
                <div class="message-content">{{ msg.content }}</div>
              </div>
              <div class="message-time-below left">{{ formatTimePretty(msg.timestamp) }}</div>
            </div>
            <!-- Tin nh·∫Øn c·ªßa m√¨nh (b√™n ph·∫£i) -->
            <div class="message-row own-row" *ngIf="isOwnMessage(msg)">
              <div class="message-bubble own-bubble">
                <div class="message-content">{{ msg.content }}</div>
              </div>
              <div class="message-time-below right">{{ formatTimePretty(msg.timestamp) }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Private Chat Messages -->
      <div *ngIf="showPrivateChat && selectedConversation" class="chat-messages" #messagesContainer>
        <div *ngIf="loading" class="loading-state">
          <p>ƒêang t·∫£i tin nh·∫Øn...</p>
        </div>
        <div *ngIf="error && !loading" class="error-state">
          <p>{{ error }}</p>
          <button class="retry-btn" (click)="loadPrivateMessages(selectedConversation.otherUserId)">Th·ª≠ l·∫°i</button>
        </div>
        <div *ngIf="!loading && filteredMessages.length > 0" class="messages-list">
          <div *ngFor="let msg of filteredMessages; trackBy: trackMessage"
               class="message-wrapper"
               [class.own-message]="isOwnMessage(msg)"
               [class.other-message]="!isOwnMessage(msg)">
            <!-- Tin nh·∫Øn c·ªßa ng∆∞·ªùi kh√°c -->
            <div class="message-row" *ngIf="!isOwnMessage(msg)">
              <div class="sender-info" *ngIf="getSenderName(msg)">
                <span class="sender-name">{{ getSenderName(msg) }}</span>
              </div>
              <div class="message-bubble">
                <div class="message-content">{{ msg.content }}</div>
              </div>
              <div class="message-time-below left">{{ formatTimePretty(msg.timestamp) }}</div>
            </div>
            <!-- Tin nh·∫Øn c·ªßa m√¨nh -->
            <div class="message-row own-row" *ngIf="isOwnMessage(msg)">
              <div class="message-bubble own-bubble">
                <div class="message-content">{{ msg.content }}</div>
              </div>
              <div class="message-time-below right">{{ formatTimePretty(msg.timestamp) }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Input Area -->
    <div class="chat-input-container" *ngIf="selectedConversation || !showPrivateChat || isMobile">
      <form class="chat-input-form" (ngSubmit)="sendMessage()" *ngIf="!loading">
        <div class="input-wrapper modern-input-wrapper">
          <textarea 
            class="message-input modern-message-input" 
            [(ngModel)]="newMessage" 
            name="message"
            [placeholder]="getInputPlaceholder()"
            rows="1"
            maxlength="250"
            (keydown)="onEnterPress($event)"
            #messageInput></textarea>
          <button 
            type="submit" 
            class="send-button modern-send-button"
            [class.active]="newMessage.trim().length > 0"
            [disabled]="newMessage.trim().length === 0">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </form>
      <div class="input-footer modern-input-footer">
        <div class="char-counter" [class.warning]="newMessage.length > 200">
          {{ newMessage.length }}/250
        </div>
      </div>
    </div>
  </div> <!-- End of messenger-main -->
</div> <!-- End of messenger-container -->