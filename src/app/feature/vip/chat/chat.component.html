<app-top-navigator></app-top-navigator>

<div class="messenger-container" [class.mobile-view]="isMobile">
  <!-- Mobile Overlay -->
  <div class="mobile-overlay" *ngIf="isMobile && sidebarVisible" (click)="closeSidebarOnMobile()"></div>
  


  <!-- Messenger-style Sidebar -->
  <div class="messenger-sidebar" 
       [class.sidebar-hidden]="isMobile && !sidebarVisible"
       [class.sidebar-visible]="!isMobile || sidebarVisible">
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <h2 class="sidebar-title">
        <i class="fas fa-comments"></i>
        Chats
      </h2>
      <div class="sidebar-actions">
        <button class="action-btn" title="Tùy chọn">
          <i class="fas fa-ellipsis-h"></i>
        </button>
      </div>
    </div>



    <!-- Community Room Section -->
    <div class="chat-section">
      <div class="section-header">
        <span class="section-title">Phòng chat chung</span>
      </div>
      <div class="chat-item community-room" [class.active]="!showPrivateChat && !selectedConversation" (click)="switchToCommunityChat(); closeSidebarOnMobile()">
        <div class="chat-avatar community-avatar">
          <i class="fas fa-users"></i>
        </div>
        <div class="chat-info">
          <div class="chat-name">VIP Community</div>
          <div class="chat-preview">Phòng chat dành cho thành viên VIP</div>
        </div>
        <div class="chat-meta">
          <div class="online-indicator active"></div>
        </div>
      </div>
    </div>

    <!-- Experts Section -->
    <div class="chat-section">
      <div class="section-header">
        <span class="section-title">Chuyên gia</span>
        <button class="section-action" (click)="loadExperts()" title="Làm mới">
          Làm mới
        </button>
      </div>
      <div class="experts-list">
        <div class="chat-item expert-item" 
             *ngFor="let expert of experts" 
             (click)="startConversationWithExpert(expert); closeSidebarOnMobile()">
          <div class="chat-avatar expert-avatar">
            {{ expert.username.charAt(0).toUpperCase() }}
          </div>
          <div class="chat-info">
            <div class="chat-name">{{ expert.username }}</div>
            <div class="chat-preview expert-badge">
              Chuyên gia
            </div>
          </div>
          <div class="chat-meta">
            <div class="online-indicator"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Chats Section -->
    <div class="chat-section">
      <div class="section-header">
        <span class="section-title">Trò chuyện gần đây</span>
        <button class="section-action" (click)="loadConversations()" title="Làm mới">
          Làm mới
        </button>
      </div>
      <div class="recent-chats">
        <div class="chat-item recent-chat" 
             *ngFor="let conversation of conversations" 
             [class.active]="selectedConversation?.conversationId === conversation.conversationId"
             (click)="selectConversation(conversation); closeSidebarOnMobile()">
          <div class="chat-avatar">
            {{ conversation.otherUsername.charAt(0).toUpperCase() }}
          </div>
          <div class="chat-info">
            <div class="chat-name">{{ conversation.otherUsername }}</div>
            <div class="chat-preview">
              {{ conversation.lastMessage || '' }}
            </div>
          </div>
          <div class="chat-meta">
            <div class="chat-time" *ngIf="conversation.lastMessageTime">
              {{ formatTime(conversation.lastMessageTime) }}
            </div>
            <div class="unread-badge" *ngIf="conversation.hasUnreadMessages">
              •
            </div>
          </div>
        </div>
        
        <!-- Empty state for recent chats -->
        <div class="empty-recent" *ngIf="conversations.length === 0">
          <span>Chưa có cuộc trò chuyện nào</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Chat List View -->
  <div class="mobile-chat-list" *ngIf="isMobile && !showChatView">
    <div class="chat-list-header">
      <h1>Chats</h1>
    </div>

    <!-- Chat Categories -->
    <div class="chat-categories">
      <!-- Community Chat -->
      <div class="chat-category-item" (click)="openCommunityChat()">
        <div class="category-avatar community-avatar">
          <i class="fas fa-users"></i>
        </div>
        <div class="category-info">
          <div class="category-name">VIP Community</div>
          <div class="category-desc">Phòng chat dành cho thành viên VIP</div>
        </div>
      </div>

      <!-- Expert Chats -->
      <div class="expert-list">
        <div class="chat-category-item" *ngFor="let expert of experts" (click)="startConversationWithExpert(expert)">
          <div class="category-avatar expert-avatar">
            {{ expert.username.charAt(0).toUpperCase() }}
          </div>
          <div class="category-info">
            <div class="category-name">{{ expert.username }}</div>
            <div class="category-desc expert-badge">Chuyên gia</div>
          </div>
        </div>
      </div>

      <!-- Recent Conversations -->
      <div class="recent-conversations" *ngIf="conversations.length > 0">
        <div class="chat-category-item" *ngFor="let conversation of conversations" (click)="selectConversation(conversation)">
          <div class="category-avatar">
            {{ conversation.otherUsername.charAt(0).toUpperCase() }}
          </div>
          <div class="category-info">
            <div class="category-name">{{ conversation.otherUsername }}</div>
            <div class="category-desc">{{ conversation.lastMessage || 'Nhấn để bắt đầu trò chuyện' }}</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Footer for chat list -->
    <div class="mobile-footer">
      <app-footer></app-footer>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="messenger-main" *ngIf="!isMobile || showChatView">
    <!-- Mobile Chat Header -->
    <div class="mobile-chat-header" *ngIf="isMobile && showChatView">
      <button class="back-btn" (click)="goBackToList()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="chat-info">
        <div class="chat-avatar-small" *ngIf="selectedConversation">
          {{ selectedConversation.otherUsername.charAt(0).toUpperCase() }}
        </div>
        <div class="chat-avatar-small community-avatar" *ngIf="!showPrivateChat && !selectedConversation">
          <i class="fas fa-users"></i>
        </div>
        <div class="chat-details">
          <div class="chat-name">{{ selectedConversation?.otherUsername || 'VIP Community' }}</div>
          <div class="chat-status">{{ selectedConversation ? 'Chuyên gia' : 'Đang hoạt động' }}</div>
        </div>
      </div>

    </div>

    <!-- Desktop Chat Header -->
    <div class="chat-header" *ngIf="!isMobile && (selectedConversation || !showPrivateChat)">
      <div class="header-left">
        <div class="chat-avatar-header" *ngIf="selectedConversation">
          {{ selectedConversation.otherUsername.charAt(0).toUpperCase() }}
        </div>
        <div class="chat-avatar-header community-avatar" *ngIf="!showPrivateChat && !selectedConversation">
          VIP
        </div>
        <div class="header-info">
          <div class="chat-title">
            {{ selectedConversation?.otherUsername || 'VIP Community' }}
          </div>
          <div class="chat-status">
            <span *ngIf="selectedConversation" class="status-text">
              {{ selectedConversation.otherUsername }}
            </span>
            <span *ngIf="!showPrivateChat && !selectedConversation" class="status-text">
              Đang hoạt động
            </span>
          </div>
        </div>
      </div>

    </div>

    <!-- Chat Messages Area -->
    <div class="messages-container">
      <!-- Mobile Default Screen -->
      <div *ngIf="isMobile && !selectedConversation && showPrivateChat" class="welcome-screen">
        <div class="welcome-content">
          <h3>Chào mừng đến VIP Chat</h3>
          <p>Nhấn vào nút menu để chọn chuyên gia hoặc cuộc trò chuyện</p>
        </div>
      </div>
      
      <!-- Desktop Welcome Screen -->
      <div *ngIf="!isMobile && !selectedConversation && showPrivateChat" class="welcome-screen">
        <div class="welcome-content">
          <h3>Chọn một cuộc trò chuyện</h3>
          <p>Chọn một chuyên gia hoặc cuộc trò chuyện từ danh sách để bắt đầu nhắn tin</p>
        </div>
      </div>

      <!-- Community Chat Messages -->
      <div *ngIf="!showPrivateChat" class="chat-messages" #messagesContainer>
        <div *ngIf="loading" class="loading-state">
          <p>Đang tải tin nhắn...</p>
        </div>
        <div *ngIf="error && !loading" class="error-state">
          <p>{{ error }}</p>
          <button class="retry-btn" (click)="fetchHistory()">Thử lại</button>
        </div>
        <div *ngIf="!loading && filteredMessages.length > 0" class="messages-list">
          <div *ngFor="let msg of filteredMessages; trackBy: trackMessage" 
               class="message-wrapper"
               [class.own-message]="isOwnMessage(msg)"
               [class.other-message]="!isOwnMessage(msg)">
            <!-- Tin nhắn của người khác (bên trái) -->
            <div class="message-row" *ngIf="!isOwnMessage(msg)">
              <div class="sender-info" *ngIf="getSenderName(msg)">
                <span class="sender-name">{{ getSenderName(msg) }}</span>
              </div>
              <div class="message-bubble">
                <div class="message-content">{{ msg.content }}</div>
              </div>
              <div class="message-time-below left">{{ formatTimePretty(msg.timestamp) }}</div>
            </div>
            <!-- Tin nhắn của mình (bên phải) -->
            <div class="message-row own-row" *ngIf="isOwnMessage(msg)">
              <div class="message-bubble own-bubble">
                <div class="message-content">{{ msg.content }}</div>
              </div>
              <div class="message-time-below right">{{ formatTimePretty(msg.timestamp) }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Private Chat Messages -->
      <div *ngIf="showPrivateChat && selectedConversation" class="chat-messages" #messagesContainer>
        <div *ngIf="loading" class="loading-state">
          <p>Đang tải tin nhắn...</p>
        </div>
        <div *ngIf="error && !loading" class="error-state">
          <p>{{ error }}</p>
          <button class="retry-btn" (click)="loadPrivateMessages(selectedConversation.otherUserId)">Thử lại</button>
        </div>
        <div *ngIf="!loading && filteredMessages.length > 0" class="messages-list">
          <div *ngFor="let msg of filteredMessages; trackBy: trackMessage"
               class="message-wrapper"
               [class.own-message]="isOwnMessage(msg)"
               [class.other-message]="!isOwnMessage(msg)">
            <!-- Tin nhắn của người khác -->
            <div class="message-row" *ngIf="!isOwnMessage(msg)">
              <div class="sender-info" *ngIf="getSenderName(msg)">
                <span class="sender-name">{{ getSenderName(msg) }}</span>
              </div>
              <div class="message-bubble">
                <div class="message-content">{{ msg.content }}</div>
                <div class="message-time-below left">{{ formatTimePretty(msg.timestamp) }}</div>
              </div>
            </div>
            <!-- Tin nhắn của mình -->
            <div class="message-row own-row" *ngIf="isOwnMessage(msg)">
              <div class="message-bubble own-bubble">
                <div class="message-content">{{ msg.content }}</div>
                <div class="message-time-below right">{{ formatTimePretty(msg.timestamp) }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

  <!-- Private Chat Messages: Đã có khối chat-messages, chỉ giữ lại 1 khối duy nhất cho private chat -->
  <!-- ...existing code... -->

            <!-- Unified Chat Input Area -->
      <div class="chat-input-container" *ngIf="selectedConversation || !showPrivateChat || isMobile">
        <form class="chat-input-form" (ngSubmit)="sendMessage()" *ngIf="!loading">
          <div class="input-wrapper">
            <textarea 
              class="message-input" 
              [(ngModel)]="newMessage" 
              name="message"
              [placeholder]="getInputPlaceholder()"
              rows="1"
              maxlength="250"
              (keydown)="onEnterPress($event)"
              #messageInput></textarea>
            
            <button 
              type="submit" 
              class="send-button"
              [class.active]="newMessage.trim().length > 0"
              [disabled]="newMessage.trim().length === 0">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </form>
        
        <div class="input-footer">
          <div class="char-counter" [class.warning]="newMessage.length > 200">
            {{ newMessage.length }}/250
          </div>
        </div>
      </div>
      

</div>