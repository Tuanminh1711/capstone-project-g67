<div class="page-container">
  <div class="page-header">
    <h1>ğŸ©º Táº¡o hÆ°á»›ng dáº«n Ä‘iá»u trá»‹ má»›i</h1>
    <p class="subtitle">ThÃªm hÆ°á»›ng dáº«n Ä‘iá»u trá»‹ chi tiáº¿t cho bá»‡nh cÃ¢y</p>
  </div>

  <div class="form-container">
    <div class="form-header">
      <h2>ğŸ“‹ ThÃ´ng tin hÆ°á»›ng dáº«n</h2>
      <p>Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin Ä‘á»ƒ táº¡o hÆ°á»›ng dáº«n Ä‘iá»u trá»‹</p>
    </div>

    <div class="form-content">
      <form (ngSubmit)="onSubmit()">
        
        <!-- Chá»n bá»‡nh cÃ¢y -->
        <div class="form-group" *ngIf="!diseaseId">
          <label for="diseaseSelect">ğŸŒ¿ Chá»n bá»‡nh cÃ¢y <span class="required">*</span></label>
          <select 
            id="diseaseSelect"
            [(ngModel)]="selectedDiseaseId" 
            name="diseaseId" 
            class="form-control"
            (change)="onDiseaseChange()"
            [disabled]="isLoadingDiseases"
            required>
            <option value="" disabled>
              {{ isLoadingDiseases ? 'Äang táº£i danh sÃ¡ch bá»‡nh...' : '-- Chá»n bá»‡nh cÃ¢y --' }}
            </option>
            <ng-container *ngIf="diseases && diseases.length > 0 && !isLoadingDiseases">
              <option *ngFor="let disease of diseases; trackBy: trackByDiseaseId" [value]="disease.id">
                {{ disease.diseaseName || disease.name || 'Bá»‡nh khÃ´ng tÃªn' }}
              </option>
            </ng-container>
          </select>
        </div>

        <!-- Loading state cho existing guides -->
        <div class="form-group" *ngIf="isLoadingGuides">
          <div class="loading-section">
            <div class="loading-spinner"></div>
            <p>ğŸ” Äang kiá»ƒm tra hÆ°á»›ng dáº«n Ä‘Ã£ cÃ³...</p>
          </div>
        </div>

        <!-- Hiá»ƒn thá»‹ hÆ°á»›ng dáº«n Ä‘Ã£ cÃ³ -->
        <div class="existing-guides-section" *ngIf="!isLoadingGuides && selectedDiseaseId && existingTreatmentGuides && existingTreatmentGuides.length > 0">
          <div class="section-title">
            <span class="icon">âš ï¸</span>
            HÆ°á»›ng dáº«n Ä‘Ã£ cÃ³ cho bá»‡nh nÃ y ({{ existingTreatmentGuides.length }} hÆ°á»›ng dáº«n):
          </div>
          <div class="guides-list">
            <div class="guide-item" *ngFor="let guide of existingTreatmentGuides; let i = index">
              <div class="guide-header">
                <span class="step-number">BÆ°á»›c {{ guide.stepNumber }}</span>
                <span class="guide-title">{{ guide.title }}</span>
              </div>
              <div class="guide-description">{{ guide.description }}</div>
            </div>
          </div>
        </div>

        <!-- Message khi khÃ´ng cÃ³ hÆ°á»›ng dáº«n -->
        <div class="existing-guides-section" *ngIf="!isLoadingGuides && selectedDiseaseId && existingTreatmentGuides && existingTreatmentGuides.length === 0">
          <div class="no-guides-message">
            âœ… ChÆ°a cÃ³ hÆ°á»›ng dáº«n nÃ o cho bá»‡nh nÃ y. Báº¡n cÃ³ thá»ƒ táº¡o hÆ°á»›ng dáº«n Ä‘áº§u tiÃªn!
          </div>
        </div>

        <!-- ThÃ´ng tin bá»‡nh Ä‘Ã£ chá»n -->
        <div class="form-group" *ngIf="diseaseId">
          <label>ğŸ¯ Táº¡o hÆ°á»›ng dáº«n cho bá»‡nh</label>
          <div class="form-control" style="background: #e3f2fd; color: #1976d2; font-weight: 600;">
            Bá»‡nh ID: {{ diseaseId }}
          </div>
        </div>

        <!-- Sá»‘ bÆ°á»›c -->
        <div class="form-group">
          <label for="stepNumber">ğŸ”¢ Sá»‘ bÆ°á»›c <span class="required">*</span></label>
          <input 
            type="number" 
            id="stepNumber"
            [(ngModel)]="treatmentGuide.stepNumber" 
            name="stepNumber" 
            class="form-control"
            [class.is-invalid]="!isStepNumberValid() && treatmentGuide.stepNumber > 0"
            min="1" 
            placeholder="VÃ­ dá»¥: 1, 2, 3..."
            required>
          
          <!-- Step number validation message -->
          <div *ngIf="existingTreatmentGuides.length > 0" class="step-info">
            <div class="existing-steps">
              <small class="text-muted">
                ğŸ“ CÃ¡c bÆ°á»›c Ä‘Ã£ cÃ³: {{ getExistingStepNumbers().join(', ') }}
              </small>
            </div>
            <div *ngIf="!isStepNumberValid() && treatmentGuide.stepNumber > 0" class="invalid-feedback">
              âš ï¸ BÆ°á»›c {{ treatmentGuide.stepNumber }} Ä‘Ã£ tá»“n táº¡i! Vui lÃ²ng chá»n bÆ°á»›c {{ getSuggestedNextStep() }}
            </div>
            <div *ngIf="isStepNumberValid() && treatmentGuide.stepNumber > 0" class="valid-feedback">
              âœ… BÆ°á»›c {{ treatmentGuide.stepNumber }} cÃ³ thá»ƒ sá»­ dá»¥ng
            </div>
          </div>
        </div>

        <!-- TiÃªu Ä‘á» -->
        <div class="form-group">
          <label for="title">ğŸ“ TiÃªu Ä‘á» bÆ°á»›c Ä‘iá»u trá»‹ <span class="required">*</span></label>
          <input 
            type="text" 
            id="title"
            [(ngModel)]="treatmentGuide.title" 
            name="title" 
            class="form-control"
            placeholder="VÃ­ dá»¥: LÃ m sáº¡ch vÃ¹ng bá»‹ bá»‡nh"
            required>
        </div>

        <!-- MÃ´ táº£ chi tiáº¿t -->
        <div class="form-group">
          <label for="description">ğŸ“‹ MÃ´ táº£ chi tiáº¿t <span class="required">*</span></label>
          <textarea 
            id="description"
            [(ngModel)]="treatmentGuide.description" 
            name="description" 
            class="form-control"
            placeholder="MÃ´ táº£ chi tiáº¿t cÃ¡ch thá»±c hiá»‡n bÆ°á»›c nÃ y..."
            required></textarea>
        </div>

        <!-- Thá»i gian vÃ  táº§n suáº¥t -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div class="form-group">
            <label for="duration">â° Thá»i gian thá»±c hiá»‡n <span class="required">*</span></label>
            <input 
              type="text" 
              id="duration"
              [(ngModel)]="treatmentGuide.duration" 
              name="duration" 
              class="form-control"
              placeholder="VÃ­ dá»¥: 30 phÃºt, 1 ngÃ y"
              required>
          </div>

          <div class="form-group">
            <label for="frequency">ğŸ” Táº§n suáº¥t <span class="required">*</span></label>
            <input 
              type="text" 
              id="frequency"
              [(ngModel)]="treatmentGuide.frequency" 
              name="frequency" 
              class="form-control"
              placeholder="VÃ­ dá»¥: 1 láº§n/ngÃ y, 2 láº§n/tuáº§n"
              required>
          </div>
        </div>

        <!-- Váº­t liá»‡u cáº§n thiáº¿t -->
        <div class="form-group">
          <div class="materials-section">
            <div class="materials-header">
              <h3>ğŸ§° Váº­t liá»‡u cáº§n thiáº¿t</h3>
              <button type="button" class="add-material-btn" (click)="addMaterial()">
                â• ThÃªm váº­t liá»‡u
              </button>
            </div>
            <div *ngFor="let material of treatmentGuide.materials; let i = index; trackBy: trackByIndex" 
                 class="material-item">
              <input 
                type="text"
                [(ngModel)]="treatmentGuide.materials[i]" 
                [name]="'material_' + i" 
                class="form-control material-input"
                [placeholder]="'Váº­t liá»‡u ' + (i + 1)">
              <button 
                type="button" 
                class="remove-material-btn" 
                (click)="removeMaterial(i)"
                [disabled]="treatmentGuide.materials.length <= 1">
                âŒ
              </button>
            </div>
          </div>
        </div>

        <!-- Ghi chÃº -->
        <div class="form-group">
          <label for="notes">ğŸ“ Ghi chÃº</label>
          <textarea 
            id="notes"
            [(ngModel)]="treatmentGuide.notes" 
            name="notes" 
            class="form-control"
            placeholder="CÃ¡c lÆ°u Ã½ Ä‘áº·c biá»‡t khi thá»±c hiá»‡n (khÃ´ng báº¯t buá»™c)..."></textarea>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="onCancel()">
            âŒ Há»§y
          </button>
          <button type="submit" class="btn btn-primary">
            ğŸ’¾ Táº¡o hÆ°á»›ng dáº«n
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
