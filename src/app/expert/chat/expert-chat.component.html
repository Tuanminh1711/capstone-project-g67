<app-expert-layout>
  <div class="expert-chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
      <div class="header-content">
        <div class="chat-avatar">
          <span>üí¨</span>
        </div>
        <div class="chat-details">
          <h3 class="chat-title">Ph√≤ng Chat C·ªông ƒê·ªìng</h3>
          <p class="chat-subtitle">
            <span class="status-indicator"></span>
            {{ messages.length }} tin nh·∫Øn ‚Ä¢ {{ getOnlineCount() }} ng∆∞·ªùi online
          </p>
        </div>
        <div class="header-actions">
          <button class="action-btn" title="T√¨m ki·∫øm">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
          </button>
          <button class="action-btn" title="Th√™m ng∆∞·ªùi">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Chat Messages Area -->
    <div class="chat-messages" #messagesContainer>
      <div *ngIf="loading" class="loading-state">
        <div class="spinner"></div>
        <div class="text">ƒêang t·∫£i tin nh·∫Øn...</div>
      </div>

      <div *ngIf="error && !loading" class="error-state">
        <div class="icon">‚ö†Ô∏è</div>
        <div class="text">{{ error }}</div>
        <button class="retry-btn" (click)="connectToChat()">Th·ª≠ l·∫°i</button>
      </div>

      <div *ngIf="!loading && messages.length === 0" class="empty-state">
        <div class="icon">üí¨</div>
        <div class="text">Ch∆∞a c√≥ tin nh·∫Øn n√†o</div>
        <div class="subtext">H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán v·ªõi c·ªông ƒë·ªìng!</div>
      </div>

      <div *ngIf="!loading && messages.length > 0" class="messages-list">
        <div *ngFor="let msg of messages; trackBy: trackMessage; let last = last" 
             class="message-wrapper"
             [class.own-message]="isOwnMessage(msg)"
             [class.other-message]="!isOwnMessage(msg)">
          
          <div class="message-avatar">
            <span>{{ getAvatarInitial(msg) }}</span>
          </div>
          
          <div class="message-bubble">
            <div class="message-content">
              <div class="message-info">
                <span class="sender-name">{{ getSenderName(msg) }}</span>
                <span class="message-time">{{ formatTime(msg.timestamp) }}</span>
              </div>
              <div class="message-text">
                {{ msg.content }}
              </div>
              <div class="message-role">
                <span class="role-badge" [class]="getRoleBadgeClass(msg.senderRole)">
                  {{ getRoleDisplayName(msg.senderRole) }}
                </span>
              </div>
              <div class="message-status" *ngIf="isOwnMessage(msg)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Input Area -->
    <div class="chat-input-container">
      <div class="input-wrapper">
        <div class="input-actions">
          <button type="button" class="input-action-btn" title="ƒê√≠nh k√®m file">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
            </svg>
          </button>
          <button type="button" class="input-action-btn" title="Emoji">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
            </svg>
          </button>
        </div>
        
        <form class="message-form" (ngSubmit)="sendMessage()" #chatForm="ngForm">
          <textarea 
            class="message-input" 
            [(ngModel)]="newMessage" 
            name="message"
            placeholder="Nh·∫≠p tin nh·∫Øn t∆∞ v·∫•n cho c·ªông ƒë·ªìng..."
            rows="1"
            maxlength="1000"
            (keydown.enter)="onEnterPress($event)"
            #messageInput></textarea>
          
          <button 
            type="submit" 
            class="send-button"
            [disabled]="newMessage.trim().length === 0">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </form>
      </div>
      
      <div class="input-footer">
        <div class="char-counter" [class.warning]="newMessage.length > 800">
          {{ newMessage.length }}/1000
        </div>
      </div>
    </div>
  </div>
</app-expert-layout>
