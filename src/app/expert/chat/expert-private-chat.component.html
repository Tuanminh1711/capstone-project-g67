<app-expert-layout>
  <div class="expert-private-chat-container">
    <!-- Conversation List -->
    <div class="conversation-list" *ngIf="showConversationList">
      <div class="conversation-header">
        <h2>Tin nhắn riêng tư</h2>
        <p class="subtitle">Quản lý các cuộc trò chuyện với VIP users</p>
      </div>

      <div *ngIf="loading" class="loading-state">
        <div class="text">Đang tải danh sách trò chuyện...</div>
      </div>

      <div *ngIf="error && !loading" class="error-state">
        <div class="icon">⚠️</div>
        <div class="text">{{ error }}</div>
        <button class="retry-btn" (click)="loadConversations()">Thử lại</button>
      </div>

      <div *ngIf="!loading && conversations.length === 0" class="empty-state">
        <div class="text">Chưa có cuộc trò chuyện nào</div>
        <div class="subtext">Khi VIP users gửi tin nhắn riêng tư, chúng sẽ xuất hiện ở đây</div>
      </div>

      <div *ngIf="!loading && conversations.length > 0" class="conversations">
        <div *ngFor="let conversation of conversations" 
             class="conversation-item"
             [class.active]="selectedConversation?.conversationId === conversation.conversationId"
             [class.unread]="conversation.hasUnreadMessages"
             (click)="selectConversation(conversation)">
          
          <div class="conversation-avatar">
            <span>{{ conversation.otherUsername.charAt(0).toUpperCase() }}</span>
            <div class="online-indicator" *ngIf="conversation.hasUnreadMessages"></div>
          </div>
          
          <div class="conversation-content">
            <div class="conversation-header">
              <div class="conversation-info">
                <span class="conversation-name">{{ conversation.otherUsername }}</span>

              </div>
              <span class="conversation-time">{{ formatConversationTime(conversation.lastMessageTime) }}</span>
            </div>
            
            <div class="conversation-message">
              <span class="message-preview">{{ conversation.lastMessage }}</span>
              <div class="unread-badge" *ngIf="conversation.hasUnreadMessages">1</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Interface Messenger Style -->
    <div class="messenger-main" *ngIf="!showConversationList && selectedConversation">
      <!-- Chat Header -->
      <div class="chat-header">
        <button class="back-btn" (click)="backToConversations()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
        </button>
        <div class="header-left">
          <div class="chat-avatar">
            <span>{{ selectedConversation.otherUsername.charAt(0).toUpperCase() }}</span>
          </div>
          <div class="chat-details">
            <h3 class="chat-title">{{ selectedConversation.otherUsername }}</h3>
            <p class="chat-subtitle">
              <span class="status-indicator"></span>
              {{ selectedConversation.otherUsername }}
            </p>
          </div>
        </div>
      </div>

      <!-- Chat Messages Area -->
      <div class="chat-messages" #messagesContainer>
        <div *ngIf="loading" class="loading-state">
          <div class="text">Đang tải tin nhắn...</div>
        </div>

        <div *ngIf="error && !loading" class="error-state">
          <div class="text">{{ error }}</div>
          <button class="retry-btn" (click)="loadPrivateMessages(selectedConversation.otherUserId)">Thử lại</button>
        </div>

        <div *ngIf="!loading && messages.length === 0" class="empty-state">
          <div class="text">Chưa có tin nhắn nào</div>
          <div class="subtext">Bắt đầu cuộc trò chuyện với {{ selectedConversation.otherUsername }}</div>
        </div>

        <div *ngIf="!loading && messages.length > 0" class="messages-list">
          <div *ngFor="let msg of messages; trackBy: trackMessage" 
               class="message-wrapper"
               [class.own-message]="isOwnMessage(msg)"
               [class.other-message]="!isOwnMessage(msg)">
            
            <!-- Avatar cho tin nhắn của người khác (bên trái) -->
            <div class="message-avatar" *ngIf="!isOwnMessage(msg)">
              <span>{{ getAvatarInitial(msg) }}</span>
            </div>
            
            <div class="message-bubble">
              <div class="message-content">
                <div class="message-info">
                  <span class="sender-name">{{ getSenderName(msg) }}</span>
                  <span class="message-time">{{ formatTime(msg.timestamp) }}</span>
                </div>
                <div class="message-text">
                  {{ msg.content }}
                </div>
              </div>
            </div>
            
            <!-- Avatar cho tin nhắn của mình (bên phải) -->
            <div class="message-avatar own-avatar" *ngIf="isOwnMessage(msg)">
              <span>{{ getAvatarInitial(msg) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Input Area - Đơn giản hóa -->
      <div class="chat-input-container">
        <form class="message-form" (ngSubmit)="sendMessage()" #chatForm="ngForm">
          <textarea 
            class="message-input" 
            [(ngModel)]="newMessage" 
            name="message"
            placeholder="Nhập tin nhắn trả lời..."
            rows="1"
            maxlength="1000"
            (keydown.enter)="onEnterPress($event)"
            #messageInput></textarea>
          
          <button 
            type="submit" 
            class="send-button"
            [disabled]="newMessage.trim().length === 0">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </form>
        
        <div class="input-footer">
          <div class="char-counter" [class.warning]="newMessage.length > 800">
            {{ newMessage.length }}/1000
          </div>
        </div>
      </div>
    </div>
  </div>
</app-expert-layout>
