<app-top-navigator></app-top-navigator>

<div class="update-plant-container" (click)="onPageVisible()">
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">Chỉnh sửa thông tin cây</h1>
      <p class="page-subtitle">Cập nhật thông tin cho cây trong vườn của bạn</p>
    </div>
    <!-- Loading State -->
    @if (isLoading) {
      <div class="state-section loading-state">
        <div class="state-content">
          <div class="loading-spinner"></div>
          <h3>Đang tải thông tin</h3>
          <p>Vui lòng chờ trong giây lát...</p>
        </div>
      </div>
    }

    <!-- Error State -->
    @if (errorMessage && !isLoading) {
      <div class="state-section error-state">
        <div class="state-content">
          <div class="error-icon">Lỗi</div>
          <h3>Có lỗi xảy ra</h3>
          <p>{{ errorMessage }}</p>
          <button class="retry-btn" (click)="loadPlantData()">Thử lại</button>
        </div>
      </div>
    }

    <!-- Update Form -->
    @if (!isLoading && !errorMessage && currentPlant) {
      <div class="form-section">

      <!-- Plant Info Header with Image Gallery (đồng bộ view-user-plant-detail) -->
      <div class="plant-info-card">
        <div class="plant-images-section">
          <!-- Gallery ảnh: click ảnh cũ để thay, có ô thêm ảnh mới -->
          <div class="user-plant-image-gallery">
            <div class="image-list">
              <div class="image-item" *ngFor="let img of getAllPlantImageUrls()">
                <label>
                  <img [src]="img" alt="Ảnh cây" (error)="onImageError($event)" />
                  <input type="file" accept="image/*" style="display:none" (change)="onReplaceImage($event)" />
                </label>
                <button type="button" class="save-image-btn" (click)="saveImage()">Lưu ảnh</button>
              </div>
              <!-- Ô thêm ảnh mới -->
              <label class="image-item add-image">
                <input type="file" accept="image/*" style="display:none" (change)="onAddImage($event)" />
                <span class="add-icon">+</span>
              </label>
            </div>
          </div>
        </div>
        
        <div class="plant-details">
          <h2 class="plant-name">{{ currentPlant.nickname }}</h2>
          <p class="plant-location">{{ currentPlant.plantLocation }}</p>
        </div>
      </div>

      <!-- Update Form -->
      <div class="form-card">
        <div class="form-header">
          <h3>Thông tin cây</h3>
          <p>Cập nhật thông tin chi tiết cho cây của bạn</p>
        </div>

        <form [formGroup]="updateForm" (ngSubmit)="onSubmit()" class="update-form">
          <div class="form-grid">
            <!-- Nickname Field -->
            <div class="form-group">
              <label for="nickname" class="form-label">
                Tên gọi <span class="required">*</span>
              </label>
              <input
                type="text"
                id="nickname"
                formControlName="nickname"
                class="form-input"
                [class.error]="isFieldInvalid('nickname')"
                placeholder="Nhập tên gọi cho cây của bạn"
                maxlength="100"
              />
              @if (isFieldInvalid('nickname')) {
                <div class="error-message">
                  {{ getFieldError('nickname') }}
                </div>
              }
            </div>

            <!-- Location Field -->
            <div class="form-group">
              <label for="locationInHouse" class="form-label">
                Vị trí trong nhà <span class="required">*</span>
              </label>
              <select
                id="locationInHouse"
                formControlName="locationInHouse"
                class="form-input"
                [class.error]="isFieldInvalid('locationInHouse')"
              >
                <option *ngFor="let loc of locationOptions" [value]="loc">{{ loc }}</option>
              </select>
              @if (isFieldInvalid('locationInHouse')) {
                <div class="error-message">
                  {{ getFieldError('locationInHouse') }}
                </div>
              }
            </div>

            <!-- Planting Date Field -->
            <div class="form-group">
              <label for="plantingDate" class="form-label">
                Ngày trồng <span class="required">*</span>
              </label>
              <input
                type="date"
                id="plantingDate"
                formControlName="plantingDate"
                class="form-input"
                [class.error]="isFieldInvalid('plantingDate')"
              />
              @if (isFieldInvalid('plantingDate')) {
                <div class="error-message">
                  {{ getFieldError('plantingDate') }}
                </div>
              }
            </div>

          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="updateForm.invalid || isSubmitting"
            >
              @if (isSubmitting) {
                <span class="btn-loading"></span>
              }
              <span>{{ isSubmitting ? 'Đang cập nhật...' : 'Cập nhật thông tin' }}</span>
            </button>
          </div>
        </form>
      </div>
      </div>
    }
  </div>
</div>
