<app-top-navigator></app-top-navigator>

<div class="update-plant-container" (click)="onPageVisible()">
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">Ch·ªânh s·ª≠a th√¥ng tin c√¢y</h1>
      <p class="page-subtitle">C·∫≠p nh·∫≠t th√¥ng tin cho c√¢y trong v∆∞·ªùn c·ªßa b·∫°n</p>
    </div>
    <!-- Loading State -->
    @if (isLoading) {
      <div class="state-section loading-state">
        <div class="state-content">
          <div class="loading-spinner"></div>
          <h3>ƒêang t·∫£i th√¥ng tin</h3>
          <p>Vui l√≤ng ch·ªù trong gi√¢y l√°t...</p>
        </div>
      </div>
    }

    <!-- Error State -->
    @if (errorMessage && !isLoading) {
      <div class="state-section error-state">
        <div class="state-content">
          <div class="error-icon">L·ªói</div>
          <h3>C√≥ l·ªói x·∫£y ra</h3>
          <p>{{ errorMessage }}</p>
          <button class="retry-btn" (click)="loadPlantData()">Th·ª≠ l·∫°i</button>
        </div>
      </div>
    }

    <!-- Update Form -->
    @if (!isLoading && !errorMessage && currentPlant) {
      <div class="form-section">

      <!-- Plant Info Header with Image Gallery (ƒë·ªìng b·ªô view-user-plant-detail) -->
      <div class="plant-info-card">
        <div class="plant-images" style="margin-bottom: 18px;">
          @if (getAllPlantImageUrls().length > 0) {
            @for (img of getAllPlantImageUrls(); track img) {
              <img [src]="img" alt="·∫¢nh c√¢y" class="plant-img" (error)="onImageError($event)" />
            }
          } @else {
            <div class="no-image-placeholder">
              <span class="placeholder-icon">üå±</span>
              <span class="placeholder-text">Ch∆∞a c√≥ ·∫£nh</span>
            </div>
          }
        </div>
        <div class="plant-details">
          <h2 class="plant-name">{{ currentPlant.nickname }}</h2>
          <p class="plant-location">{{ currentPlant.plantLocation }}</p>
        </div>
      </div>

      <!-- Update Form -->
      <div class="form-card">
        <div class="form-header">
          <h3>Th√¥ng tin c√¢y</h3>
          <p>C·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt cho c√¢y c·ªßa b·∫°n</p>
        </div>

        <form [formGroup]="updateForm" (ngSubmit)="onSubmit()" class="update-form">
          <div class="form-grid">
            <!-- Nickname Field -->
            <div class="form-group">
              <label for="nickname" class="form-label">
                T√™n g·ªçi <span class="required">*</span>
              </label>
              <input
                type="text"
                id="nickname"
                formControlName="nickname"
                class="form-input"
                [class.error]="isFieldInvalid('nickname')"
                placeholder="Nh·∫≠p t√™n g·ªçi cho c√¢y c·ªßa b·∫°n"
                maxlength="100"
              />
              @if (isFieldInvalid('nickname')) {
                <div class="error-message">
                  {{ getFieldError('nickname') }}
                </div>
              }
            </div>

            <!-- Location Field -->
            <div class="form-group">
              <label for="locationInHouse" class="form-label">
                V·ªã tr√≠ trong nh√† <span class="required">*</span>
              </label>
              <input
                type="text"
                id="locationInHouse"
                formControlName="locationInHouse"
                class="form-input"
                [class.error]="isFieldInvalid('locationInHouse')"
                placeholder="V√≠ d·ª•: Ph√≤ng kh√°ch, Ban c√¥ng, Ph√≤ng ng·ªß..."
                maxlength="50"
              />
              @if (isFieldInvalid('locationInHouse')) {
                <div class="error-message">
                  {{ getFieldError('locationInHouse') }}
                </div>
              }
            </div>

            <!-- Planting Date Field -->
            <div class="form-group">
              <label for="plantingDate" class="form-label">
                Ng√†y tr·ªìng <span class="required">*</span>
              </label>
              <input
                type="date"
                id="plantingDate"
                formControlName="plantingDate"
                class="form-input"
                [class.error]="isFieldInvalid('plantingDate')"
              />
              @if (isFieldInvalid('plantingDate')) {
                <div class="error-message">
                  {{ getFieldError('plantingDate') }}
                </div>
              }
            </div>

            <!-- Image Upload Section -->
            <div class="form-group">
              <label for="update-images" class="form-label">
                C·∫≠p nh·∫≠t ·∫£nh c√¢y <span class="optional">(T√πy ch·ªçn)</span>
              </label>
              <input 
                type="file" 
                id="update-images"
                name="update-images"
                accept="image/*"
                multiple
                (change)="onImageSelected($event)"
                class="file-input"
                style="display: none;"
              />
              <div class="file-upload-area" (click)="triggerFileInput()">
                <div class="upload-content">
                  <i class="upload-icon">üì∏</i>
                  <p class="upload-text">Nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh m·ªõi</p>
                  <small class="upload-hint">H·ªó tr·ª£ nhi·ªÅu ·∫£nh, ƒë·ªãnh d·∫°ng JPG, PNG (t·ªëi ƒëa 5MB m·ªói ·∫£nh)</small>
                </div>
              </div>
              
              <!-- Preview selected images -->
              @if (selectedImages && selectedImages.length > 0) {
                <div class="image-preview-container">
                  <h5>·∫¢nh m·ªõi ƒë√£ ch·ªçn ({{ selectedImages.length }}):</h5>
                  <div class="image-preview-grid">
                    @for (image of selectedImages; track image; let i = $index) {
                      <div class="image-preview-item">
                        <img [src]="getImagePreview(image)" [alt]="'Preview ' + (i + 1)" class="preview-img">
                        <button type="button" class="remove-image-btn" (click)="removeSelectedImage(i)" title="X√≥a ·∫£nh">
                          ‚úï
                        </button>
                        <div class="image-info">
                          <small>{{ image.name }}</small>
                          <small>{{ formatFileSize(image.size) }}</small>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
              <small class="help-text">Ch·ªçn ·∫£nh m·ªõi ƒë·ªÉ thay th·∫ø to√†n b·ªô ·∫£nh hi·ªán t·∫°i c·ªßa c√¢y. ·∫¢nh s·∫Ω ƒë∆∞·ª£c t·∫£i l√™n server v√† l∆∞u v√†o database.</small>
            </div>

          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="updateForm.invalid || isSubmitting"
            >
              @if (isSubmitting) {
                <span class="btn-loading"></span>
              }
              <span>{{ isSubmitting ? 'ƒêang c·∫≠p nh·∫≠t...' : 'C·∫≠p nh·∫≠t th√¥ng tin' }}</span>
            </button>
          </div>
        </form>
      </div>
      </div>
    }
  </div>
</div>
