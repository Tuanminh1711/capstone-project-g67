<app-top-navigator></app-top-navigator>

<div class="update-plant-container" (click)="onPageVisible()">
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">Ch·ªânh s·ª≠a th√¥ng tin c√¢y</h1>
      <p class="page-subtitle">C·∫≠p nh·∫≠t th√¥ng tin cho c√¢y trong v∆∞·ªùn c·ªßa b·∫°n</p>
    </div>
    <!-- Loading State -->
    @if (isLoading) {
      <div class="state-section loading-state">
        <div class="state-content">
          <div class="loading-spinner"></div>
          <h3>ƒêang t·∫£i th√¥ng tin</h3>
          <p>Vui l√≤ng ch·ªù trong gi√¢y l√°t...</p>
        </div>
      </div>
    }

    <!-- Error State -->
    @if (errorMessage && !isLoading) {
      <div class="state-section error-state">
        <div class="state-content">
          <div class="error-icon">L·ªói</div>
          <h3>C√≥ l·ªói x·∫£y ra</h3>
          <p>{{ errorMessage }}</p>
          <button class="retry-btn" (click)="loadPlantData()">Th·ª≠ l·∫°i</button>
        </div>
      </div>
    }

    <!-- Update Form -->
    @if (!isLoading && !errorMessage && currentPlant) {
      <div class="form-section">

      <!-- Two Column Layout -->
      <div class="two-column-layout">
        <!-- Left Column - Images -->
        <div class="images-column">
          <div class="plant-info-card">
            <div class="plant-images-section">
              <!-- Current Images Display -->
              <div class="current-images" style="margin-bottom: 18px;">
                @if (getAllPlantImageUrls().length > 0) {
                  <div class="plant-img-list">
                    @for (img of getAllPlantImageUrls().slice(0, 3); track img) {
                      <img [src]="getImageUrl(img)" alt="·∫¢nh c√¢y hi·ªán t·∫°i" class="plant-img square-img" (error)="onImageError($event)" />
                    }
                  </div>
                } @else {
                  <div class="no-image-placeholder">
                    <span class="placeholder-icon">üå±</span>
                    <span class="placeholder-text">Ch∆∞a c√≥ ·∫£nh</span>
                  </div>
                }
              </div>
              
              <!-- Image Update Controls -->
              <div class="image-update-controls">
                <input 
                  type="file" 
                  id="update-images"
                  name="update-images"
                  accept="image/*"
                  multiple
                  (change)="onImageSelected($event)"
                  class="file-input"
                  style="display: none;"
                />
                
                <!-- Compact Upload Area -->
                <div class="compact-upload-area" (click)="triggerFileInput()">
                  <div class="upload-content">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="upload-icon">
                      <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                      <path d="M12,11L16,15H13V19H11V15H8L12,11Z"/>
                    </svg>
                    <span class="upload-text">C·∫≠p nh·∫≠t ·∫£nh c√¢y</span>
                  </div>
                </div>
                
                @if (selectedImages && selectedImages.length > 0) {
                  <button type="button" class="clear-btn" (click)="clearSelectedImages()" title="X√≥a ·∫£nh ƒë√£ ch·ªçn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                    </svg>
                  </button>
                }
              </div>
              
              <!-- Compact Preview for Selected Images -->
              @if (selectedImages && selectedImages.length > 0) {
                <div class="selected-images-preview">
                  <div class="preview-header">
                    <span class="preview-label">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z"/>
                      </svg>
                      ·∫¢nh m·ªõi ({{ selectedImages.length }}) - {{ getTotalFileSize() }}
                    </span>
                  </div>
                  <div class="preview-grid">
                    @for (image of selectedImages; track image; let i = $index) {
                      <div class="preview-item">
                        <img [src]="getImagePreview(image)" [alt]="'·∫¢nh m·ªõi ' + (i + 1)" class="preview-img">
                        <button type="button" class="remove-btn" (click)="removeSelectedImage(i)" title="X√≥a">
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                          </svg>
                        </button>
                      </div>
                    }
                  </div>
                  
                  <!-- N√∫t c·∫≠p nh·∫≠t ·∫£nh ri√™ng bi·ªát -->
                  <div class="image-update-actions">
                    <button 
                      type="button" 
                      class="btn btn-update-images"
                      (click)="updateImagesOnly()"
                      [disabled]="isUpdatingImages"
                    >
                      @if (isUpdatingImages) {
                        <span class="btn-loading"></span>
                      }
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z"/>
                      </svg>
                      <span>{{ isUpdatingImages ? 'ƒêang c·∫≠p nh·∫≠t...' : 'C·∫≠p nh·∫≠t ·∫£nh' }}</span>
                    </button>
                  </div>
                  
                  <small class="update-note">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z"/>
                    </svg>
                    B·∫•m "C·∫≠p nh·∫≠t ·∫£nh" ƒë·ªÉ l∆∞u ·∫£nh m·ªõi, ho·∫∑c "C·∫≠p nh·∫≠t th√¥ng tin" ƒë·ªÉ l∆∞u t·∫•t c·∫£ thay ƒë·ªïi  
                  </small>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Right Column - Form -->
        <div class="form-column">
          <div class="form-card">
            <div class="form-header">
              <h3>Th√¥ng tin c√¢y</h3>      
            </div>

            <form [formGroup]="updateForm" (ngSubmit)="onSubmit()" class="update-form">
              <div class="form-grid">
                <!-- Nickname Field -->
                <div class="form-group">
                  <label for="nickname" class="form-label">
                    T√™n g·ªçi <span class="required">*</span>
                  </label>
                  <input
                    type="text"
                    id="nickname"
                    formControlName="nickname"
                    class="form-input"
                    [class.error]="isFieldInvalid('nickname')"
                    placeholder="Nh·∫≠p t√™n g·ªçi cho c√¢y c·ªßa b·∫°n"
                    maxlength="100"
                  />
                  @if (isFieldInvalid('nickname')) {
                    <div class="error-message">
                      {{ getFieldError('nickname') }}
                    </div>
                  }
                </div>

                <!-- Location Field -->
                <div class="form-group">
                  <label for="locationInHouse" class="form-label">
                    V·ªã tr√≠ trong nh√† <span class="required">*</span>
                  </label>
                  <select
                    id="locationInHouse"
                    formControlName="locationInHouse"
                    class="form-input"
                    [class.error]="isFieldInvalid('locationInHouse')"
                    required>
                    <option value="">-- Ch·ªçn v·ªã tr√≠ --</option>
                    <option *ngFor="let option of locationOptions" [value]="option.value">
                      {{ option.label }}
                    </option>
                  </select>
                  @if (isFieldInvalid('locationInHouse')) {
                    <div class="error-message">
                      {{ getFieldError('locationInHouse') }}
                    </div>
                  }
                </div>

                <!-- Planting Date Field -->
                <div class="form-group">
                  <label for="plantingDate" class="form-label">
                    Ng√†y tr·ªìng <span class="required">*</span>
                  </label>
                  <input
                    type="date"
                    id="plantingDate"
                    formControlName="plantingDate"
                    class="form-input"
                    [class.error]="isFieldInvalid('plantingDate')"
                  />
                  @if (isFieldInvalid('plantingDate')) {
                    <div class="error-message">
                      {{ getFieldError('plantingDate') }}
                    </div>
                  }
                </div>

              </div>

              <!-- Form Actions -->
              <div class="form-actions">
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="updateForm.invalid || isSubmitting"
                >
                  @if (isSubmitting) {
                    <span class="btn-loading"></span>
                  }
                  <span>{{ isSubmitting ? 'ƒêang c·∫≠p nh·∫≠t...' : 'C·∫≠p nh·∫≠t th√¥ng tin' }}</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      </div>
    }
  </div>
</div>
