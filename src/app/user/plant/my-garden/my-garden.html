<app-top-navigator></app-top-navigator>

<div class="garden-container" (click)="onPageVisible()" style="margin-bottom: 64px; padding-bottom: 32px;">
  <!-- Hero Section -->
  <section class="garden-hero">
    <div class="hero-content">
      <div class="hero-header">
        <h1 class="hero-title">üåø Khu V∆∞·ªùn C·ªßa T√¥i</h1>
        <div class="hero-actions">
          @if (isLoggedIn) {
            <button 
              class="create-plant-btn primary"
              (click)="router.navigate(['/user/create-new-plant'])"
            >
              <i class="fas fa-plus"></i>
              <span>T·∫°o c√¢y m·ªõi</span>
            </button>
            <button 
              class="add-existing-btn secondary"
              (click)="router.navigate(['/plant-info'])"
            >
              <i class="fas fa-search"></i>
              <span>Th√™m t·ª´ th∆∞ vi·ªán</span>
            </button>
          }
        </div>
      </div>
      <p class="hero-subtitle">Qu·∫£n l√Ω v√† chƒÉm s√≥c b·ªô s∆∞u t·∫≠p c√¢y c·∫£nh c√° nh√¢n c·ªßa b·∫°n</p>
      
      <!-- Statistics - Only show when user has plants -->
      @if (!loading && !error && userPlants.length > 0) {
        <div class="garden-stats">
          <div class="stat-item">
            <div class="stat-icon">üå±</div>
            <div class="stat-content">
              <div class="stat-number">{{ userPlants.length }}</div>
              <div class="stat-label">T·ªïng s·ªë c√¢y</div>
            </div>
          </div>
          <!-- ƒê√£ xo√° th·ªëng k√™ nh·∫Øc nh·ªü -->
        </div>
      }
    </div>
  </section>

  <!-- Controls -->
  @if (!loading && !error && userPlants.length > 0) {
    <section class="garden-controls">
      <div class="controls-wrapper">
        <div class="view-controls">
          <button 
            [class.active]="layout === 'garden'" 
            (click)="layout = 'garden'"
            class="control-btn garden-view"
          >
            <span class="btn-icon">üå±</span>
            <span>Khu V∆∞·ªùn</span>
          </button>
          <button 
            [class.active]="layout === 'grid'" 
            (click)="layout = 'grid'"
            class="control-btn grid-view"
          >
            <span class="btn-icon">‚äû</span>
            <span>L∆∞·ªõi</span>
          </button>
          <button 
            [class.active]="layout === 'list'" 
            (click)="layout = 'list'"
            class="control-btn list-view"
          >
            <span class="btn-icon">‚ò∞</span>
            <span>Danh s√°ch</span>
          </button>
        </div>

        <div class="filter-controls">
          <button 
            [class.active]="filter === 'all'" 
            (click)="filter = 'all'"
            class="filter-btn"
          >
            T·∫•t c·∫£
          </button>
        </div>
      </div>
    </section>
  }

  <!-- Loading State -->
  @if (loading) {
    <div class="loading-garden">
      <div class="loading-animation">
        <div class="growing-plant">
          <div class="plant-stem"></div>
          <div class="plant-leaves">
            <div class="leaf leaf-1">üåø</div>
            <div class="leaf leaf-2">üçÉ</div>
            <div class="leaf leaf-3">üå±</div>
          </div>
        </div>
      </div>
      <p class="loading-text">ƒêang t·∫£i khu v∆∞·ªùn c·ªßa b·∫°n...</p>
    </div>
  }

  <!-- Error State -->
  @if (error && !loading) {
    <div class="error-garden">
      <div class="error-icon">ü•Ä</div>
      <h3>{{ error.includes('ƒëƒÉng nh·∫≠p') ? 'C·∫ßn ƒëƒÉng nh·∫≠p' : 'Oops! C√≥ l·ªói x·∫£y ra' }}</h3>
      <p>{{ error }}</p>
      <div class="error-actions">
        @if (error.includes('ƒëƒÉng nh·∫≠p')) {
          <button 
            class="auth-btn"
            (click)="handleAuthRequired()"
          >
            <span>üîë</span> ƒêƒÉng nh·∫≠p
          </button>
        } @else {
          <button 
            class="retry-btn" 
            (click)="refreshGarden()"
            [disabled]="loading"
          >
            <span>üîÑ</span> {{ loading ? 'ƒêang th·ª≠ l·∫°i...' : 'Th·ª≠ l·∫°i' }}
          </button>
        }
      </div>
    </div>
  }

  <!-- Empty State -->
  @if (!loading && !error && userPlants.length === 0) {
    <div class="empty-garden">
      <div class="empty-illustration">
        <div class="empty-pot">
          <div class="pot-body"></div>
          <div class="pot-soil"></div>
          <div class="sprouting-seed">üå±</div>
        </div>
      </div>
      <div class="empty-content">
        <h3>{{ isLoggedIn ? 'Khu v∆∞·ªùn c·ªßa b·∫°n ƒëang tr·ªëng' : 'Ch√†o m·ª´ng ƒë·∫øn v·ªõi My Garden!' }}</h3>
        <p>{{ isLoggedIn ? 'H√£y b·∫Øt ƒë·∫ßu tr·ªìng nh·ªØng c√¢y c·∫£nh y√™u th√≠ch ƒë·ªÉ t·∫°o n√™n khu v∆∞·ªùn xanh t∆∞∆°i!' : 'ƒêƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu t·∫°o khu v∆∞·ªùn xanh c·ªßa ri√™ng b·∫°n!' }}</p>
        @if (isLoggedIn) {
          <div class="empty-actions">
            <button 
              class="start-gardening-btn primary"
              (click)="router.navigate(['/user/create-new-plant'])"
            >
              <i class="fas fa-plus"></i>
              <span>T·∫°o c√¢y m·ªõi</span>
            </button>
            <button 
              class="browse-plants-btn secondary" 
              (click)="router.navigate(['/plant-info'])"
            >
              <i class="fas fa-search"></i>
              <span>Ch·ªçn t·ª´ th∆∞ vi·ªán</span>
            </button>
          </div>
        } @else {
          <button 
            class="start-gardening-btn primary" 
            (click)="handleAuthRequired()"
          >
            <i class="fas fa-sign-in-alt"></i>
            <span>ƒêƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu</span>
          </button>
        }
      </div>
    </div>
  }

  <!-- Plants Display -->
  @if (!loading && !error && userPlants.length > 0) {
    <div class="plants-display">
      
      <!-- Garden Layout -->
      @if (layout === 'garden') {
        <div class="garden-layout">
          <div class="garden-ground">
            <div class="plants-garden">
              @for (plant of filteredPlants; track plant.userPlantId; let i = $index) {
                <div 
                  class="plant-spot"
                  [style.animation-delay]="i * 0.1 + 's'"
                >
                  <div class="plant-container" (click)="viewPlantDetail(plant.userPlantId)">
                    <div class="plant-image-wrapper">
                      <div class="plant-image-container">
                        @if (plant.imageUrl) {
                          <img 
                            [src]="plant.imageUrl" 
                            [alt]="plant.nickname"
                            class="plant-image"
                            (error)="$any($event.target).style.display='none'"
                          />
                        } @else {
                          <div class="plant-placeholder">
                            <i class="fas fa-seedling"></i>
                          </div>
                        }
                      </div>
                      <div class="plant-glow"></div>
                    </div>
                    
                    <div class="plant-info">
                      <h3 class="plant-name">{{ plant.nickname || 'C√¢y kh√¥ng t√™n' }}</h3>
                      
                      <div class="plant-details">
                        <div class="detail-row">
                          <span class="detail-icon">
                            <i class="fas fa-map-marker-alt"></i>
                          </span>
                          <span class="detail-text">{{ plant.plantLocation || 'Ch∆∞a x√°c ƒë·ªãnh' }}</span>
                        </div>
                        <!-- Nh·∫Øc nh·ªü chƒÉm s√≥c: chuy·ªÉn l√™n g√≥c tr√™n b√™n ph·∫£i -->
                        <div class="reminder-floating-btns">
                          <button type="button" class="reminder-icon-btn" [class.active]="plant.reminderEnabled" (click)="toggleAllReminders(plant); $event.stopPropagation()" title="{{ plant.reminderEnabled ? 'T·∫Øt t·∫•t c·∫£ nh·∫Øc nh·ªü' : 'B·∫≠t t·∫•t c·∫£ nh·∫Øc nh·ªü' }}">
                            <i class="fas" [ngClass]="plant.reminderEnabled ? 'fa-bell' : 'fa-bell-slash'"></i>
                          </button>
                          <button type="button" class="reminder-icon-btn outline" (click)="openReminderTypeDialog(plant); $event.stopPropagation()" title="Tu·ª≥ ch·ªânh nh·∫Øc nh·ªü">
                            <i class="fas fa-sliders-h"></i>
                          </button>
                        </div>
                      </div>
                      
                      <div class="plant-actions">
                        <button class="action-btn care-btn" (click)="carePlant(plant.plantId); $event.stopPropagation()">
                          <i class="fas fa-heart"></i>
                          <span>ChƒÉm s√≥c</span>
                        </button>
                        <button class="action-btn edit-btn" (click)="editPlant(plant.plantId, plant.nickname); $event.stopPropagation()">
                          <i class="fas fa-edit"></i>
                          <span>S·ª≠a</span>
                        </button>
                        <button class="action-btn remove-btn" (click)="removePlantFromCollection(plant.plantId); $event.stopPropagation()">
                          <i class="fas fa-trash"></i>
                          <span>X√≥a</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      }

      <!-- Grid Layout -->
      @if (layout === 'grid') {
        <div class="grid-layout">
          <div class="plants-grid">
            @for (plant of filteredPlants; track plant.userPlantId; let i = $index) {
              <div 
                class="plant-card"
                [style.animation-delay]="i * 0.1 + 's'"
              >
                <div class="card-header">
                  <div class="plant-image-container">
                    @if (plant.imageUrl) {
                      <img 
                        [src]="plant.imageUrl" 
                        [alt]="plant.nickname"
                        class="plant-image"
                        (error)="$any($event.target).style.display='none'"
                        (click)="viewPlantDetail(plant.userPlantId)"
                        style="cursor: pointer;"
                      />
                    } @else {
                      <div class="plant-placeholder" (click)="viewPlantDetail(plant.userPlantId)" style="cursor: pointer;">
                        <div class="placeholder-icon">
                          <i class="fas fa-seedling"></i>
                        </div>
                      </div>
                    }
                  </div>
                </div>
                
                <div class="card-body" (click)="viewPlantDetail(plant.userPlantId)" style="cursor: pointer;">
                  <h3 class="plant-title">{{ plant.nickname || 'C√¢y kh√¥ng t√™n' }}</h3>
                  
                  <div class="plant-meta">
                    <div class="meta-item">
                      <span class="meta-icon">
                        <i class="fas fa-map-marker-alt"></i>
                      </span>
                      <span class="meta-text">{{ plant.plantLocation || 'Ch∆∞a x√°c ƒë·ªãnh' }}</span>
                    </div>
                    <div class="reminder-toggle-row">
                      <span class="reminder-label">Nh·∫Øc nh·ªü:</span>
                      <button type="button" class="reminder-toggle-btn" [class.active]="plant.reminderEnabled" (click)="toggleAllReminders(plant); $event.stopPropagation()">
                        {{ plant.reminderEnabled ? 'ƒêang b·∫≠t t·∫•t c·∫£' : 'ƒêang t·∫Øt t·∫•t c·∫£' }}
                      </button>
                      <button type="button" class="reminder-type-btn" (click)="openReminderTypeDialog(plant); $event.stopPropagation()">
                        Tu·ª≥ ch·ªânh t·ª´ng lo·∫°i
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="card-footer">
                  <button 
                    class="card-btn secondary"
                    (click)="editPlant(plant.plantId, plant.nickname)"
                  >
                    <i class="fas fa-edit"></i>
                    <span>S·ª≠a</span>
                  </button>
                  <button 
                    class="card-btn danger"
                    (click)="removePlantFromCollection(plant.plantId)"
                  >
                    <i class="fas fa-trash"></i>
                    <span>X√≥a</span>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- List Layout -->
      @if (layout === 'list') {
        <div class="list-layout">
          <div class="plants-list">
            @for (plant of filteredPlants; track plant.userPlantId; let i = $index) {
              <div 
                class="plant-list-item"
                [style.animation-delay]="i * 0.05 + 's'"
              >
                <div class="list-item-image">
                  <img 
                    src="/assets/image/logo.png" 
                    [alt]="plant.nickname"
                  />
                </div>
                
                <div class="list-item-content" (click)="viewPlantDetail(plant.userPlantId)" style="cursor: pointer;">
                  <div class="content-header">
                    <h3 class="plant-name">{{ plant.nickname }}</h3>
                    <div class="plant-age">ƒê√£ tr·ªìng</div>
                  </div>
                  
                  <div class="content-details">
                    <div class="detail-group">
                      <span class="detail-icon">üìç</span>
                      <span>{{ plant.plantLocation }}</span>
                    </div>
                    <div class="detail-group">
                      <span class="detail-icon">üìÖ</span>
                      <span>ƒê∆∞·ª£c th√™m v√†o v∆∞·ªùn</span>
                    </div>
                    <div class="reminder-toggle-row">
                      <span class="reminder-label">Nh·∫Øc nh·ªü:</span>
                      <button type="button" class="reminder-toggle-btn" [class.active]="plant.reminderEnabled" (click)="toggleAllReminders(plant); $event.stopPropagation()">
                        {{ plant.reminderEnabled ? 'ƒêang b·∫≠t t·∫•t c·∫£' : 'ƒêang t·∫Øt t·∫•t c·∫£' }}
                      </button>
                      <button type="button" class="reminder-type-btn" (click)="openReminderTypeDialog(plant); $event.stopPropagation()">
                        Tu·ª≥ ch·ªânh t·ª´ng lo·∫°i
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="list-item-actions">
                  <button 
                    class="list-action-btn edit"
                    (click)="editPlant(plant.plantId, plant.nickname)"
                  >
                    <span>‚úèÔ∏è</span> S·ª≠a
                  </button>
                  <button 
                    class="list-action-btn remove"
                    (click)="removePlantFromCollection(plant.plantId)"
                  >
                    <span>üóëÔ∏è</span> X√≥a
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>

<!-- Confirmation Dialog -->
<app-confirmation-dialog></app-confirmation-dialog>

<!-- Dialog tu·ª≥ ch·ªânh nh·∫Øc nh·ªü t·ª´ng lo·∫°i -->
@if (showCareReminderDialog) {
  <app-care-reminder-dialog
    [schedules]="careReminderDialogSchedules"
    (save)="onCareReminderDialogSave($event)"
    (close)="onCareReminderDialogClose()"
  ></app-care-reminder-dialog>
}
