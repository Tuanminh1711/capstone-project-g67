<app-top-navigator></app-top-navigator>

<div class="edit-profile-page">
  <div class="edit-profile-container">
    <!-- Header -->
    <div class="page-header">
      <h1>CHỈNH SỬA HỒ SƠ</h1>
      <p>Cập nhật thông tin cá nhân và ảnh đại diện của bạn</p>
    </div>

    <div *ngIf="!loading; else loadingTpl">
      <!-- Show beautiful login prompt if not authenticated -->
      <div *ngIf="saveError && !user.id" class="login-prompt-container">
        <div class="login-prompt-card">
          <div class="login-prompt-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
            </svg>
          </div>
          
          <div class="login-prompt-content">
            <h2>Đăng nhập để tiếp tục</h2>
            <p>Bạn cần đăng nhập để có thể chỉnh sửa thông tin hồ sơ cá nhân</p>
            
            <button type="button" class="login-prompt-button" (click)="showLoginDialog()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M10,17V14H3V10H10V7L15,12L10,17M10,2H19A2,2 0 0,1 21,4V20A2,2 0 0,1 19,22H10A2,2 0 0,1 8,20V18H10V20H19V4H10V6H8V4A2,2 0 0,1 10,2Z"/>
              </svg>
              Đăng nhập ngay
            </button>
          </div>
          
          <div class="login-prompt-features">
            <div class="feature-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/>
              </svg>
              <span>Cập nhật thông tin cá nhân</span>
            </div>
            <div class="feature-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/>
              </svg>
              <span>Thay đổi ảnh đại diện</span>
            </div>
            <div class="feature-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/>
              </svg>
              <span>Quản lý bảo mật tài khoản</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Show profile content if user loaded -->
      <div *ngIf="user.id" class="edit-profile-content">
        <!-- Avatar Section (merged logic/UI) -->
        <div class="avatar-section">
          <div class="avatar-card">
            <h3>Ảnh đại diện</h3>
            <div class="avatar-upload-area">
              <div class="avatar-preview" (click)="avatarInput.click()" [class.uploading]="avatarUploading">
                @if ((avatarPreview || user.avatar) && !avatarUploading) {
                  <img [src]="avatarPreview || user.avatar" alt="avatar" />
                }
                @if (!avatarPreview && !user.avatar && !avatarUploading) {
                  <div class="avatar-placeholder">
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                    </svg>
                  </div>
                }
                @if (avatarUploading) {
                  <div class="avatar-loading">
                    <div class="loading-spinner"></div>
                    <span>Đang tải...</span>
                  </div>
                }
                @if (!avatarUploading) {
                  <div class="upload-overlay">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    <span>Thay đổi ảnh</span>
                  </div>
                }
              </div>
              <input #avatarInput type="file" accept="image/jpeg,image/jpg,image/png,image/gif" (change)="onAvatarChange($event)" style="display:none" [disabled]="avatarUploading" />
              <!-- Thêm cropper khi có ảnh mới -->
              <div *ngIf="showCropper">
                <div class="cropper-overlay"></div>
                <div class="cropper-modal">
                  <div class="cropper-header">Cắt & chỉnh ảnh đại diện</div>
                  <image-cropper
                    #imageCropper
                    [imageChangedEvent]="imageChangedEvent"
                    [maintainAspectRatio]="true"
                    [aspectRatio]="1/1"
                    [resizeToWidth]="256"
                    format="png"
                    (imageCropped)="onImageCropped($event)"
                    (imageLoaded)="onImageLoaded()"
                    (cropperReady)="onCropperReady()"
                    (loadImageFailed)="onCropperLoadFail()"
                  ></image-cropper>
                  <div class="cropper-actions">
                    <button type="button" class="update-avatar-btn highlight" (click)="confirmCroppedAvatar()" [disabled]="!croppedImage">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right:6px;vertical-align:middle;">
                        <path d="M5,20H19A2,2 0 0,0 21,18V8A2,2 0 0,0 19,6H15.82C15.4,4.84 14.3,4 13,4H11C9.7,4 8.6,4.84 8.18,6H5A2,2 0 0,0 3,8V18A2,2 0 0,0 5,20M12,7A2,2 0 1,1 10,9A2,2 0 0,1 12,7M5,8H19V18H5Z" />
                      </svg>
                      <span style="font-weight:600;letter-spacing:0.5px;">Xác nhận ảnh</span>
                    </button>
                    <button type="button" class="update-avatar-btn" (click)="cancelCropper()" style="margin-left:10px;">Huỷ</button>
                  </div>
                </div>
              </div>
            </div>
            <div style="text-align:center; margin-top: 12px;">
              @if (selectedAvatarFile && !avatarUploading && !showCropper) {
                <button type="button" class="update-avatar-btn highlight" (click)="uploadAvatar()">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right:6px;vertical-align:middle;">
                    <path d="M5,20H19A2,2 0 0,0 21,18V8A2,2 0 0,0 19,6H15.82C15.4,4.84 14.3,4 13,4H11C9.7,4 8.6,4.84 8.18,6H5A2,2 0 0,0 3,8V18A2,2 0 0,0 5,20M12,7A2,2 0 1,1 10,9A2,2 0 0,1 12,7M5,8H19V18H5Z" />
                  </svg>
                  <span style="font-weight:600;letter-spacing:0.5px;">Lưu ảnh đại diện</span>
                </button>
              }
              @if (avatarUploading) {
                <button type="button" class="update-avatar-btn highlight" disabled>
                  <span>Đang cập nhật...</span>
                </button>
              }
            </div>
            @if (showAvatarFormatError) {
              <div class="avatar-info">
                <p class="avatar-guidelines error">
                  <strong>❌ Lỗi định dạng:</strong><br>
                  • Kích thước tối đa: 5MB<br>
                  • Định dạng hỗ trợ: JPG, PNG, GIF<br>
                  • Vui lòng chọn lại file phù hợp
                </p>
              </div>
            }
          </div>
        </div>

        <!-- Profile Information Section -->
        <div class="profile-info-section">
          <div class="profile-info-card">
            <h3>Thông tin cá nhân</h3>
            <form (ngSubmit)="save();" #profileForm="ngForm">
              <div class="form-grid">
                <div class="form-group full-width">
                  <label for="fullName">Họ và tên <span class="required">*</span></label>
                  <input 
                    type="text" 
                    id="fullName"
                    [(ngModel)]="user.fullName" 
                    name="fullName" 
                    placeholder="Nhập họ và tên đầy đủ" 
                    required 
                    #fullNameInput="ngModel"
                    maxlength="100"
                    (blur)="validateFullName()" />
                  <div *ngIf="fullNameInput.invalid && fullNameInput.touched" class="field-error">
                    Họ tên là bắt buộc
                  </div>
                </div>

                <div class="form-group">
                  <label for="email">Email</label>
                  <input 
                    type="email" 
                    id="email"
                    [(ngModel)]="user.email" 
                    name="email" 
                    placeholder="Email" 
                    readonly 
                    class="readonly-input" />
                  <small class="field-note">Email không thể thay đổi</small>
                </div>

                <div class="form-group">
                  <label for="phoneNumber">Số điện thoại <span class="required">*</span></label>
                  <input 
                    type="text" 
                    id="phoneNumber"
                    [(ngModel)]="user.phoneNumber" 
                    name="phoneNumber" 
                    placeholder="Nhập số điện thoại" 
                    required 
                    #phoneInput="ngModel"
                    pattern="[0-9]{10,11}"
                    maxlength="11"
                    (blur)="validatePhoneNumber()"
                    readonly
                    class="readonly-input" />
                  <div *ngIf="phoneInput.invalid && phoneInput.touched" class="field-error">
                    Số điện thoại không hợp lệ (10-11 số)
                  </div>
                </div>

                <div class="form-group">
                  <label for="gender">Giới tính</label>
                  <select id="gender" [(ngModel)]="user.gender" name="gender">
                    <option value="MALE">Nam</option>
                    <option value="FEMALE">Nữ</option>
                    <option value="OTHER">Khác</option>
                  </select>
                </div>

                <div class="form-group full-width">
                  <label for="livingEnvironment">Môi trường sống</label>
                  <input 
                    type="text" 
                    id="livingEnvironment"
                    [(ngModel)]="user.livingEnvironment" 
                    name="livingEnvironment" 
                    placeholder="VD: Chung cư, Nhà riêng, Biệt thự..." 
                    maxlength="50" />
                </div>
              </div>

              <!-- Success/Error Messages -->
              <div *ngIf="saveMessage" class="success-message">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/>
                </svg>
                {{ saveMessage }}
              </div>
              <div *ngIf="saveError" class="error-message">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M13,13H11V7H13M11,15H13V17H11M15.73,3H8.27L3,8.27V15.73L8.27,21H15.73L21,15.73V8.27L15.73,3Z"/>
                </svg>
                {{ saveError }}
              </div>

              <div class="form-actions">
                

                <button 
                  type="submit" 
                  class="save-button"
                  [disabled]="saving || profileForm.invalid">
                  <span *ngIf="saving" class="loading-spinner"></span>
                  <svg *ngIf="!saving" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/>
                  </svg>
                  <span *ngIf="saving">Đang lưu...</span>
                  <span *ngIf="!saving">Lưu thông tin</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <ng-template #loadingTpl>
      <div class="loading-container">
        <div class="loading-spinner large"></div>
        <p>Đang tải thông tin hồ sơ...</p>
      </div>
    </ng-template>
  </div>
</div>
