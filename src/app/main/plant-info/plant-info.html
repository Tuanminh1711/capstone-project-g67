<app-top-navigator></app-top-navigator>

<div class="plant-info-layout">
  <div class="plant-info-inner">
    <!-- Sidebar -->
    <aside class="sidebar">
      <mat-accordion multi class="sidebar-menu">
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <span>Danh mục</span>
          </mat-expansion-panel-header>
          @if (loadingCategories) {
            <div class="sidebar-loading">Đang tải danh mục...</div>
          }
          @if (errorCategories) {
            <div class="sidebar-error">{{ errorCategories }}</div>
          }
          @if (!loadingCategories) {
            <a class="sidebar-item" href="#" [class.active]="!selectedCategoryId" (click)="handleAllCategoryClick(); $event.preventDefault()">
              Tất cả
            </a>
            @if (categories$ | async; as categories) {
              @if (categories.length > 0) {
                @for (cat of categories; track trackByCatId($index, cat)) {
                  <a class="sidebar-item" href="#" [class.active]="selectedCategoryId === cat.id" (click)="handleCategoryClick(cat.id); $event.preventDefault()">
                    {{ translateCategoryName(cat.name) }}
                  </a>
                }
              }
            }
          }
        </mat-expansion-panel>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <span>Ánh sáng</span>
          </mat-expansion-panel-header>
          <a href="#" class="sidebar-item" [class.active]="!selectedLightRequirement" (click)="handleLightFilter(null); $event.preventDefault()">Tất cả</a>
          <a href="#" class="sidebar-item" [class.active]="selectedLightRequirement === 'LOW'" (click)="handleLightFilter('LOW'); $event.preventDefault()">Ít ánh sáng</a>
          <a href="#" class="sidebar-item" [class.active]="selectedLightRequirement === 'MEDIUM'" (click)="handleLightFilter('MEDIUM'); $event.preventDefault()">Ánh sáng vừa phải</a>
          <a href="#" class="sidebar-item" [class.active]="selectedLightRequirement === 'HIGH'" (click)="handleLightFilter('HIGH'); $event.preventDefault()">Nhiều ánh sáng</a>
        </mat-expansion-panel>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <span>Nước</span>
          </mat-expansion-panel-header>
          <a href="#" class="sidebar-item" [class.active]="!selectedWaterRequirement" (click)="handleWaterFilter(null); $event.preventDefault()">Tất cả</a>
          <a href="#" class="sidebar-item" [class.active]="selectedWaterRequirement === 'LOW'" (click)="handleWaterFilter('LOW'); $event.preventDefault()">Ít nước</a>
          <a href="#" class="sidebar-item" [class.active]="selectedWaterRequirement === 'MEDIUM'" (click)="handleWaterFilter('MEDIUM'); $event.preventDefault()">Nước vừa phải</a>
          <a href="#" class="sidebar-item" [class.active]="selectedWaterRequirement === 'HIGH'" (click)="handleWaterFilter('HIGH'); $event.preventDefault()">Nhiều nước</a>
        </mat-expansion-panel>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <span>Độ khó</span>
          </mat-expansion-panel-header>
          <a href="#" class="sidebar-item" [class.active]="!selectedCareDifficulty" (click)="handleDifficultyFilter(null); $event.preventDefault()">Tất cả</a>
          <a href="#" class="sidebar-item" [class.active]="selectedCareDifficulty === 'EASY'" (click)="handleDifficultyFilter('EASY'); $event.preventDefault()">Dễ chăm sóc</a>
          <a href="#" class="sidebar-item" [class.active]="selectedCareDifficulty === 'MODERATE'" (click)="handleDifficultyFilter('MODERATE'); $event.preventDefault()">Trung bình</a>
          <a href="#" class="sidebar-item" [class.active]="selectedCareDifficulty === 'DIFFICULT'" (click)="handleDifficultyFilter('DIFFICULT'); $event.preventDefault()">Khó chăm sóc</a>
        </mat-expansion-panel>
      </mat-accordion>
    </aside>

    <!-- Main content -->
    <section class="plant-search-section">
      <div class="plant-search-card">

        <!-- Search box -->
        <form class="plant-search-box full-width" (ngSubmit)="onSearch()">
          <input
            type="text"
            class="plant-search-input"
            placeholder="Tìm kiếm cây..."
            [(ngModel)]="searchText"
            name="searchText"
            (ngModelChange)="onSearchInputChange()"
          />
          <button class="plant-search-btn" type="submit">
            <span class="material-icons">search</span>
          </button>
        </form>

        <div class="plant-warning-reference">
          <i class="fas fa-exclamation-triangle"></i>
          Các thông tin chăm sóc chỉ mang tính chất tham khảo, vui lòng cẩn thận khi sử dụng với các cây quý và những cây có giá trị cao
        </div>

        <!-- Loading -->

        @if (loading) {
          <div class="status-msg">Đang tải dữ liệu...</div>
        }

        <!-- Error -->
        @if (!loading && error) {
          <div class="status-msg error">
            {{ error }}
          </div>
        }


        <!-- Nội dung chính -->
        @if (!loading && !error) {
          @if (plants$ | async; as plants) {
            
            <!-- Không có cây -->
            @if (plants.length === 0) {
              <div class="status-msg empty">
                Không có cây nào phù hợp.
              </div>
            }

            <!-- Danh sách cây -->
            @if (plants.length > 0) {
              <div class="plant-list">
                @for (plant of plants; track trackByPlantId($index, plant)) {
                  <div class="plant-card">
                    <img
                      *ngIf="plant.imageUrls && plant.imageUrls.length > 0 && !plant.imageError"
                      [src]="getPlantImageSrc(plant.imageUrls[0])"
                      [alt]="plant.commonName"
                      class="plant-img"
                      (click)="viewPlantDetail(plant.id)"
                      (error)="plant.imageError = true"
                    />
                    <div
                      *ngIf="!plant.imageUrls || plant.imageUrls.length === 0 || plant.imageError"
                      class="no-image-placeholder"
                      (click)="viewPlantDetail(plant.id)"
                    >
                      <i class="fas fa-seedling"></i>
                      <span>Chưa có ảnh</span>
                    </div>
                    <div class="plant-info" (click)="viewPlantDetail(plant.id)">
                      <div class="plant-title">
                        <span class="plant-common-name" title="{{ plant.commonName }}">
                          {{ plant.commonName.length > 32 ? (plant.commonName | slice:0:32) + '…' : plant.commonName }}
                        </span>
                        <span class="plant-scientific" title="{{ plant.scientificName }}">
                          ({{ plant.scientificName.length > 32 ? (plant.scientificName | slice:0:32) + '…' : plant.scientificName }})
                          @if (plant.status === 'INACTIVE') {
                            <span class="plant-warning-icon tooltip-container" title="Cây này đang được xác thực thông tin bởi hệ thống">
                              <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
                                <circle cx="10" cy="10" r="10" fill="#ffe066"/>
                                <path d="M10 5v5.5" stroke="#bfa100" stroke-width="1.6" stroke-linecap="round"/>
                                <circle cx="10" cy="14.2" r="1.1" fill="#bfa100"/>
                              </svg>
                              <span class="plant-warning-tooltip">Cây này đang được xác thực thông tin bởi hệ thống</span>
                            </span>
                          }
                          @if (plant.reportCount && plant.reportCount > 0) {
                            <span class="plant-warning-icon tooltip-container">
                              <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
                                <circle cx="10" cy="10" r="10" [attr.fill]="getWarningColor(plant.reportCount)"/>
                                <path d="M10 5v5.5" stroke="#bfa100" stroke-width="1.6" stroke-linecap="round"/>
                                <circle cx="10" cy="14.2" r="1.1" fill="#bfa100"/>
                              </svg>
                              <span class="plant-warning-tooltip">Cây này đã bị báo cáo {{ plant.reportCount }} lần</span>
                            </span>
                          }
                        </span>
                      </div>
                      <div class="plant-category">
                        Phân loại: {{ plant.categoryName }}
                      </div>
                      <div class="plant-desc" title="{{ plant.description }}">
                        {{ plant.description.length > 120 ? (plant.description | slice:0:120) + '…' : plant.description }}
                      </div>
                      <div class="plant-meta-simple">
                        <span class="meta-item">
                          <span class="meta-label">Ánh sáng:</span>
                          <span class="meta-value">{{ translateLightRequirement(plant.lightRequirement) }}</span>
                        </span>
                        <span class="meta-item">
                          <span class="meta-label">Nước:</span>
                          <span class="meta-value">{{ translateWaterRequirement(plant.waterRequirement) }}</span>
                        </span>
                        <span class="meta-item">
                          <span class="meta-label">Độ khó:</span>
                          <span class="meta-value">{{ translateCareDifficulty(plant.careDifficulty) }}</span>
                        </span>
                      </div>
                      <div class="plant-actions">
                        <button class="detail-btn" (click)="viewPlantDetail(plant.id); $event.stopPropagation()">
                          Xem chi tiết
                        </button>
                        <button class="report-btn" (click)="onReportPlant(plant.id, $event)" title="Báo cáo thông tin sai" [disabled]="plant.status === 'INACTIVE'">
                          Báo cáo
                        </button>
                      </div>
                    </div>
                  </div>
                }
              </div>
            }

            <!-- Pagination -->
            @if (totalPages > 1) {
              <div class="pagination">
                <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 0">
                  &laquo;
                </button>
                @for (page of [].constructor(totalPages); track $index; let i = $index) {
                  <button
                    (click)="goToPage(i)"
                    [class.active]="i === currentPage"
                  >
                    {{ i + 1 }}
                  </button>
                }
                <button
                  (click)="goToPage(currentPage + 1)"
                  [disabled]="currentPage === totalPages - 1"
                >
                  &raquo;
                </button>
              </div>
            }

          }
        }
      </div>
    </section>
  </div>
</div>