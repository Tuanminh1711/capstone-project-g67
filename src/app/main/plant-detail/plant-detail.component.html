<app-top-navigator></app-top-navigator>
<div class="plant-detail-container">
  <div class="plant-detail-content">
    <!-- Loading state -->
    @if (loading && !plant) {
      <div class="loading-container">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>ƒêang t·∫£i th√¥ng tin c√¢y...</p>
        </div>
      </div>
    }

    <!-- Authentication required message -->
    @if (requiresAuth) {
      <div class="auth-required-msg">
        <div class="auth-card">
          <h3>Y√™u c·∫ßu ƒëƒÉng nh·∫≠p</h3>
          <p>ƒê·ªÉ xem th√¥ng tin chi ti·∫øt c·ªßa c√¢y n√†y, b·∫°n c·∫ßn ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng.</p>
          <div class="auth-actions">
            <button class="login-btn" (click)="goToLogin()">ƒêƒÉng nh·∫≠p</button>
            <button class="back-to-list-btn" (click)="goBack()">Quay l·∫°i danh s√°ch</button>
          </div>
        </div>
      </div>
    }

    <!-- Error state -->
    @if (!loading && error && !plant) {
      <div class="status-msg error">
        {{ error }}
        <button class="retry-btn" (click)="reloadPlantDetail()">Th·ª≠ l·∫°i</button>
      </div>
    }

    <!-- Plant detail content - hi·ªÉn th·ªã ngay khi c√≥ d·ªØ li·ªáu -->
    @if (plant) {
      <!-- Loading overlay khi ƒëang c·∫≠p nh·∫≠t -->
      @if (loading) {
        <div class="loading-overlay">
          <div class="loading-spinner small">
            <div class="spinner"></div>
            <p>ƒêang c·∫≠p nh·∫≠t...</p>
          </div>
        </div>
      }

      <div class="plant-detail-cards modern">
        <!-- Card tr√°i: ·∫¢nh, t√™n, tr·∫°ng th√°i, m√¥ t·∫£, meta -->
        <div class="plant-detail-card modern left-card">
          <div class="plant-info-image modern">
            <div class="main-image">
              <div class="image-wrapper modern">
                <img [src]="selectedImage || latestImages[latestImages.length-1] || '/assets/image/logo.png'" [alt]="plant.commonName" class="plant-img modern" />
              </div>
            </div>
            @if (latestImages.length > 1) {
              <div class="image-gallery modern">
                <div class="gallery-thumbnails">
                  @for (img of latestImages; track img; let i = $index) {
                    <img [src]="img" [alt]="'·∫¢nh ' + (i+1)" class="gallery-thumb" [class.selected-thumb]="img === selectedImage" (click)="selectImage(img)" />
                  }
                </div>
              </div>
            }
          </div>
          <div class="plant-info-main modern">
            <h1 class="plant-name modern">
              {{ plant.commonName }}
              @if (plant.status === 'INACTIVE') {
                <span class="plant-warning-icon" title="C√¢y n√†y ƒëang ƒë∆∞·ª£c x√°c th·ª±c th√¥ng tin b·ªüi h·ªá th·ªëng">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
                    <circle cx="10" cy="10" r="10" fill="#ffe066"/>
                    <path d="M10 5v5.5" stroke="#bfa100" stroke-width="1.6" stroke-linecap="round"/>
                    <circle cx="10" cy="14.2" r="1.1" fill="#bfa100"/>
                  </svg>
                </span>
              }
            </h1>
            <p class="plant-scientific modern">({{ plant.scientificName }})</p>
            <div class="plant-tags modern">
              <span class="plant-category modern">
                <span class="category-icon">üè∑Ô∏è</span>
                {{ plant.categoryName }}
              </span>
            </div>
            <div class="action-buttons modern">
              <button class="add-to-collection-btn modern" (click)="addToCollection()" title="Th√™m c√¢y n√†y v√†o b·ªô s∆∞u t·∫≠p c·ªßa b·∫°n">
                <span class="btn-icon">üå±</span>
                <span class="btn-text">Th√™m v√†o b·ªô s∆∞u t·∫≠p</span>
              </button>
              <button class="report-btn modern" (click)="onReportPlant()" title="B√°o c√°o th√¥ng tin sai">
                <span class="btn-icon">üö©</span>
                <span class="btn-text">B√°o c√°o</span>
              </button>
            </div>
          </div>
          @if (!isGuest) {
            <div class="section-header modern">
              <h3><span class="section-icon">üìù</span> M√¥ t·∫£ chi ti·∫øt</h3>
            </div>
            <div class="description-content modern scroll-card">
              <div class="scroll-inner">
                <p>{{ plant.description || 'Ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt cho lo·∫°i c√¢y n√†y.' }}</p>
              </div>
            </div>
          }
          @if (plant.createdAt) {
            <div class="plant-meta modern">
              <div class="meta-item">
                <span class="meta-icon">üìÖ</span>
                <span class="meta-label">Ng√†y t·∫°o:</span>
                <span class="meta-value">{{ formatDate(plant.createdAt) }}</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon">üîÑ</span>
                <span class="meta-label">C·∫≠p nh·∫≠t g·∫ßn nh·∫•t:</span>
                <span class="meta-value">{{ formatDate(plant.createdAt) }}</span>
              </div>
            </div>
          }
        </div>
        <!-- Card ph·∫£i: Y√™u c·∫ßu chƒÉm s√≥c, h∆∞·ªõng d·∫´n, b·ªánh -->
        <div class="plant-detail-card modern right-card">
          <div class="section-header modern">
            <h3><span class="section-icon">üåø</span>H∆∞·ªõng d·∫´n chƒÉm s√≥c</h3>
          </div>
          <div class="care-requirements modern">
            <div class="care-grid modern">
              @for (item of [
                {
                  icon: '‚òÄÔ∏è',
                  label: '√Ånh s√°ng',
                  value: plantUiHelper.translateLightRequirement(plant.lightRequirement),
                  tips: 'V·ªã tr√≠: ' + plantUiHelper.getLightPosition(plant.lightRequirement),
                  class: 'light-care',
                  indicatorClass: 'light-indicator',
                  show: true
                },
                {
                  icon: 'üíß',
                  label: 'N∆∞·ªõc',
                  value: plantUiHelper.translateWaterRequirement(plant.waterRequirement),
                  tips: 'T·∫ßn su·∫•t: ' + plantUiHelper.getWaterFrequency(plant.waterRequirement),
                  class: 'water-care',
                  indicatorClass: 'water-indicator',
                  show: true
                },
                {
                  icon: 'üå±',
                  label: 'ƒê·ªô kh√≥',
                  value: plantUiHelper.translateCareDifficulty(plant.careDifficulty),
                  tips: plantUiHelper.getDifficultyTip(plant.careDifficulty),
                  class: 'difficulty-care',
                  indicatorClass: plantUiHelper.getDifficultyClass(plant.careDifficulty),
                  show: true
                },
                {
                  icon: 'üè†',
                  label: 'V·ªã tr√≠ ph√π h·ª£p',
                  value: plant.suitableLocation,    
                  class: 'location-care',
                  indicatorClass: 'location-indicator',
                  show: !!plant.suitableLocation
                }
              ]; track item.label) {
                @if (item.show) {
                  <div class="care-item {{item.class}} modern">
                    <div class="care-icon-wrapper modern">
                      <div class="care-icon">{{item.icon}}</div>
                      <div class="care-indicator" [class]="item.indicatorClass"></div>
                    </div>
                    <div class="care-info modern">
                      <span class="care-label">{{item.label}}</span>
                      <span class="care-value">{{item.value}}</span>
                      <div class="care-tips">{{item.tips}}</div>
                    </div>
                  </div>
                }
              }
            </div>
          </div>
          @if (plant.careInstructions && !isGuest) {
            <div class="section-header modern">
              <h3><span class="section-icon">üìã</span> H∆∞·ªõng d·∫´n chƒÉm s√≥c chi ti·∫øt</h3>
            </div>
            <div class="instructions-content modern scroll-card">
              <div class="scroll-inner">
                <p>{{ plant.careInstructions }}</p>
              </div>
            </div>
          }
          @if (plant.commonDiseases && !isGuest) {
            <div class="section-header modern">
              <h3><span class="section-icon">ü©∫</span> B·ªánh th∆∞·ªùng g·∫∑p</h3>
            </div>
            <div class="diseases-content modern">
              <p>{{ plant.commonDiseases }}</p>
            </div>
          }
          <!-- Guest notice for protected content -->
          @if (isGuest && (plant.description || plant.careInstructions || plant.commonDiseases)) {
            <div class="guest-notice-section">
              <div class="auth-required-section">
                <div class="section-header modern">
                  <h3><span class="section-icon">üîí</span> N·ªôi dung c·∫ßn ƒëƒÉng nh·∫≠p</h3>
                </div>
                <div class="auth-notice-content">
                  <p>ƒê·ªÉ xem th√¥ng tin chi ti·∫øt v·ªÅ:</p>
                  <ul>
                    @if (plant.description) {
                      <li>üìù M√¥ t·∫£ chi ti·∫øt v·ªÅ c√¢y</li>
                    }
                    @if (plant.careInstructions) {
                      <li>üìã H∆∞·ªõng d·∫´n chƒÉm s√≥c chi ti·∫øt</li>
                    }
                    @if (plant.commonDiseases) {
                      <li>ü©∫ B·ªánh th∆∞·ªùng g·∫∑p v√† c√°ch ph√≤ng tr√°nh</li>
                    }
                  </ul>
                  <p>Vui l√≤ng ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng.</p>
                  <button class="login-cta-btn" (click)="openLoginDialog()">
                    <span class="btn-icon">üîë</span>
                    <span class="btn-text">ƒêƒÉng nh·∫≠p ngay</span>
                  </button>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }
  </div>
</div>
