<div class="admin-ticket-list-container">
  <div class="ticket-list-header">
    <h2>Danh sách phiếu hỗ trợ</h2>
  <!-- Đã bỏ nút cập nhật -->
  </div>

  <div class="search-bar" style="position:relative;width:100%;max-width:none;margin:0 auto 18px auto;">
    <input 
      type="text" 
      [(ngModel)]="searchText" 
      (input)="onSearch()"
      placeholder="Tìm kiếm phiếu hỗ trợ..."
      class="search-input"
      style="width:100%;padding:16px 48px 16px 20px;border-radius:12px;border:2px solid #e9ecef;font-size:1rem;background:#fff;transition:all 0.3s ease;box-shadow:none;outline:none;"
    >
    <span class="search-icon" style="position:absolute;right:22px;top:50%;transform:translateY(-50%);color:#388e3c;font-size:1.25em;pointer-events:none;background:transparent;z-index:2;">
      <i class="fas fa-search"></i>
    </span>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Đang tải danh sách phiếu hỗ trợ...</p>
  </div>

  <div *ngIf="!isLoading && tickets.length > 0" class="tickets-table-container">
    <table class="tickets-table">
      <thead>
        <tr>
          <th>STT</th>
          <th>Tiêu đề</th>
          <th>Người gửi</th>
          <th>Người xử lý</th>
          <th>Ngày tạo</th>
          <th>Trạng thái</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ticket of filteredTickets; let i = index" 
            (click)="viewTicketDetail(ticket)" 
            class="clickable-row"
            [title]="getAccessTooltip(ticket)"
            [class.restricted-access]="!canProcessTicket(ticket) && (ticket.status === 'CLAIMED' || ticket.status === 'IN_PROGRESS')">
          <td>{{ i + 1 + (page * 10) }}</td>
          <td>
            <span class="ticket-title">{{ ticket.title }}</span>
          </td>
          <td>{{ ticket.userName }}</td>
          <td>
            <span *ngIf="ticket.status === 'OPEN'" class="no-claimed">Chưa có ai nhận</span>
            <span *ngIf="ticket.status === 'CLAIMED' || ticket.status === 'IN_PROGRESS'" class="claimed-unknown">Đã được nhận</span>
            <span *ngIf="ticket.status === 'CLOSED'" class="no-claimed">-</span>
          </td>
          <td>{{ formatDate(ticket.createdAt) }}</td>
          <td>
            <span class="status-badge status-inline" [ngClass]="getStatusClass(ticket.status)">
              {{ getStatusText(ticket.status) }}
            </span>
          </td>
          <td>
            <div class="action-buttons" (click)="$event.stopPropagation()">
              <!-- Nút Nhận phiếu hỗ trợ - chỉ hiện khi OPEN -->
              <button *ngIf="canClaimTicket(ticket)" 
                      class="claim-btn"
                      (click)="openClaimDialog(ticket); $event.stopPropagation()"
                      title="Nhận phiếu hỗ trợ để xử lý">
                <i class="fas fa-user-check"></i>
                Nhận xử lý
              </button>
              
              <!-- Nút Trả lại phiếu hỗ trợ - chỉ hiện khi admin hiện tại đã claim ticket -->
              <button *ngIf="canReleaseTicket(ticket)" 
                      class="release-btn"
                      (click)="openReleaseDialog(ticket); $event.stopPropagation()"
                      title="Trả lại phiếu hỗ trợ cho admin khác xử lý">
                <i class="fas fa-undo-alt"></i>
                Trả lại
              </button>
              
              <!-- Nút Mở lại phiếu hỗ trợ - DISABLED -->
              <!-- 
              <button *ngIf="canReopenTicket(ticket)" 
                      class="reopen-btn"
                      (click)="onReopenTicket(ticket); $event.stopPropagation()"
                      title="Mở lại phiếu hỗ trợ">
                <i class="fas fa-redo"></i>
                <span>Mở lại</span>
              </button>
              -->
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="pagination-bar" *ngIf="totalPages > 1">
      <button [disabled]="page === 0" (click)="onPageChange(page - 1)">&lt; Trước</button>
      <span>Trang {{ page + 1 }} / {{ totalPages }}</span>
      <button [disabled]="page + 1 >= totalPages" (click)="onPageChange(page + 1)">Sau &gt;</button>
    </div>
  </div>

  <div *ngIf="!isLoading && tickets.length === 0" class="empty-state">
    <p>Không có phiếu hỗ trợ nào.</p>
  </div>
</div>
