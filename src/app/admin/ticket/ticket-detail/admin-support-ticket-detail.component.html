

<div class="admin-support-ticket-detail-page">
  <div class="ticket-detail-card">
    <!-- Header -->
    <div class="ticket-detail-header">
      <!-- Row 1: STT, Title (without Status) -->
      <div class="ticket-header-row-1">
        <div class="ticket-id-section">
          <span class="ticket-id-label">STT:</span>
          <span class="ticket-id-value">#{{ ticket?.ticketId || ticketId || '--' }}</span>
        </div>
        
        <div class="ticket-title-section">
          <span class="ticket-title-main">{{ ticket?.title || 'Đang tải...' }}</span>
        </div>
      </div>
      
      <!-- Row 2: Person in charge, Created time -->
      <div class="ticket-header-row-2">
        <div class="ticket-person-section">
          <span class="info-label">Người phụ trách:</span>
          <span class="info-value">{{ ticket?.status === 'OPEN' ? '--' : (ticket?.userName || '--') }}</span>
        </div>
        
        <div class="ticket-time-section">
          <span class="info-label">Thời gian tạo:</span>
          <span class="info-value">{{ ticket?.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
        </div>
      </div>
      
      <!-- Action Buttons - Keep in current position -->
      <div class="ticket-header-actions" *ngIf="ticket && !loading && !error">
        <!-- Nút "Nhận" cho ticket chưa được claim -->
        <button 
          class="header-action-btn claim-btn"
          *ngIf="canClaimTicket()"
          (click)="onClaimTicket()"
          title="Nhận xử lý ticket">
          <i class="fas fa-hand-paper"></i>
          <span>Nhận</span>
        </button>

        <!-- Nút "Xử lý" cho ticket đã được claim -->
        <button 
          class="header-action-btn handle-btn"
          *ngIf="canHandleTicket()"
          (click)="onHandleTicket()"
          title="Bắt đầu xử lý ticket">
          <i class="fas fa-play"></i>
          <span>Xử lý</span>
        </button>
        
        <!-- Nút "Trả lại" cho ticket đã được claim -->
        <button 
          class="header-action-btn release-btn"
          *ngIf="canReleaseTicket()"
          (click)="onReleaseTicket()"
          title="Trả lại ticket">
          <i class="fas fa-undo"></i>
          <span>Trả lại</span>
        </button>
        
        <!-- Nút "Phản hồi" -->
        <button 
          class="header-action-btn response-btn"
          *ngIf="canRespondToTicket()"
          (click)="onResponseTicket()"
          title="Gửi phản hồi">
          <i class="fas fa-reply"></i>
          <span>Phản hồi</span>
        </button>
      </div>
    </div>

    <!-- Main Content: 2 columns (Description/Process/Responses) -->
    <div class="ticket-detail-main-grid">
      <div class="ticket-main-left">
        <div class="ticket-section ticket-description-section">
          <div class="section-label"><i class="fa fa-info-circle"></i> Mô tả</div>
          <blockquote class="ticket-description-block">
            {{ ticket?.description }}
          </blockquote>
          <ng-container *ngIf="ticket?.imageUrl">
            <img [src]="ticket?.imageUrl || ''" alt="Ảnh phiếu hỗ trợ" class="ticket-image" />
          </ng-container>
        </div>
      </div>
      <div class="ticket-main-right">
        <div class="ticket-section">
          <div class="section-label"><i class="fa fa-comments"></i> Phản hồi</div>
          <ng-container *ngIf="ticket?.responses?.length === 0">
            <div class="empty-responses">Chưa có phản hồi nào.</div>
          </ng-container>
          <ul *ngIf="(ticket?.responses?.length ?? 0) > 0">
            <li *ngFor="let res of ticket?.responses">
              <div class="response-row">
                <span class="response-user"><i class="fa fa-user"></i> {{ res.userName }}</span>
                <span class="response-date">{{ res.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                <span class="response-content">{{ res.content }}</span>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Log section below -->
    <div class="ticket-log-block">
      <div class="ticket-section">
        <div class="section-label"><i class="fa fa-history"></i> Nhật ký xử lý</div>
        <ng-container *ngIf="ticket?.logs?.length === 0">
          <div class="empty-logs">Chưa có nhật ký xử lý.</div>
        </ng-container>
        <table *ngIf="(ticket?.logs?.length ?? 0) > 0" class="ticket-log-table">
          <thead>
            <tr>
              <th>Hành động</th>
              <th>Người thực hiện</th>
              <th>Thời gian</th>
              <th>Ghi chú</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let log of sortedLogs">
              <td><b>{{ getActionLabel(log.action) }}</b></td>
              <td>{{ log.userName }}</td>
              <td>{{ log.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
              <td *ngIf="log.note">{{ log.note }}</td>
              <td *ngIf="!log.note">-</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Loading/Error -->
    <div *ngIf="loading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Đang tải chi tiết phiếu hỗ trợ...</p>
    </div>
    <div *ngIf="!loading && error" class="empty-container">
      <h2>{{ error }}</h2>
    </div>
  </div>
</div>
