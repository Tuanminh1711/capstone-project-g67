
  <div class="report-detail-container">
    <div class="page-header">
      <h1>Chi tiết báo cáo</h1>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Đang tải chi tiết báo cáo...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMsg" class="error-container">
      <div class="error-message">{{ errorMsg }}</div>
      <button (click)="loadReport()" class="btn-retry">Thử lại</button>
    </div>

    <!-- Success State -->
    <div *ngIf="successMsg" class="success-container">
      <div class="success-message">{{ successMsg }}</div>
    </div>

    <!-- Report Detail Content -->
    <div *ngIf="report && !loading" class="report-detail-content">
      <!-- Report Info Card -->
      <div class="info-card">
        <div class="card-header">
          <h2>Báo cáo #{{ report.reportId }}</h2>
          <div class="status-badge" [ngClass]="getStatusClass(report.status)">
            {{ getStatusText(report.status) }}
          </div>
        </div>
        
        <div class="card-body">
          <div class="info-grid">
            <div class="info-item">
              <label>Lý do báo cáo:</label>
              <span>{{ report.reason }}</span>
            </div>
            
            <div class="info-item">
              <label>Ngày tạo:</label>
              <span>{{ formatDate(report.createdAt) }}</span>
            </div>
            
            <div class="info-item" *ngIf="report.adminNotes">
              <label>Ghi chú admin:</label>
              <span>{{ report.adminNotes }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Plant Info Card -->
      <div class="info-card">
        <div class="card-header">
          <h3>Thông tin cây bị báo cáo</h3>
        </div>
        
        <div class="card-body">
          <div class="plant-info">
            <div class="plant-images" *ngIf="report.plantImageUrls && report.plantImageUrls.length > 0">
              <img *ngFor="let img of report.plantImageUrls" 
                   [src]="img" 
                   [alt]="report.plantName" 
                   class="plant-img"
                   (error)="onImageError($event)" />
            </div>
            
            <div class="plant-details">
              <div class="info-grid">
                <div class="info-item">
                  <label>ID Cây:</label>
                  <span>#{{ report.plantId }}</span>
                </div>
                
                <div class="info-item">
                  <label>Tên cây:</label>
                  <span>{{ report.plantName }}</span>
                </div>
                
                <div class="info-item">
                  <label>Tên khoa học:</label>
                  <span>{{ report.scientificName }}</span>
                </div>
                
                <div class="info-item">
                  <label>Trạng thái cây:</label>
                  <span class="plant-status">{{ report.plantStatus }}</span>
                </div>
                
                <div class="info-item">
                  <label>Danh mục:</label>
                  <span>{{ report.categoryName }}</span>
                </div>
              </div>
              
              <div class="info-item description-item">
                <label>Mô tả:</label>
                <p class="description-text">{{ report.plantDescription }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reporter Info Card -->
      <div class="info-card">
        <div class="card-header">
          <h3>Thông tin người báo cáo</h3>
        </div>
        
        <div class="card-body">
          <div class="info-grid">
            <div class="info-item">
              <label>ID:</label>
              <span>#{{ report.reporterId }}</span>
            </div>
            
            <div class="info-item">
              <label>Tên:</label>
              <span>{{ report.reporterName }}</span>
            </div>
            
            <div class="info-item">
              <label>Email:</label>
              <span>{{ report.reporterEmail }}</span>
            </div>
            
            <div class="info-item">
              <label>Số điện thoại:</label>
              <span>{{ report.reporterPhone }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Handling Info -->
      <div class="info-card" *ngIf="report.claimedById || report.handledById">
        <div class="card-header">
          <h3>Thông tin xử lý</h3>
        </div>
        
        <div class="card-body">
          <div class="info-grid">
            <div class="info-item" *ngIf="report.claimedById">
              <label>Người nhận:</label>
              <span>{{ report.claimedByName }} ({{ report.claimedByEmail }})</span>
            </div>
            
            <div class="info-item" *ngIf="report.claimedAt">
              <label>Thời gian nhận:</label>
              <span>{{ formatDate(report.claimedAt) }}</span>
            </div>
            
            <div class="info-item" *ngIf="report.handledById">
              <label>Người xử lý:</label>
              <span>{{ report.handledByName }} ({{ report.handledByEmail }})</span>
            </div>
            
            <div class="info-item" *ngIf="report.handledAt">
              <label>Thời gian xử lý:</label>
              <span>{{ formatDate(report.handledAt) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Logs -->
      <div class="info-card" *ngIf="report.reportLogs && report.reportLogs.length > 0">
        <div class="card-header">
          <h3>Lịch sử hoạt động</h3>
        </div>
        
        <div class="card-body">
          <div class="activity-log">
            <div class="log-item" *ngFor="let log of report.reportLogs">
              <div class="log-header">
                <span class="log-action">{{ log.action }}</span>
                <span class="log-time">{{ formatDate(log.createdAt) }}</span>
              </div>
              <div class="log-user">
                {{ log.userName }} ({{ log.userEmail }})
              </div>
              <div class="log-note" *ngIf="log.note">
                {{ log.note }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button (click)="goBack()" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Quay lại
        </button>
        
        <!-- Approve Edit Button - Show only if user can approve/edit this report -->
        <button *ngIf="canApproveEdit()" 
                (click)="goToApproveEdit()" 
                [disabled]="processing"
                class="btn btn-success"
                title="Chỉnh sửa thông tin cây và chấp nhận report">
          <i class="fas fa-edit"></i> 
          {{ processing ? 'Đang xử lý...' : 'Chỉnh sửa để chấp thuận' }}
        </button>
        
        <!-- Reject Button - Show only if user can handle the report AND it's already claimed -->
        <button *ngIf="canHandleReport() && report.status === 'CLAIMED'" 
                (click)="rejectReport()" 
                [disabled]="processing"
                class="btn btn-danger">
          <i class="fas fa-times"></i> 
          {{ processing ? 'Đang xử lý...' : 'Từ chối' }}
        </button>
        
        <!-- Info messages for permission restrictions and status -->
        <div *ngIf="report && (!canHandleReport() || !canApproveEdit())" 
             class="permission-info">
          <i class="fas fa-info-circle"></i>
          
          <!-- PENDING status -->
          <span *ngIf="report.status === 'PENDING'">
            Report đang chờ xử lý. Cần claim report trước khi có thể approve hoặc reject.
          </span>
          
          <!-- CLAIMED by other user -->
          <span *ngIf="report.status === 'CLAIMED' && isClaimedByOther()">
            Report này đã được nhận bởi {{ report.claimedByName }} (ID: {{ report.claimedById }}). 
            Chỉ người đã claim mới có thể xử lý hoặc chỉnh sửa để chấp thuận. (Your ID: {{ userId }})
          </span>
          
          <!-- HANDLED status - when both functions return false -->
          <span *ngIf="!canHandleReport() && !canApproveEdit() && report.status !== 'PENDING' && report.status !== 'CLAIMED'">
            Report này đã được xử lý hoàn tất (approved/rejected) và không thể chỉnh sửa hoặc xử lý thêm nữa.
          </span>
        </div>
      </div>
    </div>
  </div>
