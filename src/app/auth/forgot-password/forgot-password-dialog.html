<div class="dialog-panel-bg">
  <button class="dialog-close-x" (click)="close()">&times;</button>
  <div class="dialog-wrapper">
    <div class="auth-header">
      <img src="assets/image/logo.png" alt="logo" class="logo-img" />
      <span class="logo-text">PLANCARE</span>
    </div>
    <h2 class="auth-title">Quên mật khẩu?</h2>
    
    <!-- Bước nhập email -->
    <div *ngIf="step === 'email'">
      <p class="auth-desc">Nhập email để nhận mã xác nhận đặt lại mật khẩu.</p>
      
      <form [formGroup]="forgotPasswordForm" (ngSubmit)="onSubmit()" autocomplete="on">
        <input class="auth-input" type="email" formControlName="email" placeholder="Nhập email của bạn" required />
        <div class="auth-error" *ngIf="forgotPasswordForm.get('email')?.hasError('required') && forgotPasswordForm.get('email')?.touched">
          Vui lòng nhập email
        </div>
        <div class="auth-error" *ngIf="forgotPasswordForm.get('email')?.hasError('email') && forgotPasswordForm.get('email')?.touched">
          Email không hợp lệ
        </div>
  <div class="auth-success" *ngIf="successMessage">{{ successMessage }}</div>
  <!-- Ẩn message lỗi API, chỉ hiện toast, không hiện dưới input -->
        <button class="auth-btn main-btn" type="submit" [disabled]="forgotPasswordForm.invalid || isLoading">
          <span *ngIf="!isLoading">Gửi mã xác nhận</span>
          <span *ngIf="isLoading">Đang gửi...</span>
        </button>
      </form>
    </div>

    <!-- Bước nhập mã xác nhận -->
    <div *ngIf="step === 'code'">
      <p class="auth-desc">Nhập mã xác nhận đã gửi tới email <b>{{ emailSent }}</b></p>
      
      <div class="code-input-group">
        <div class="code-input-row">
          <input *ngFor="let input of codeInputs; let i = index"
            id="code-digit-{{i}}"
            class="code-digit-input"
            type="text"
            maxlength="1"
            pattern="[0-9]"
            inputmode="numeric"
            [value]="input.value"
            (keydown)="onDigitInput($event, i)"
            (paste)="onDigitPaste($event, i)"
            (input)="codeInputs[i].value = $any($event.target).value || ''"
            required />
        </div>
      </div>
      <div class="auth-error" *ngIf="errorMessage">{{ errorMessage }}</div>
      <button class="auth-btn main-btn" type="button" (click)="onVerifyCode()" [disabled]="codeInputLength !== 6 || isLoading">
        <span *ngIf="!isLoading">Xác nhận mã</span>
        <span *ngIf="isLoading">Đang xác nhận...</span>
      </button>
      <button type="button" class="auth-btn secondary-btn" (click)="goBack()" [disabled]="isLoading">
        Quay lại
      </button>
    </div>

    <!-- Bước nhập mật khẩu mới -->
    <div *ngIf="step === 'password'">
      <p class="auth-desc">Nhập mật khẩu mới cho tài khoản <b>{{ emailSent }}</b></p>
      
      <form [formGroup]="passwordForm" (ngSubmit)="onPasswordSubmit()" autocomplete="off">
        <input class="auth-input" type="password" formControlName="newPassword" placeholder="Mật khẩu mới" required />
        <div class="auth-error" *ngIf="passwordForm.get('newPassword')?.hasError('required') && passwordForm.get('newPassword')?.touched">
          Vui lòng nhập mật khẩu mới
        </div>
        <div class="auth-error" *ngIf="passwordForm.get('newPassword')?.hasError('minlength') && passwordForm.get('newPassword')?.touched">
          Mật khẩu phải có ít nhất 8 ký tự, 1 chữ hoa, 1 ký tự đặc biệt 
        </div>
        
        <input class="auth-input" type="password" formControlName="confirmPassword" placeholder="Xác nhận mật khẩu" required />
        <div class="auth-error" *ngIf="passwordForm.get('confirmPassword')?.hasError('required') && passwordForm.get('confirmPassword')?.touched">
          Vui lòng xác nhận mật khẩu
        </div>
        <div class="auth-error" *ngIf="passwordForm.hasError('passwordMismatch') && passwordForm.get('confirmPassword')?.touched">
          Mật khẩu xác nhận không khớp
        </div>
        
        <div class="auth-error" *ngIf="errorMessage">{{ errorMessage }}</div>
        
        <button class="auth-btn main-btn" type="submit" [disabled]="passwordForm.invalid || isLoading">
          <span *ngIf="!isLoading">Đặt lại mật khẩu</span>
          <span *ngIf="isLoading">Đang đặt lại...</span>
        </button>
      
      </form>
    </div>
    
    <div class="auth-link">
      <a (click)="goToLogin()">Quay lại đăng nhập</a>
    </div>
  </div>
</div>
